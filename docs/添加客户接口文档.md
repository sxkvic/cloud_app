# 添加客户流程API接口文档

## 目录

- [接口概述](#接口概述)
- [1. 创建客户接口](#1-创建客户接口)
  - [基本信息](#基本信息)
  - [请求头](#请求头)
  - [请求参数](#请求参数)
  - [请求示例](#请求示例)
  - [成功响应](#成功响应-200)
  - [错误响应](#错误响应)
- [2. 业务流程说明](#2-业务流程说明)
  - [2.1 认证流程](#21-认证流程)
  - [2.2 数据处理流程](#22-数据处理流程)
  - [2.3 数据库表结构](#23-数据库表结构)
  - [2.4 操作日志记录](#24-操作日志记录)
- [3. 调用示例](#3-调用示例)
  - [3.1 使用cURL](#31-使用curl)
  - [3.2 使用JavaScript (Fetch API)](#32-使用javascript-fetch-api)
  - [3.3 使用Axios](#33-使用axios)
- [4. 注意事项](#4-注意事项)
- [5. 相关接口](#5-相关接口)

---

## 接口概述

添加客户是一个需要管理员或用户认证的操作，通过POST请求创建新客户记录，并自动记录操作日志。

---

## 1. 创建客户接口

### 基本信息

- **接口路径**: `/api/v1/customers/createCustomer`
- **请求方法**: `POST`
- **认证要求**: 需要Bearer Token (支持管理员或普通用户)
- **Content-Type**: `application/json; charset=utf-8`

### 请求头

```http
Authorization: Bearer <token>
Content-Type: application/json
```

### 请求参数

| 参数名 | 类型 | 必填 | 长度限制 | 描述 |
|--------|------|------|----------|------|
| `customer_name` | string | **是** | 1-100字符 | 客户名称(唯一) |
| `user_type` | integer | 否 | - | 客户类型: 1=个人, 2=企业 |
| `id_number` | string | 否 | 最多50字符 | 证件号(身份证/营业执照号) |
| `contact_person` | string | 否 | - | 联系人姓名 |
| `contact_phone` | string | 否 | - | 联系电话 |
| `city` | string | 否 | - | 所在城市 |
| `install_address` | string | 否 | - | 安装地址 |
| `install_requirement` | string | 否 | - | 安装要求 |
| `status` | integer | 否 | - | 状态: 1=启用(默认), 0=禁用 |

### 请求示例

```json
{
  "customer_name": "北京科技有限公司",
  "user_type": 2,
  "id_number": "91110000MA01234567",
  "contact_person": "张三",
  "contact_phone": "13800138000",
  "city": "北京",
  "install_address": "北京市朝阳区建国路88号",
  "install_requirement": "需要在工作日安装，提前预约",
  "status": 1
}
```

### 成功响应 (200)

```json
{
  "success": true,
  "message": "客户创建成功",
  "data": {
    "customer": {
      "id": 123,
      "customer_name": "北京科技有限公司",
      "user_type": 2,
      "id_number": "91110000MA01234567",
      "contact_person": "张三",
      "contact_phone": "13800138000",
      "city": "北京",
      "install_address": "北京市朝阳区建国路88号",
      "install_requirement": "需要在工作日安装，提前预约",
      "status": 1,
      "created_at": "2024-12-02 13:45:30",
      "updated_at": "2024-12-02 13:45:30"
    }
  }
}
```

### 错误响应

#### 400 Bad Request - 参数验证失败

```json
{
  "success": false,
  "error": "customer_name是必填项",
  "details": "customer_name是必填项",
  "statusCode": 400
}
```

#### 400 Bad Request - 客户名称重复

```json
{
  "success": false,
  "error": "客户名称已存在",
  "details": "该客户名称已被使用，请使用不同的客户名称",
  "statusCode": 400
}
```

#### 401 Unauthorized - 未提供认证令牌

```json
{
  "success": false,
  "message": "未提供身份验证令牌"
}
```

#### 401 Unauthorized - 令牌无效

```json
{
  "success": false,
  "message": "身份验证失败",
  "error": "invalid token"
}
```

#### 500 Internal Server Error - 服务器错误

```json
{
  "success": false,
  "error": "创建客户失败",
  "details": "数据库操作失败",
  "statusCode": 500
}
```

---

## 2. 业务流程说明

### 2.1 认证流程

1. 客户端在请求头中携带JWT Token
2. 服务器通过`combinedAuthMiddleware`中间件验证Token
3. 支持管理员Token和普通用户Token两种认证方式
4. Token验证通过后，用户信息存储在`req.user`中

### 2.2 数据处理流程

```
1. 接收请求 → 2. 认证验证 → 3. 参数校验 → 4. 创建客户记录
    ↓
5. 获取客户信息 → 6. 记录操作日志 → 7. 格式化响应 → 8. 返回结果
```

**详细步骤:**

1. **接收请求**: 接收POST请求和JSON数据
2. **认证验证**: 验证Bearer Token有效性
3. **参数校验**: 
   - 验证`customer_name`必填且长度1-100字符
   - 其他字段可选
4. **创建客户记录**: 
   - 插入customers表
   - 自动设置`created_at`和`updated_at`时间戳
5. **获取客户信息**: 根据insertId查询完整客户信息
6. **记录操作日志**: 
   - 记录操作者ID和用户名
   - 记录操作类型为"增加客户"
   - 记录客户ID和名称
   - 记录IP地址
7. **格式化响应**: 将时间字段格式化为'yyyy-mm-dd hh:mm:ss'
8. **返回结果**: 返回标准JSON响应

### 2.3 数据库表结构

**customers表主要字段:**

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| customer_name | VARCHAR(100) | 客户名称，唯一索引 |
| user_type | TINYINT | 客户类型: 1个人, 2企业 |
| id_number | VARCHAR(50) | 证件号 |
| contact_person | VARCHAR | 联系人 |
| contact_phone | VARCHAR | 联系电话 |
| city | VARCHAR | 城市 |
| install_address | TEXT | 安装地址 |
| install_requirement | TEXT | 安装要求 |
| status | TINYINT | 状态: 1启用, 0禁用 |
| created_at | TIMESTAMP | 创建时间 |
| updated_at | TIMESTAMP | 更新时间 |

### 2.4 操作日志记录

每次成功创建客户后，系统会自动在`operation_logs`表中记录:

- **操作者ID**: 从Token中获取
- **操作者名称**: 从Token中获取
- **操作类型**: "增加客户"
- **操作内容**: "创建客户成功: 客户ID=123, 客户名称=xxx"
- **IP地址**: 从请求头或连接信息中获取
- **操作时间**: 当前时间戳

---

## 3. 调用示例

### 3.1 使用cURL

```bash
curl -X POST http://localhost:3000/api/v1/customers/createCustomer \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "customer_name": "测试客户",
    "user_type": 1,
    "id_number": "110101199001011234",
    "contact_person": "李四",
    "contact_phone": "13900139000",
    "city": "上海",
    "install_address": "上海市浦东新区世纪大道100号",
    "status": 1
  }'
```

### 3.2 使用JavaScript (Fetch API)

```javascript
const createCustomer = async () => {
  try {
    const response = await fetch('http://localhost:3000/api/v1/customers/createCustomer', {
      method: 'POST',
      headers: {
        'Authorization': 'Bearer ' + token,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        customer_name: '测试客户',
        user_type: 1,
        id_number: '110101199001011234',
        contact_person: '李四',
        contact_phone: '13900139000',
        city: '上海',
        install_address: '上海市浦东新区世纪大道100号',
        status: 1
      })
    });
    
    const result = await response.json();
    console.log(result);
  } catch (error) {
    console.error('创建客户失败:', error);
  }
};
```

### 3.3 使用Axios

```javascript
import axios from 'axios';

const createCustomer = async () => {
  try {
    const response = await axios.post(
      'http://localhost:3000/api/v1/customers/createCustomer',
      {
        customer_name: '测试客户',
        user_type: 1,
        id_number: '110101199001011234',
        contact_person: '李四',
        contact_phone: '13900139000',
        city: '上海',
        install_address: '上海市浦东新区世纪大道100号',
        status: 1
      },
      {
        headers: {
          'Authorization': `Bearer ${token}`,
          'Content-Type': 'application/json'
        }
      }
    );
    
    console.log(response.data);
  } catch (error) {
    console.error('创建客户失败:', error.response?.data || error.message);
  }
};
```

---

## 4. 注意事项

1. **客户名称唯一性**: `customer_name`字段有唯一索引，重复提交会返回400错误
2. **UTF-8编码**: 所有请求和响应都使用UTF-8编码，支持中文字符
3. **Token有效期**: JWT Token有过期时间，过期后需要重新获取
4. **字段可选性**: 除`customer_name`外，其他字段都是可选的
5. **状态默认值**: 如果不传`status`，默认为1(启用状态)
6. **时间格式**: 响应中的时间字段统一格式化为'yyyy-mm-dd hh:mm:ss'
7. **操作日志**: 每次创建操作都会自动记录到操作日志表
8. **客户类型**: `user_type`字段用于区分个人客户(1)和企业客户(2)
9. **证件号**: `id_number`字段可以存储身份证号或营业执照号，根据客户类型而定

---

## 5. 相关接口

创建客户后，您可能还需要使用以下相关接口:

### 5.1 获取客户列表

- **路径**: `GET /api/v1/customers/getCustomerLists`
- **描述**: 获取客户列表，支持分页和搜索
- **查询参数**:
  - `page`: 页码(可选，默认1)
  - `pageSize`: 每页数量(可选，默认10)
  - `keyword`: 搜索关键词(可选，按客户名称搜索)

### 5.2 获取客户详情

- **路径**: `GET /api/v1/customers/getCustomerDetail/:id`
- **描述**: 获取指定客户的详细信息
- **路径参数**:
  - `id`: 客户ID

### 5.3 更新客户信息

- **路径**: `PUT /api/v1/customers/updateCustomer/:id`
- **描述**: 更新指定客户的信息
- **路径参数**:
  - `id`: 客户ID
- **请求体**: 与创建客户相同的字段(所有字段可选)

### 5.4 删除客户

- **路径**: `DELETE /api/v1/customers/deleteCustomer/:id`
- **描述**: 删除指定客户
- **路径参数**:
  - `id`: 客户ID
- **注意**: 如果客户已绑定设备，需要先解除绑定才能删除

---

## 附录

### A. 完整的响应状态码说明

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误或业务逻辑错误 |
| 401 | 未授权，Token无效或未提供 |
| 403 | 禁止访问，权限不足 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### B. 客户类型枚举

| 值 | 说明 |
|----|------|
| 1 | 个人客户 |
| 2 | 企业客户 |

### C. 客户状态枚举

| 值 | 说明 |
|----|------|
| 0 | 禁用 |
| 1 | 启用 |

---

**文档版本**: v1.0  
**最后更新**: 2024-12-02  
**维护者**: 后端开发团队
