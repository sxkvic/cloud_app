# 设备缓存逻辑漏洞修复说明

## 问题描述

**逻辑漏洞**：再次进入小程序时，获取的是缓存内的设备码，但实际 `getUserDevices` 接口返回的数据是空的（设备已解绑），导致用户看到的是过期的设备信息。

### 问题原因

1. **应用启动时**：`app.js` 的 `restoreLocalData()` 从本地缓存恢复 `device_no` 到 `globalData`
2. **页面使用缓存**：各页面（home、my等）直接使用缓存的 `device_no`，没有验证其有效性
3. **数据不同步**：当设备在后台被解绑后，本地缓存仍然保留旧数据，造成数据不一致

### 影响范围

- 用户可能看到已解绑设备的信息
- 使用已解绑设备码调用接口会失败
- 用户体验差，需要手动清除缓存或重新登录

## 修复方案

### 1. Home 页面 (`pages/home/home.js`)

**修改内容**：
- 在 `onShow` 生命周期中添加设备绑定状态验证
- 新增 `validateDeviceBinding()` 方法

**验证逻辑**：
```javascript
async validateDeviceBinding() {
  // 1. 检查用户是否已登录
  // 2. 调用 getUserDevices 获取最新设备列表
  // 3. 对比缓存设备码与服务器设备码
  // 4. 处理三种情况：
  //    - 设备列表为空：清除缓存，提示重新绑定
  //    - 设备码不一致：更新缓存为最新数据
  //    - 设备码一致：验证通过
}
```

**关键代码**：
```javascript
async onShow() {
  console.log('首页显示');
  await this.validateDeviceBinding();
}
```

### 2. My 页面 (`pages/my/my.js`)

**修改内容**：
- 在 `onShow` 生命周期中添加设备绑定状态验证
- 新增 `validateDeviceBinding()` 方法（逻辑同 home 页面）
- 修复 `rebindDevice()` 方法使用正确的缓存字段 `device_no`

**修复前**：
```javascript
const currentDeviceCode = wx.getStorageSync('deviceCode'); // 错误的字段
```

**修复后**：
```javascript
const currentDeviceNo = wx.getStorageSync('device_no'); // 正确的字段
```

### 3. Login 页面 (`pages/login/login.js`)

**修改内容**：
- 优化 `checkDeviceBindingAndNavigate()` 方法
- 在设备列表为空时，主动清除所有设备相关缓存
- 添加更详细的日志输出

**关键改进**：
```javascript
if (devices.length === 0) {
  console.log('⚠️ 用户未绑定设备，清除可能存在的旧缓存');
  
  // 清除所有设备相关缓存
  wx.removeStorageSync('deviceBound');
  wx.removeStorageSync('device_no');
  wx.removeStorageSync('device_info');
  wx.removeStorageSync('customer_info');
  wx.removeStorageSync('binding_info');
  
  // 清除全局数据
  app.globalData.deviceBound = false;
  app.globalData.device_no = null;
  // ...
}
```

### 4. Bind Device Code 页面 (`pages/bind-device-code/bind-device-code.js`)

**修改内容**：
- 修复重新绑定时使用正确的缓存字段

**修复前**：
```javascript
const currentDeviceCode = wx.getStorageSync('deviceCode');
```

**修复后**：
```javascript
const currentDeviceNo = wx.getStorageSync('device_no');
```

## 修复效果

### 修复前
1. ❌ 设备解绑后，缓存仍保留旧数据
2. ❌ 页面显示过期的设备信息
3. ❌ 接口调用失败，用户体验差

### 修复后
1. ✅ 每次进入 home/my 页面自动验证设备绑定状态
2. ✅ 检测到设备已解绑时，自动清除缓存并提示用户
3. ✅ 检测到设备码不一致时，自动更新为最新数据
4. ✅ 登录时主动清除过期缓存
5. ✅ 数据始终与服务器保持一致

## 验证方法

### 测试场景 1：设备已解绑
1. 在后台解绑用户设备
2. 用户再次进入小程序
3. **预期结果**：自动检测到设备已解绑，清除缓存，提示重新绑定

### 测试场景 2：设备码变更
1. 在后台更换用户绑定的设备
2. 用户再次进入小程序
3. **预期结果**：自动检测到设备码不一致，更新为最新设备信息

### 测试场景 3：正常使用
1. 设备绑定状态正常
2. 用户进入小程序
3. **预期结果**：验证通过，正常显示设备信息

## 注意事项

1. **性能优化**：验证逻辑在 `onShow` 中执行，仅在用户已登录时调用接口
2. **错误处理**：验证失败不影响页面正常显示，只记录错误日志
3. **用户体验**：设备解绑时会弹窗提示用户，避免困惑
4. **数据一致性**：同时更新缓存和 globalData，确保数据同步

## 相关文件

- `pages/home/home.js` - 首页验证逻辑
- `pages/my/my.js` - 个人中心验证逻辑
- `pages/login/login.js` - 登录时缓存清理
- `pages/bind-device-code/bind-device-code.js` - 绑定页面字段修复
- `app.js` - 应用启动时的缓存恢复（已有旧缓存清理逻辑）

## 后续优化建议

1. **统一验证方法**：将 `validateDeviceBinding` 提取到 `utils` 中，避免代码重复
2. **缓存过期机制**：添加缓存时间戳，超过一定时间自动失效
3. **离线支持**：在网络异常时，允许使用缓存数据，但显示提示信息
4. **监听机制**：考虑使用事件监听，当设备状态变化时主动通知各页面更新

---

**修复日期**：2025-12-01  
**修复人员**：Cascade AI  
**版本**：v1.1.0
