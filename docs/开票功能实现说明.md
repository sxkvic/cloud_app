# 开票功能实现说明

## 功能概述

已完成开票页面的重构和API对接，采用现代化设计风格，与项目其他页面保持一致。

## 实现内容

### 1. API接口对接

**已对接的接口**：

#### 3.1 创建/更新开票信息
- **接口**: `POST /api/v1/invoices/invoice-info/createOrUpdateInvoiceInfo`
- **用途**: 保存用户的开票信息
- **参数**:
  ```javascript
  {
    title_type: '2',  // 1=企业, 2=个人
    invoice_title: '发票抬头',
    invoice_type: 1,  // 1=普通发票, 2=专用发票
    customer_name: '客户名称',
    customer_id: 客户ID,
    device_no: '设备号',
    receive_email: '接收邮箱',
    social_credit_code: '统一社会信用代码',  // 企业必填
    bank_name: '开户银行',  // 企业选填
    bank_account: '银行账号'  // 企业选填
  }
  ```

#### 3.2 获取开票信息
- **接口**: `GET /api/v1/invoices/invoice-info/device/:device_no`
- **用途**: 根据设备号查询已保存的开票信息
- **自动填充**: 页面加载时自动填充表单

#### 3.3 获取发票列表
- **接口**: `GET /api/v1/invoices/getInvoiceList`
- **用途**: 查询历史发票记录
- **参数**:
  ```javascript
  {
    page: 1,
    limit: 10,
    device_no: '设备号'
  }
  ```

### 2. 页面设计

#### 2.1 设计风格
- ✅ 原生导航栏（蓝色主题 #2B7FF0）
- ✅ 顶部蓝色渐变装饰背景
- ✅ 玻璃态客户信息卡片
- ✅ 卡片式表单布局
- ✅ 底部固定按钮
- ✅ 骨架屏加载效果
- ✅ 下拉刷新支持

#### 2.2 页面结构

```
┌─────────────────────────────┐
│   导航栏（蓝色）              │
├─────────────────────────────┤
│   蓝色装饰背景                │
│   ┌───────────────────────┐ │
│   │ 客户信息卡片（玻璃态）  │ │
│   └───────────────────────┘ │
│   ┌───────────────────────┐ │
│   │ 开票信息表单           │ │
│   │  - 抬头类型            │ │
│   │  - 发票抬头            │ │
│   │  - 发票类型            │ │
│   │  - 社会信用代码        │ │
│   │  - 接收邮箱            │ │
│   │  - 银行信息（企业）    │ │
│   └───────────────────────┘ │
│   ┌───────────────────────┐ │
│   │ 开票须知               │ │
│   └───────────────────────┘ │
│   ┌───────────────────────┐ │
│   │ 历史记录               │ │
│   └───────────────────────┘ │
├─────────────────────────────┤
│   保存开票信息（按钮）        │
└─────────────────────────────┘
```

### 3. 核心功能

#### 3.1 开票信息管理
- **个人发票**: 姓名 + 邮箱
- **企业发票**: 企业名称 + 社会信用代码 + 邮箱 + 银行信息（选填）
- **自动保存**: 提交后保存到数据库
- **自动填充**: 下次打开自动填充已保存的信息

#### 3.2 表单验证
- ✅ 发票抬头必填
- ✅ 邮箱格式验证
- ✅ 企业发票必须填写社会信用代码
- ✅ 社会信用代码格式验证（18位）
- ✅ 实时验证，动态启用/禁用提交按钮

#### 3.3 历史记录
- ✅ 显示已开发票列表
- ✅ 显示发票状态（开票中/已开票）
- ✅ 点击查看发票详情
- ✅ 已开票可下载PDF文件

### 4. 数据流程

```
页面加载
  ↓
获取设备号
  ↓
并行加载：
  - 客户信息
  - 开票信息（自动填充表单）
  - 发票历史记录
  ↓
用户填写/修改表单
  ↓
实时验证
  ↓
提交保存
  ↓
显示成功提示
  ↓
刷新历史记录
```

### 5. 用户体验优化

#### 5.1 加载优化
- 骨架屏显示，避免白屏
- 并行加载数据，提升速度
- 使用 `withMinLoading` 确保最小加载时长

#### 5.2 交互优化
- 下拉刷新数据
- 表单自动填充
- 实时验证反馈
- 点击历史记录查看详情

#### 5.3 视觉优化
- 蓝色主题统一
- 玻璃态效果
- 流畅的动画过渡
- 清晰的状态标识

### 6. 文件清单

| 文件 | 说明 |
|------|------|
| `pages/invoice/invoice.json` | 页面配置（蓝色导航栏） |
| `pages/invoice/invoice.js` | 页面逻辑 |
| `pages/invoice/invoice.wxml` | 页面结构 |
| `pages/invoice/invoice.wxss` | 页面样式 |
| `utils/api.js` | API接口定义 |

### 7. API方法

在 `utils/api.js` 中已定义：

```javascript
// 获取发票列表
API.getInvoiceList(params)

// 创建或更新开票信息
API.createOrUpdateInvoiceInfo(invoiceInfo)

// 根据设备号获取开票信息
API.getInvoiceInfoByDevice(deviceNo)
```

### 8. 使用说明

#### 8.1 首次使用
1. 进入开票页面
2. 选择抬头类型（个人/企业）
3. 填写发票抬头
4. 选择发票类型
5. 填写接收邮箱
6. 企业用户填写社会信用代码
7. 点击"保存开票信息"

#### 8.2 再次使用
1. 进入开票页面
2. 系统自动填充上次保存的信息
3. 可修改后重新保存
4. 查看历史发票记录

#### 8.3 查看发票
1. 在历史记录中点击发票项
2. 如果已开票，自动下载并打开PDF
3. 如果开票中，提示稍后查看

### 9. 注意事项

#### 9.1 开票流程
1. **保存开票信息**: 用户在此页面保存开票信息
2. **订单完成**: 用户完成订单支付
3. **自动开票**: 后端根据订单和开票信息自动开具发票
4. **邮件发送**: 发票PDF自动发送到用户邮箱
5. **历史记录**: 用户可在此页面查看已开发票

#### 9.2 数据关联
- 开票信息通过 `device_no` 和 `customer_id` 关联
- 发票记录通过 `order_no` 关联订单
- 一个客户可以有多个订单，每个订单对应一张发票

#### 9.3 权限说明
- 所有接口需要认证（`needAuth: true`）
- 用户只能查看自己设备的发票记录

### 10. 后续优化建议

#### 10.1 功能增强
- [ ] 支持多个开票抬头保存
- [ ] 发票申请进度跟踪
- [ ] 发票重新发送到邮箱
- [ ] 发票预览功能

#### 10.2 体验优化
- [ ] 添加发票样例图片
- [ ] 提供开票帮助文档
- [ ] 支持发票分享
- [ ] 添加发票统计

### 11. 测试要点

#### 11.1 功能测试
- [x] 个人发票保存
- [x] 企业发票保存
- [x] 表单验证
- [x] 自动填充
- [x] 历史记录加载
- [x] 发票查看

#### 11.2 兼容性测试
- [x] iOS系统
- [x] Android系统
- [x] 不同屏幕尺寸
- [x] 网络异常处理

#### 11.3 性能测试
- [x] 页面加载速度
- [x] 数据刷新速度
- [x] 骨架屏效果

## 更新日志

- **2025-11-28**: 完成开票页面重构
  - 对接开票信息API
  - 采用现代化设计风格
  - 添加发票历史记录
  - 优化用户体验

---

**文档版本**: v1.0  
**最后更新**: 2025-11-28  
**维护者**: 开发团队
