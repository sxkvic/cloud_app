# 接口对接流程图

## 1. 用户登录流程

```
┌─────────────┐
│  用户打开   │
│  小程序     │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  splash页面 │
│  (启动页)   │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│  login页面  │
│  (登录页)   │
└──────┬──────┘
       │
       │ 用户点击"微信登录"
       ▼
┌─────────────────────────────┐
│  wx.login() 获取 code       │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────┐
│  POST /api/getOpenidByCode  │
│  参数: { code }             │
│  返回: { openid }           │
└──────┬──────────────────────┘
       │
       ▼
┌─────────────────────────────────┐
│  POST /api/generateTokenByOpenid│
│  参数: { openid }               │
│  返回: { token }                │
└──────┬──────────────────────────┘
       │
       ├─── 成功 ───┐
       │            │
       │            ▼
       │     ┌─────────────────────┐
       │     │  GET /api/getUserInfo│
       │     │  返回: 用户信息      │
       │     └──────┬──────────────┘
       │            │
       │            ▼
       │     ┌─────────────┐
       │     │  跳转到首页  │
       │     └─────────────┘
       │
       └─── 失败(用户不存在) ───┐
                                │
                                ▼
                         ┌──────────────────┐
                         │  POST /api/createUser│
                         │  参数: { openid, nickname }│
                         │  返回: { token, userInfo }│
                         └──────┬───────────┘
                                │
                                ▼
                         ┌──────────────┐
                         │  跳转到设备  │
                         │  绑定页面    │
                         └──────────────┘
```

---

## 2. 设备绑定流程

```
┌─────────────────┐
│  bind-device-code│
│  (设备绑定页)    │
└────────┬─────────┘
         │
         │ 用户输入16位设备码
         ▼
┌──────────────────────────────────┐
│  GET /api/getCustomerByDeviceCode/:device_code│
│  验证设备码是否有效               │
└────────┬─────────────────────────┘
         │
         ├─── 有效 ───┐
         │            │
         │            ▼
         │     ┌──────────────────┐
         │     │  POST /api/bindDevice│
         │     │  参数: { deviceCode }│
         │     └──────┬───────────┘
         │            │
         │            ▼
         │     ┌─────────────┐
         │     │  绑定成功    │
         │     │  跳转到首页  │
         │     └─────────────┘
         │
         └─── 无效 ───┐
                      │
                      ▼
               ┌─────────────┐
               │  提示错误    │
               │  重新输入    │
               └─────────────┘
```

---

## 3. 套餐订购流程

```
┌─────────────────┐
│  package-order  │
│  (套餐订购页)    │
└────────┬─────────┘
         │
         │ 页面加载
         ▼
┌──────────────────────────────┐
│  GET /api/packages/getPackagesList│
│  参数: { status: 'active' }   │
│  返回: 套餐列表               │
└────────┬─────────────────────┘
         │
         ▼
┌─────────────┐
│  展示套餐    │
│  供用户选择  │
└────────┬────┘
         │
         │ 用户选择套餐并确认
         ▼
┌──────────────────────────────┐
│  POST /api/orders            │
│  参数: {                     │
│    packageId,                │
│    packageName,              │
│    amount                    │
│  }                           │
│  返回: { orderId, status }   │
└────────┬─────────────────────┘
         │
         ▼
┌─────────────┐
│  订购成功    │
│  显示订单号  │
└─────────────┘
```

---

## 4. 预充值支付流程

```
┌─────────────────┐
│  pre-recharge   │
│  (预充值页)      │
└────────┬─────────┘
         │
         │ 用户选择充值金额
         ▼
┌──────────────────────────────┐
│  POST /api/miniprogram/pay   │
│  参数: {                     │
│    amount,                   │
│    description,              │
│    openid                    │
│  }                           │
│  返回: {                     │
│    order_no,                 │
│    jsapi_params              │
│  }                           │
└────────┬─────────────────────┘
         │
         ▼
┌──────────────────────────────┐
│  wx.requestPayment()         │
│  调用微信支付                 │
└────────┬─────────────────────┘
         │
         ├─── 用户支付中 ───┐
         │                  │
         │                  ▼
         │           ┌──────────────────────────┐
         │           │  轮询查询支付状态         │
         │           │  GET /api/payments/status/enhanced│
         │           │  参数: { order_no }      │
         │           └──────┬───────────────────┘
         │                  │
         │                  ├─── 支付成功 ───┐
         │                  │                │
         │                  │                ▼
         │                  │         ┌─────────────┐
         │                  │         │  充值成功    │
         │                  │         │  更新余额    │
         │                  │         └─────────────┘
         │                  │
         │                  └─── 支付失败 ───┐
         │                                   │
         │                                   ▼
         │                            ┌─────────────┐
         │                            │  提示失败    │
         │                            └─────────────┘
         │
         └─── 用户取消 ───┐
                          │
                          ▼
                   ┌──────────────────┐
                   │  POST /api/payments/cancel│
                   │  取消支付订单     │
                   └──────────────────┘
```

---

## 5. 账单查询流程

```
┌─────────────────┐
│  my-bill        │
│  (我的账单页)    │
└────────┬─────────┘
         │
         │ 页面加载
         ▼
┌──────────────────────────────────┐
│  GET /api/customerBill/getCustomerBillList│
│  参数: {                          │
│    page: 1,                       │
│    pageSize: 20,                  │
│    status: ''                     │
│  }                                │
│  返回: 账单列表                    │
└────────┬─────────────────────────┘
         │
         ▼
┌─────────────┐
│  展示账单    │
│  列表        │
└────────┬────┘
         │
         │ 用户点击查看详情
         ▼
┌──────────────────────────────────┐
│  GET /api/customerBill/getCustomerBillDetail/:id│
│  返回: 账单详细信息                │
└────────┬─────────────────────────┘
         │
         ▼
┌─────────────┐
│  显示账单    │
│  详情        │
└─────────────┘
```

---

## 6. 开票申请流程

```
┌─────────────────┐
│  invoice        │
│  (开票页)        │
└────────┬─────────┘
         │
         │ 页面加载
         ▼
┌──────────────────────────────────┐
│  GET /api/v1/invoices/getInvoiceList│
│  参数: {                          │
│    page: 1,                       │
│    limit: 10,                     │
│    invoice_status: 1 (未开票)     │
│  }                                │
│  返回: 可开票订单列表              │
└────────┬─────────────────────────┘
         │
         ▼
┌─────────────────────────────────┐
│  展示可开票订单                  │
└────────┬────────────────────────┘
         │
         │ 用户选择订单并填写开票信息
         ▼
┌──────────────────────────────────────────┐
│  POST /api/v1/invoices/invoice-info/createOrUpdateInvoiceInfo│
│  参数: {                                  │
│    customer_name,                         │
│    invoice_title,                         │
│    invoice_type,                          │
│    taxpayer_id,                           │
│    address,                               │
│    phone,                                 │
│    bank_name,                             │
│    bank_account                           │
│  }                                        │
│  返回: 开票信息ID                          │
└────────┬─────────────────────────────────┘
         │
         ▼
┌──────────────────────────────────┐
│  POST /api/v1/invoices/create/:id│
│  参数: {                          │
│    invoice_title,                 │
│    taxpayer_id,                   │
│    ...                            │
│  }                                │
│  返回: 发票创建成功                │
└────────┬─────────────────────────┘
         │
         ▼
┌─────────────┐
│  开票成功    │
│  显示结果    │
└─────────────┘
```

---

## 7. 完整业务流程图

```
用户首次使用
    │
    ▼
┌─────────┐
│ 微信登录 │ ──► POST /api/getOpenidByCode
└────┬────┘     POST /api/generateTokenByOpenid 或 POST /api/createUser
     │
     ▼
┌─────────┐
│ 设备绑定 │ ──► GET /api/getCustomerByDeviceCode/:device_code
└────┬────┘     POST /api/bindDevice
     │
     ▼
┌─────────┐
│ 首页展示 │ ──► GET /api/v1/tools/getBannersList
└────┬────┘     GET /api/v1/tools/getArticlesList
     │
     ├──► 套餐订购 ──► GET /api/packages/getPackagesList
     │                POST /api/orders
     │
     ├──► 预充值 ──► POST /api/miniprogram/pay
     │              GET /api/payments/status/enhanced
     │
     ├──► 查看账单 ──► GET /api/customerBill/getCustomerBillList
     │                GET /api/customerBill/getCustomerBillDetail/:id
     │
     ├──► 开票申请 ──► GET /api/v1/invoices/getInvoiceList
     │                POST /api/v1/invoices/invoice-info/createOrUpdateInvoiceInfo
     │                POST /api/v1/invoices/create/:id
     │
     └──► 查看订单 ──► GET /api/orders
                      GET /api/orders/:id
```

---

## 8. 数据流向图

```
┌──────────────┐
│  微信小程序   │
└──────┬───────┘
       │
       │ HTTP Request (带Token)
       ▼
┌──────────────┐
│  API网关     │
└──────┬───────┘
       │
       │ 验证Token
       ▼
┌──────────────┐
│  后端服务器   │
└──────┬───────┘
       │
       │ 数据库查询
       ▼
┌──────────────┐
│  MySQL数据库 │
└──────┬───────┘
       │
       │ 返回数据
       ▼
┌──────────────┐
│  后端服务器   │
└──────┬───────┘
       │
       │ JSON Response
       ▼
┌──────────────┐
│  微信小程序   │
│  (渲染数据)   │
└──────────────┘
```

---

## 9. 错误处理流程

```
API请求
    │
    ▼
┌─────────────┐
│  发送请求    │
└─────┬───────┘
      │
      ├──► 网络错误 ──► 显示"网络连接失败"
      │
      ├──► HTTP 401 ──► Token过期 ──► 跳转登录页
      │
      ├──► HTTP 403 ──► 权限不足 ──► 显示错误提示
      │
      ├──► HTTP 404 ──► 资源不存在 ──► 显示错误提示
      │
      ├──► HTTP 500 ──► 服务器错误 ──► 显示错误提示
      │
      └──► HTTP 200 ──┐
                      │
                      ├──► success: true ──► 处理数据
                      │
                      └──► success: false ──► 显示业务错误信息
```

---

## 总结

以上流程图展示了：
1. **用户登录流程** - 从微信授权到获取Token
2. **设备绑定流程** - 验证和绑定设备
3. **套餐订购流程** - 查看套餐到创建订单
4. **支付流程** - 创建支付到查询状态
5. **账单查询流程** - 列表和详情查看
6. **开票流程** - 从查询可开票订单到创建发票
7. **完整业务流程** - 整体业务串联
8. **数据流向** - 请求和响应的流转
9. **错误处理** - 各种异常情况的处理

这些流程图可以帮助你更好地理解接口对接的整体架构和数据流向。


