# 微信支付功能使用说明

本文档详细介绍了项目中实现的微信支付功能，包括配置说明、API接口和使用方法。

## 支付功能概述

本项目实现了两种微信支付方式：
1. **扫码支付（Native支付）**：网页端生成二维码，用户通过微信扫码完成支付
2. **小程序支付（JSAPI支付）**：在微信小程序内直接唤起微信支付

## 配置说明

### 1. 微信支付配置

项目使用微信支付v3接口，需要在系统中配置以下参数：

- `WECHAT_APPID`：微信公众号/小程序AppID
- `WECHAT_MCH_ID`：微信支付商户号
- `WECHAT_API_KEY`：微信支付API密钥
- `WECHAT_NOTIFY_URL`：支付结果通知回调URL
- `WECHAT_CERT_PATH`：商户证书路径（v3接口需要）
- `WECHAT_CERT_KEY_PATH`：商户证书密钥路径（v3接口需要）

### 2. 数据库配置

系统自动创建了`payment_logs`表用于记录支付日志。如需重新创建，可运行：

```bash
node utils/createPaymentLogsTable.js
```

## API接口说明

### 1. 网页端扫码支付

#### 创建支付订单（生成二维码）
- **URL**: `/api/payments/web/create`
- **方法**: `POST`
- **权限**: 需要用户认证
- **请求参数**:
  - `amount`: 支付金额（必填）
  - `description`: 商品描述（必填）
  - `payment_type`: 支付类型，默认1（微信支付）
- **响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "order_no": "WEB1234567890123",
    "qr_code_url": "weixin://wxpay/bizpayurl?pr=123456",
    "expire_time": 1704067200000
  }
}
```

#### 管理员创建支付订单
- **URL**: `/api/admin/payments/web/create`
- **方法**: `POST`
- **权限**: 需要管理员权限
- **参数**: 同用户接口

### 2. 小程序支付

#### 创建小程序支付订单
- **URL**: `/api/miniprogram/pay`
- **方法**: `POST`
- **权限**: 需要用户认证
- **请求参数**:
  - `amount`: 支付金额（必填）
  - `description`: 商品描述（必填）
  - `openid`: 用户微信openid（必填）
- **响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "order_no": "MINI1234567890123",
    "jsapi_params": {
      "timeStamp": "1234567890",
      "nonceStr": "abcdefg",
      "package": "prepay_id=wx1234567890",
      "signType": "MD5",
      "paySign": "123456abc"
    }
  }
}
```

#### 管理员创建小程序支付订单
- **URL**: `/api/admin/miniprogram/pay`
- **方法**: `POST`
- **权限**: 需要管理员权限
- **参数**: 同用户接口

### 3. 支付状态查询

#### 查询支付状态
- **URL**: `/api/payments/status`
- **方法**: `GET`
- **权限**: 需要用户认证
- **查询参数**:
  - `order_no`: 订单编号（与order_id二选一）
  - `order_id`: 订单ID（与order_no二选一）
- **响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "order_no": "WEB1234567890123",
    "payment_status": 2,
    "payment_status_text": "已支付",
    "payment_type": 1,
    "payment_time": "2024-01-01 12:00:00"
  }
}
```

#### 查询支付状态（增强版）
- **URL**: `/api/payments/status/enhanced`
- **方法**: `GET`
- **权限**: 需要用户认证
- **功能**: 支持实时查询微信支付状态
- **参数**: 同普通查询接口

#### 管理员查询支付状态
- **URL**: `/api/admin/payments/status`
- **方法**: `GET`
- **权限**: 需要管理员权限
- **功能**: 使用增强版查询，支持实时状态查询

### 4. 支付回调

#### 微信支付回调
- **URL**: `/api/payments/wechat-notify`
- **方法**: `POST`
- **说明**: 微信支付服务器回调接口，无需前端调用

#### 支付宝支付回调
- **URL**: `/api/payments/alipay-notify`
- **方法**: `POST`
- **说明**: 支付宝支付服务器回调接口，无需前端调用

### 5. 支付取消

#### 取消支付
- **URL**: `/api/payments/cancel`
- **方法**: `POST`
- **权限**: 需要用户认证
- **请求参数**:
  - `order_no`: 订单编号（与order_id二选一）
  - `order_id`: 订单ID（与order_no二选一）

## 前端集成指南

### 1. 网页端扫码支付集成

```javascript
// 1. 创建支付订单获取二维码
async function createWebPayment(amount, description) {
  const response = await fetch('/api/payments/web/create', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + token
    },
    body: JSON.stringify({ amount, description })
  });
  
  const result = await response.json();
  if (result.code === 200) {
    // 2. 显示二维码
    displayQRCode(result.data.qr_code_url);
    
    // 3. 轮询查询支付状态
    startPollingPaymentStatus(result.data.order_no);
  }
}

// 轮询查询支付状态
function startPollingPaymentStatus(orderNo) {
  const interval = setInterval(async () => {
    const response = await fetch(`/api/payments/status/enhanced?order_no=${orderNo}`, {
      headers: {
        'Authorization': 'Bearer ' + token
      }
    });
    
    const result = await response.json();
    if (result.data.payment_status === 2) {
      clearInterval(interval);
      alert('支付成功！');
    } else if (result.data.payment_status === 3) {
      clearInterval(interval);
      alert('支付失败！');
    }
  }, 3000); // 每3秒查询一次
}
```

### 2. 小程序支付集成

```javascript
// 小程序端调用示例
wx.login({
  success: async (res) => {
    if (res.code) {
      // 获取openid
      const openid = await getOpenid(res.code);
      
      // 创建支付订单
      wx.request({
        url: 'https://your-api.com/api/miniprogram/pay',
        method: 'POST',
        data: {
          amount: 0.01,
          description: '测试商品',
          openid: openid
        },
        success: (response) => {
          if (response.data.code === 200) {
            // 调用微信支付
            wx.requestPayment({
              timeStamp: response.data.data.jsapi_params.timeStamp,
              nonceStr: response.data.data.jsapi_params.nonceStr,
              package: response.data.data.jsapi_params.package,
              signType: 'MD5',
              paySign: response.data.data.jsapi_params.paySign,
              success: () => {
                wx.showToast({ title: '支付成功' });
              },
              fail: () => {
                wx.showToast({ title: '支付失败', icon: 'none' });
              }
            });
          }
        }
      });
    }
  }
});
```

## 测试方法

项目提供了测试脚本，可以验证支付功能是否正常工作：

```bash
node utils/paymentTest.js
```

注意：
- 请在测试环境中运行此脚本
- 测试使用0.01元的小额支付
- 运行前请确保配置了正确的微信支付参数
- 小程序支付测试需要提供有效的测试openid

## 常见问题

### 1. 支付二维码无法识别
- 检查二维码URL是否正确
- 确认微信支付商户号是否已开通扫码支付功能

### 2. 小程序支付失败
- 检查openid是否正确
- 确认小程序是否已绑定微信支付商户号
- 检查小程序域名是否已配置在安全域名中

### 3. 支付回调没有收到
- 检查回调URL是否正确配置
- 确认回调服务器能够被微信支付服务器访问
- 检查回调接口是否返回了正确的响应格式

### 4. 订单状态不更新
- 检查支付回调处理逻辑
- 确认数据库连接是否正常
- 查看服务器日志是否有错误信息

## 安全注意事项

1. 支付金额必须在服务端验证，避免前端篡改
2. 支付回调接口需要验证签名，防止伪造通知
3. 敏感信息如API密钥等必须通过环境变量配置，不得硬编码
4. 所有支付相关操作都需要用户认证
5. 定期查看支付日志，及时发现异常交易

---

如有其他问题，请参考微信支付官方文档或联系开发团队。