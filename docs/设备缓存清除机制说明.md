# 设备缓存清除机制说明

## 问题描述

**用户反馈：**
> 绑定了新的设备码，但缓存中的数据一直没被清除，还是显示旧设备信息。

## 问题原因

### 1. 缓存未清除
绑定新设备时，旧的设备缓存数据没有被清除，导致：
- 旧设备码还在缓存中
- 旧设备信息还在显示
- 新设备信息被旧数据覆盖

### 2. 无法重新绑定
设备绑定页面在 `onLoad` 时检查到已绑定就直接跳转，导致：
- 无法进入绑定页面
- 无法输入新设备码
- 无法更换设备

## 解决方案

### 1. ✅ 绑定前清除旧缓存

在绑定新设备前，先清除所有旧的设备缓存数据：

```javascript
// 清除旧的设备缓存数据
console.log('清除旧的设备缓存...');
wx.removeStorageSync('deviceBound');
wx.removeStorageSync('deviceCode');
wx.removeStorageSync('device_no');
wx.removeStorageSync('device_info');
wx.removeStorageSync('customer_info');
wx.removeStorageSync('binding_info');

// 清除全局数据
app.globalData.deviceBound = false;
app.globalData.deviceCode = '';
app.globalData.device_no = '';
app.globalData.device_info = null;
app.globalData.customer_info = null;
```

### 2. ✅ 支持重新绑定

允许用户从"我的"页面重新绑定设备：

**实现方式：**
1. 在"我的"页面添加"重新绑定设备"入口
2. 点击后显示当前绑定信息
3. 确认后跳转到绑定页面（带 `rebind=true` 参数）
4. 绑定页面识别参数，允许重新绑定

**代码实现：**

```javascript
// pages/my/my.js
rebindDevice() {
  const currentDeviceCode = wx.getStorageSync('deviceCode');
  const deviceName = wx.getStorageSync('device_info')?.device_name || '未知设备';
  
  wx.showModal({
    title: '重新绑定设备',
    content: `当前绑定：${deviceName}\n设备码：${currentDeviceCode || '无'}\n\n确定要重新绑定设备吗？`,
    confirmText: '重新绑定',
    cancelText: '取消',
    success: (res) => {
      if (res.confirm) {
        navigation.navigateTo('/pages/bind-device-code/bind-device-code?rebind=true');
      }
    }
  });
}
```

```javascript
// pages/bind-device-code/bind-device-code.js
onLoad(options) {
  const isRebind = options.rebind === 'true';
  
  if (!isRebind) {
    // 只有非重新绑定时才检查已绑定状态
    const deviceBound = wx.getStorageSync('deviceBound');
    if (deviceBound) {
      // 已绑定，跳转首页
      wx.redirectTo({ url: '/pages/home/home' });
      return;
    }
  } else {
    // 重新绑定时，允许进入页面
    wx.showToast({
      title: '可以重新绑定设备',
      icon: 'none',
      duration: 2000
    });
  }
}
```

---

## 缓存数据结构

### 存储的缓存项

| 缓存键 | 数据类型 | 说明 | 示例 |
|--------|---------|------|------|
| `deviceBound` | Boolean | 是否已绑定设备 | `true` |
| `deviceCode` | String | 设备绑定码 | `"DEV00845211"` |
| `device_no` | String | 设备编号 | `"DEV00845211"` |
| `device_info` | Object | 设备详细信息 | `{ id, device_name, ... }` |
| `customer_info` | Object | 客户信息 | `{ id, customer_name, ... }` |
| `binding_info` | Object | 绑定关系信息 | `{ id, device_id, ... }` |

### 全局数据

```javascript
app.globalData = {
  deviceBound: false,
  deviceCode: '',
  device_no: '',
  device_info: null,
  customer_info: null
}
```

---

## 使用流程

### 场景 1：首次绑定设备

```
1. 用户进入绑定页面
2. 输入设备码
3. 点击绑定
4. ✅ 清除旧缓存（虽然是空的）
5. 调用绑定接口
6. 查询设备信息
7. 保存到缓存
8. 跳转首页
```

### 场景 2：重新绑定设备

```
1. 用户进入"我的"页面
2. 点击"重新绑定设备"
3. 显示当前绑定信息
4. 确认重新绑定
5. 跳转到绑定页面（带 rebind=true）
6. 输入新设备码
7. 点击绑定
8. ✅ 清除旧缓存
9. 调用绑定接口
10. 查询新设备信息
11. 保存到缓存
12. 跳转首页
```

### 场景 3：已绑定设备时进入绑定页面

```
1. 用户误点进入绑定页面
2. 检测到已绑定（rebind != true）
3. 提示"设备已绑定"
4. 自动跳转首页
```

---

## 清除缓存的时机

### ✅ 正确的清除时机

1. **绑定新设备前**
   - 在调用绑定接口前清除
   - 确保新数据不被旧数据污染

2. **用户主动重新绑定**
   - 用户从"我的"页面选择重新绑定
   - 清除旧数据，绑定新设备

3. **退出登录时**（可选）
   - 清除所有用户相关数据
   - 包括设备缓存

### ❌ 错误的清除时机

1. **页面加载时**
   - 不要在每次进入页面时清除
   - 会导致用户需要重复绑定

2. **应用启动时**
   - 不要在 `app.js` 的 `onLaunch` 中清除
   - 会丢失用户绑定状态

---

## 测试清单

### 测试场景

- [ ] **首次绑定**
  - [ ] 输入设备码
  - [ ] 绑定成功
  - [ ] 缓存正确保存
  - [ ] 跳转首页

- [ ] **重新绑定**
  - [ ] 进入"我的"页面
  - [ ] 点击"重新绑定设备"
  - [ ] 显示当前设备信息
  - [ ] 确认重新绑定
  - [ ] 输入新设备码
  - [ ] 旧缓存被清除
  - [ ] 新设备绑定成功
  - [ ] 新缓存正确保存

- [ ] **已绑定时误入绑定页面**
  - [ ] 检测到已绑定
  - [ ] 自动跳转首页
  - [ ] 不影响现有绑定

- [ ] **缓存持久性**
  - [ ] 关闭小程序
  - [ ] 重新打开
  - [ ] 设备绑定状态保持
  - [ ] 设备信息正确显示

---

## 调试方法

### 1. 查看缓存数据

```javascript
// 在控制台执行
console.log('deviceBound:', wx.getStorageSync('deviceBound'));
console.log('deviceCode:', wx.getStorageSync('deviceCode'));
console.log('device_info:', wx.getStorageSync('device_info'));
console.log('customer_info:', wx.getStorageSync('customer_info'));
```

### 2. 手动清除缓存

```javascript
// 在控制台执行
wx.clearStorageSync();
console.log('缓存已清除');
```

### 3. 查看全局数据

```javascript
// 在控制台执行
const app = getApp();
console.log('globalData:', app.globalData);
```

---

## 注意事项

### 1. 缓存同步
- 缓存操作使用 `Sync` 版本（同步）
- 确保数据立即生效
- 避免异步导致的数据不一致

### 2. 全局数据同步
- 缓存和全局数据要同时更新
- 避免数据不一致

### 3. 错误处理
- 清除缓存时捕获异常
- 绑定失败时不保存缓存
- 提供友好的错误提示

### 4. 用户体验
- 重新绑定前显示当前设备信息
- 给用户确认的机会
- 绑定成功后及时反馈

---

## 更新日志

### v1.3.0 (2025-11-27 16:27)

**新增：**
- ✅ 绑定前自动清除旧缓存
- ✅ "我的"页面添加"重新绑定设备"功能
- ✅ 支持重新绑定设备流程

**优化：**
- 🔄 绑定页面支持 `rebind` 参数
- 🔄 清除缓存逻辑更完善
- 🔄 用户体验更友好

**修复：**
- 🐛 修复缓存未清除导致数据不更新的问题
- 🐛 修复无法重新绑定设备的问题

**修改文件：**
- `pages/bind-device-code/bind-device-code.js` - 添加缓存清除和重新绑定支持
- `pages/my/my.js` - 添加重新绑定设备功能

---

## 常见问题

### Q: 为什么绑定新设备后还显示旧设备？
A: 已修复。现在绑定新设备前会自动清除旧缓存。

### Q: 如何重新绑定设备？
A: 进入"我的"页面 → 点击"重新绑定设备" → 确认 → 输入新设备码。

### Q: 重新绑定会丢失数据吗？
A: 不会。只是更换设备绑定，用户账号和历史数据不受影响。

### Q: 如何查看当前绑定的设备？
A: 在"我的"页面点击"重新绑定设备"，会显示当前绑定的设备信息。
