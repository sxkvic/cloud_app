# 设备信息存储方案

## 概述

为了让小程序各个页面都能方便地访问设备信息，在设备绑定成功后，将完整的设备信息存储到本地缓存中。

## 存储时机

**文件**: `pages/bind-device-code/bind-device-code.js`

在用户成功绑定设备后（第 86-113 行）：

1. 调用 `API.bindDevice(deviceCode)` 完成绑定
2. 调用 `API.getCustomerByDeviceCode(deviceCode)` 获取完整设备信息
3. 将设备信息存储到本地缓存和全局数据

## 存储的数据

### 本地缓存 (wx.setStorageSync)

| 键名 | 说明 | 数据来源 |
|------|------|----------|
| `deviceBound` | 设备绑定状态标识 | 布尔值 true |
| `deviceCode` | 设备绑定码（16位） | 用户输入/扫码 |
| `device_no` | 设备编号 | `device_info.device_no` |
| `device_info` | 完整设备信息对象 | API返回的 `device_info` |
| `customer_info` | 客户信息对象 | API返回的 `customer` |
| `binding_info` | 绑定关系信息对象 | API返回的 `binding_info` |

### 全局数据 (app.globalData)

同步存储以下数据到全局对象：
- `deviceBound`
- `deviceCode`
- `device_no`
- `device_info`
- `customer_info`

## 使用示例

### 服务评价页面

**文件**: `pages/service-evaluation/service-evaluation.js`

在 `onLoad` 方法中（第 56-80 行）：

```javascript
// 优先从页面参数获取
let device_no = options.device_no;

// 如果没有，从本地缓存读取
if (!device_no) {
  device_no = wx.getStorageSync('device_no') || wx.getStorageSync('deviceCode');
}

// 加载设备信息用于显示
const device_info = wx.getStorageSync('device_info');
if (device_info && device_info.device_name) {
  this.setData({
    'orderInfo.serviceType': device_info.device_name + '服务'
  });
}
```

### 其他页面使用

任何需要设备信息的页面都可以直接读取：

```javascript
// 读取设备编号
const device_no = wx.getStorageSync('device_no');

// 读取完整设备信息
const device_info = wx.getStorageSync('device_info');
console.log('设备名称:', device_info.device_name);
console.log('设备类型:', device_info.device_type);

// 读取客户信息
const customer_info = wx.getStorageSync('customer_info');
console.log('客户姓名:', customer_info.customer_name);
console.log('联系电话:', customer_info.contact_phone);

// 读取绑定信息
const binding_info = wx.getStorageSync('binding_info');
console.log('套餐名称:', binding_info.current_package_name);
console.log('到期时间:', binding_info.expire_time);
```

## 数据结构参考

### device_info 对象

```javascript
{
  id: 16,
  device_no: "DEV00845211",
  device_name: "5G测试设备",
  device_type: "1",
  specification: "wifi6",
  description: "测试设备",
  amount: "99.00",
  status: "1",
  created_at: "2025-11-18 19:40:53",
  updated_at: "2025-11-18 19:40:53"
}
```

### customer_info 对象

```javascript
{
  id: 37,
  customer_name: "高超",
  user_type: 1,
  id_number: "321023199111015012",
  contact_person: "刘柱",
  contact_phone: "18120052088",
  city: "江苏省/苏州市",
  install_address: "姑苏区石路营业厅",
  status: "2",
  created_at: "2025-11-25 09:53:59",
  updated_at: "2025-11-25 10:31:04"
}
```

### binding_info 对象

```javascript
{
  id: 11,
  device_id: 16,
  device_no: "DEV00845211",
  device_type: "1",
  customer_id: 37,
  customer_name: "高超",
  deposit: "100.00",
  carrier: "电信",
  recharge_account: "18120052088",
  remark: "电信物联网卡",
  status: "1",
  expire_time: "2026-02-17 19:41:48",
  current_package_id: 19,
  current_package_name: "测试包月卡--1天",
  current_package_type: "0"
}
```

## 适用场景

这种存储方案适用于以下页面：

1. ✅ **服务评价** - 需要 `device_no` 提交评价
2. ✅ **套餐订购** - 需要 `customer_id` 和 `device_id` 创建订单
3. ✅ **预充值** - 需要设备和客户信息
4. ✅ **业务申请** - 需要客户和设备信息
5. ✅ **投诉管理** - 需要 `device_number`
6. ✅ **我的账单** - 可以显示设备信息
7. ✅ **开票管理** - 需要客户和设备信息

## 注意事项

1. **数据时效性**: 本地缓存的数据可能过期，重要操作前建议重新获取最新数据
2. **清除缓存**: 用户解绑设备或退出登录时，应清除相关缓存
3. **容错处理**: 读取缓存时要做好空值判断，避免程序崩溃
4. **安全性**: 敏感信息（如身份证号）应谨慎使用，避免在日志中打印

## 优势

1. **减少网络请求**: 避免每个页面都重复请求设备信息
2. **提升用户体验**: 页面加载更快，无需等待接口返回
3. **简化代码**: 各页面无需通过页面参数传递设备信息
4. **统一数据源**: 所有页面使用相同的数据结构，便于维护

## 设备码输入优化

为了确保设备码格式统一，避免空格等字符干扰，在设备绑定页面做了以下优化：

### 输入时自动处理

**文件**: `pages/bind-device-code/bind-device-code.js`

1. **输入框实时处理** (第 39-45 行)
   - 自动去除所有空格（包括中间和两端的空格）
   - 自动转换为大写字母
   - 用户输入时即时生效

2. **扫码结果处理** (第 48-58 行)
   - 扫码后自动去除空格
   - 自动转换为大写

3. **提交前二次验证** (第 72-88 行)
   - 提交前再次去除空格并转换大写（双重保险）
   - 验证设备码不为空
   - 验证设备码长度（至少6位）

### 处理逻辑

```javascript
// 去除所有空格（包括空格、制表符、换行符等）
deviceCode = deviceCode.replace(/\s+/g, '');

// 转换为大写
deviceCode = deviceCode.toUpperCase();
```

### 优势

- ✅ 防止用户复制粘贴时带入多余空格
- ✅ 统一设备码格式（全大写）
- ✅ 提升数据质量，减少后端验证压力
- ✅ 改善用户体验，无需手动清理格式

## 更新日期

2025-11-27
