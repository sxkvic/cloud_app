# ç”µå­åè®®ä½¿ç”¨è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

ç”µå­åè®®é¡µé¢ä¼šè‡ªåŠ¨ä»ç¼“å­˜ä¸­è¯»å–å®¢æˆ·ä¿¡æ¯ï¼Œå¹¶å¡«å……åˆ°ä¸šåŠ¡ç™»è®°å•ä¸­ï¼Œç”Ÿæˆå®Œæ•´çš„ç”µå­åè®®æ–‡æ¡£ã€‚

## æ•°æ®æ¥æº

### 1. è‡ªåŠ¨å¡«å……ï¼ˆæ¨èï¼‰

é¡µé¢ä¼šè‡ªåŠ¨ä»ä»¥ä¸‹æ¥æºè·å–æ•°æ®ï¼š

```javascript
// ä¼˜å…ˆçº§1: ä»ç¼“å­˜è¯»å–ï¼ˆç™»å½•æ—¶å·²è·å–ï¼‰
const customerInfo = wx.getStorageSync('complete_customer_info');

// ä¼˜å…ˆçº§2: ç¼“å­˜ä¸å­˜åœ¨æ—¶ï¼Œé‡æ–°è·å–
const result = await DataManager.getCompleteCustomerInfo(deviceCode, true);
```

### 2. ä¼ å…¥å‚æ•°

ä¹Ÿå¯ä»¥é€šè¿‡é¡µé¢å‚æ•°ä¼ å…¥æ•°æ®ï¼š

```javascript
// æ–¹å¼1: ä¼ å…¥è®¢å•å·
wx.navigateTo({
  url: '/pages/electronic-agreement/electronic-agreement?orderNo=123456'
});

// æ–¹å¼2: ä¼ å…¥å®Œæ•´æ•°æ®ï¼ˆJSONå­—ç¬¦ä¸²ï¼‰
const orderData = { ... };
wx.navigateTo({
  url: `/pages/electronic-agreement/electronic-agreement?data=${encodeURIComponent(JSON.stringify(orderData))}`
});
```

## æ•°æ®å­—æ®µæ˜ å°„

### å®¢æˆ·ä¿¡æ¯æ˜ å°„

| åè®®å­—æ®µ | æ•°æ®æ¥æº | è¯´æ˜ |
|---------|---------|------|
| `customerName` | `customer.customer_name` | å®¢æˆ·åç§° |
| `contactPhone` | `customer.contact_phone` æˆ– `binding_info.recharge_account` | è”ç³»ç”µè¯ |
| `idType` | æ ¹æ® `customer.user_type` åˆ¤æ–­ | ä¸ªäºº=èº«ä»½è¯ï¼Œä¼ä¸š=ç»Ÿä¸€ä¿¡ç”¨ä»£ç  |
| `idNumber` | `customer.id_number`ï¼ˆè„±æ•å¤„ç†ï¼‰ | è¯ä»¶å·ç  |
| `idAddress` | `customer.install_address` | è¯ä»¶åœ°å€ |

### å¥—é¤ä¿¡æ¯æ˜ å°„

| åè®®å­—æ®µ | æ•°æ®æ¥æº | è¯´æ˜ |
|---------|---------|------|
| `packageName` | `package.package_name` æˆ– `binding_info.current_package_name` | å¥—é¤åç§° |
| `packageSpeed` | `package.flow` | å¥—é¤é€Ÿç‡ |
| `originalPrice` | `package.order_amount` æˆ– `package.price` | åŸä»· |
| `discountPrice` | `package.price` æˆ– `package.order_amount` | ä¼˜æƒ ä»· |
| `downloadSpeed` | `package.flow` | ä¸‹è¡Œé€Ÿç‡ |
| `uploadSpeed` | å›ºå®š `20M` | ä¸Šè¡Œé€Ÿç‡ |
| `contractMonths` | å›ºå®š `12` | åˆçº¦æœˆæ•° |

### äº§å“ä¿¡æ¯æ˜ å°„

| åè®®å­—æ®µ | æ•°æ®æ¥æº | è¯´æ˜ |
|---------|---------|------|
| `broadbandNo` | `device.device_no` æˆ– `device_info.device_no` | å®½å¸¦ç¼–å· |
| `gatewayNo` | `device.device_no` æˆ– `device_info.device_no` | ç½‘å…³ç¼–å· |
| `installAddress` | `customer.install_address` | å®‰è£…åœ°å€ |

### è´¹ç”¨ä¿¡æ¯æ˜ å°„

| åè®®å­—æ®µ | æ•°æ®æ¥æº | è¯´æ˜ |
|---------|---------|------|
| `prepayAmount` | `package.price` æˆ– `package.order_amount` | é¢„ä»˜é‡‘é¢ |
| `debugFee` | å›ºå®š `0` | è°ƒæµ‹è´¹ |
| `actualPayment` | `package.price` æˆ– `package.order_amount` | å®ä»˜æ¬¾ |

### å…¶ä»–ä¿¡æ¯

| åè®®å­—æ®µ | æ•°æ®æ¥æº | è¯´æ˜ |
|---------|---------|------|
| `orderNo` | è‡ªåŠ¨ç”Ÿæˆ | è®¢å•ç¼–å· |
| `acceptDate` | å½“å‰æ—¥æœŸ | å—ç†æ—¥æœŸ |
| `contactPerson` | `customer.contact_person` æˆ– `customer.customer_name` | è”ç³»äºº |
| `itemList` | å›ºå®š `[{ name: 'åƒå…†ç½‘å…³è·¯ç”±', quantity: 1 }]` | ç‰©å“æ¸…å• |

## æ•°æ®ç»“æ„ç¤ºä¾‹

### è¾“å…¥æ•°æ®ï¼ˆcustomerInfoï¼‰

```javascript
{
  customer: {
    id: 44,
    customer_name: "è¾½å®ç™¾è‰ç›Šå¯¿ä¸­è¯æˆ¿è¿é”æœ‰é™å…¬å¸",
    contact_person: "æ–½å…´ç§‘",
    contact_phone: "18701684408",
    id_number: "9875548754789EKG",
    install_address: "æ²³åŒ—çœé‚¯éƒ¸å¸‚æŸæŸè·¯111å·",
    user_type: 2  // 2=ä¼ä¸š
  },
  device: {
    id: 40,
    device_no: "DVO090909",
    device_name: "æµ‹è¯•è®¾å¤‡"
  },
  binding_info: {
    id: 45,
    recharge_account: "18701684408",
    current_package_name: "æµ‹è¯•åŒ…æœˆå¡--1å¤©"
  },
  package: {
    package_id: 19,
    package_name: "æµ‹è¯•åŒ…æœˆå¡--1å¤©",
    price: "0.01",
    flow: "1000M"
  },
  account: {
    id: 34,
    balance: "0.01"
  }
}
```

### è¾“å‡ºæ•°æ®ï¼ˆorderDataï¼‰

```javascript
{
  // å¤´éƒ¨ä¿¡æ¯
  orderNo: "122025120700012345678",
  currentPage: 1,
  totalPages: 3,
  acceptDate: "2025 å¹´ 12 æœˆ 07 æ—¥",
  
  // å®¢æˆ·ä¿¡æ¯
  customerName: "è¾½å®ç™¾è‰ç›Šå¯¿ä¸­è¯æˆ¿è¿é”æœ‰é™å…¬å¸",
  contactPhone: "18701684408",
  idType: "ç»Ÿä¸€ä¿¡ç”¨ä»£ç ",
  idNumber: "987***********EKG",  // å·²è„±æ•
  idAddress: "æ²³åŒ—çœé‚¯éƒ¸å¸‚æŸæŸè·¯111å·",
  businessOrderNo: "122025120700012345678",
  
  // å¥—é¤ä¿¡æ¯
  packageName: "æµ‹è¯•åŒ…æœˆå¡--1å¤©",
  packageSpeed: "1000M",
  originalPrice: "0.01",
  discountPrice: "0.01",
  downloadSpeed: "1000M",
  uploadSpeed: "20M",
  contractMonths: 12,
  
  // äº§å“ä¿¡æ¯
  broadbandNo: "DVO090909",
  gatewayNo: "DVO090909",
  installAddress: "æ²³åŒ—çœé‚¯éƒ¸å¸‚æŸæŸè·¯111å·",
  
  // è´¹ç”¨ä¿¡æ¯
  prepayAmount: "0.01",
  debugFee: "0",
  actualPayment: "0.01",
  
  // ç‰©å“æ¸…å•
  itemList: [
    { name: "åƒå…†ç½‘å…³è·¯ç”±", quantity: 1 }
  ],
  
  // é¢„çº¦ä¿¡æ¯
  appointmentTime: "",
  contactPerson: "æ–½å…´ç§‘"
}
```

## æ ¸å¿ƒæ–¹æ³•

### 1. `loadCustomerInfo()`

ä»ç¼“å­˜åŠ è½½å®¢æˆ·ä¿¡æ¯å¹¶å¡«å……åˆ°åè®®ä¸­ã€‚

```javascript
async loadCustomerInfo() {
  // 1. ä»ç¼“å­˜è·å–
  let customerInfo = wx.getStorageSync('complete_customer_info');
  
  // 2. ç¼“å­˜ä¸å­˜åœ¨åˆ™é‡æ–°è·å–
  if (!customerInfo && this.data.deviceCode) {
    const result = await DataManager.getCompleteCustomerInfo(deviceCode, true);
    customerInfo = result.data;
  }
  
  // 3. å¡«å……è®¢å•æ•°æ®
  const orderData = this.fillOrderDataFromCustomer(customerInfo);
  this.setData({ orderData, loading: false });
}
```

### 2. `fillOrderDataFromCustomer(customerInfo)`

å°†å®¢æˆ·ä¿¡æ¯è½¬æ¢ä¸ºåè®®æ‰€éœ€çš„è®¢å•æ•°æ®æ ¼å¼ã€‚

```javascript
fillOrderDataFromCustomer(customerInfo) {
  const customer = customerInfo.customer || {};
  const device = customerInfo.device || customerInfo.device_info || {};
  const binding = customerInfo.binding_info || {};
  const packageInfo = customerInfo.package || {};
  
  return {
    orderNo: this.generateOrderNo(),
    acceptDate: this.formatCurrentDate(),
    customerName: customer.customer_name || '',
    contactPhone: customer.contact_phone || binding.recharge_account || '',
    // ... å…¶ä»–å­—æ®µæ˜ å°„
  };
}
```

### 3. `generateOrderNo()`

ç”Ÿæˆè®¢å•ç¼–å·ã€‚

```javascript
generateOrderNo() {
  const now = new Date();
  const year = now.getFullYear();
  const month = String(now.getMonth() + 1).padStart(2, '0');
  const day = String(now.getDate()).padStart(2, '0');
  const random = Math.floor(Math.random() * 1000000000).toString().padStart(9, '0');
  return `12${year}${month}${day}000${random}`;
}
```

### 4. `maskIdNumber(idNumber)`

è„±æ•è¯ä»¶å·ç ã€‚

```javascript
maskIdNumber(idNumber) {
  if (!idNumber || idNumber.length < 8) return idNumber;
  const start = idNumber.substring(0, 3);
  const end = idNumber.substring(idNumber.length - 3);
  const middle = '*'.repeat(idNumber.length - 6);
  return start + middle + end;
}
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: å¥—é¤è®¢è´­åæŸ¥çœ‹åè®®

```javascript
// åœ¨å¥—é¤è®¢è´­æˆåŠŸåè·³è½¬
wx.navigateTo({
  url: '/pages/electronic-agreement/electronic-agreement'
});
// é¡µé¢ä¼šè‡ªåŠ¨ä»ç¼“å­˜åŠ è½½å®¢æˆ·ä¿¡æ¯
```

### åœºæ™¯2: ä»è®¢å•è¯¦æƒ…æŸ¥çœ‹åè®®

```javascript
// ä¼ å…¥è®¢å•å·
wx.navigateTo({
  url: `/pages/electronic-agreement/electronic-agreement?orderNo=${orderNo}`
});
// é¡µé¢ä¼šè°ƒç”¨æ¥å£è·å–è®¢å•è¯¦æƒ…ï¼ˆéœ€è¦å®ç° loadOrderData æ–¹æ³•ï¼‰
```

### åœºæ™¯3: é¢„è§ˆåè®®ï¼ˆä¼ å…¥å®Œæ•´æ•°æ®ï¼‰

```javascript
const orderData = {
  customerName: "å¼ ä¸‰",
  contactPhone: "13800138000",
  // ... å…¶ä»–å­—æ®µ
};

wx.navigateTo({
  url: `/pages/electronic-agreement/electronic-agreement?data=${encodeURIComponent(JSON.stringify(orderData))}`
});
```

## é¡µé¢çŠ¶æ€

### åŠ è½½ä¸­

```xml
<view wx:if="{{loading}}" class="loading-container">
  <view class="loading-text">æ­£åœ¨åŠ è½½å®¢æˆ·ä¿¡æ¯...</view>
</view>
```

### å†…å®¹æ˜¾ç¤º

```xml
<view wx:else>
  <!-- åè®®å†…å®¹ -->
</view>
```

## æ³¨æ„äº‹é¡¹

### 1. æ•°æ®å…¼å®¹æ€§

ä»£ç æ”¯æŒæ–°æ—§æ¥å£å­—æ®µï¼š

```javascript
// è®¾å¤‡ä¿¡æ¯ï¼šä¼˜å…ˆä½¿ç”¨ deviceï¼Œé™çº§åˆ° device_info
const device = customerInfo.device || customerInfo.device_info || {};

// å¥—é¤ä¿¡æ¯ï¼šä¼˜å…ˆä½¿ç”¨ packageï¼Œé™çº§åˆ° binding_info
const packageName = packageInfo.package_name || binding.current_package_name || '';
```

### 2. è¯ä»¶ç±»å‹åˆ¤æ–­

```javascript
// æ ¹æ® user_type åˆ¤æ–­è¯ä»¶ç±»å‹
let idType = 'èº«ä»½è¯';
if (customer.user_type === 2 || customer.user_type === '2') {
  idType = 'ç»Ÿä¸€ä¿¡ç”¨ä»£ç ';
}
```

### 3. è¯ä»¶å·ç è„±æ•

```javascript
// ä¿ç•™å‰3ä½å’Œå3ä½ï¼Œä¸­é—´ç”¨*ä»£æ›¿
idNumber: this.maskIdNumber(customer.id_number)
// ä¾‹å¦‚: 913************71A
```

### 4. æ—¥æœŸæ ¼å¼åŒ–

```javascript
// æ ¼å¼: 2025 å¹´ 12 æœˆ 07 æ—¥
const acceptDate = `${year} å¹´ ${month} æœˆ ${day} æ—¥`;
```

## æ‰©å±•åŠŸèƒ½

### 1. æ·»åŠ è®¢å•æ¥å£

å¦‚æœéœ€è¦ä»åç«¯è·å–è®¢å•è¯¦æƒ…ï¼š

```javascript
async loadOrderData(orderNo) {
  wx.showLoading({ title: 'åŠ è½½ä¸­...' });
  
  try {
    const result = await API.getOrderDetail(orderNo);
    
    if (result.success) {
      const orderData = this.formatOrderData(result.data);
      this.setData({ orderData, loading: false });
    }
  } catch (error) {
    message.error('åŠ è½½è®¢å•æ•°æ®å¤±è´¥');
  } finally {
    wx.hideLoading();
  }
}
```

### 2. æ·»åŠ åˆ†äº«åŠŸèƒ½

```javascript
onShareAppMessage() {
  return {
    title: 'ä¸šåŠ¡ç™»è®°å•',
    path: `/pages/electronic-agreement/electronic-agreement?orderNo=${this.data.orderData.orderNo}`
  };
}
```

### 3. æ·»åŠ æ‰“å°/å¯¼å‡ºåŠŸèƒ½

```javascript
// ç”Ÿæˆå›¾ç‰‡
async generateImage() {
  // ä½¿ç”¨ canvas ç”Ÿæˆåè®®å›¾ç‰‡
  // æˆ–è°ƒç”¨åç«¯æ¥å£ç”Ÿæˆ PDF
}
```

## æ€»ç»“

ç”µå­åè®®é¡µé¢å·²å®Œå…¨é›†æˆæ•°æ®ç®¡ç†ç³»ç»Ÿï¼š

- âœ… è‡ªåŠ¨ä»ç¼“å­˜åŠ è½½å®¢æˆ·ä¿¡æ¯
- âœ… æ”¯æŒæ–°æ—§æ¥å£å­—æ®µå…¼å®¹
- âœ… å®Œæ•´çš„æ•°æ®æ˜ å°„å’Œæ ¼å¼åŒ–
- âœ… è¯ä»¶å·ç è‡ªåŠ¨è„±æ•
- âœ… è®¢å•ç¼–å·è‡ªåŠ¨ç”Ÿæˆ
- âœ… åŠ è½½çŠ¶æ€å‹å¥½æç¤º

ç”¨æˆ·åªéœ€è¿›å…¥é¡µé¢ï¼Œæ‰€æœ‰ä¿¡æ¯ä¼šè‡ªåŠ¨å¡«å……ï¼ğŸ‰
