# å¥—é¤è®¢è´­æ”¯ä»˜æ¥å…¥è¯´æ˜

## ä¼˜åŒ–å†…å®¹

ä¸ºå¥—é¤è®¢è´­é¡µé¢æ·»åŠ å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½ï¼Œç”¨æˆ·è®¢è´­å¥—é¤åéœ€è¦å®Œæˆæ”¯ä»˜æ‰èƒ½å®Œæˆè®¢å•ã€‚

---

## ä¿®æ”¹å†…å®¹

### æ–‡ä»¶ï¼š`pages/package-order/package-order.js`

#### 1. å¼•å…¥ app å®ä¾‹

```javascript
// âœ… æ·»åŠ  app å®ä¾‹å¼•ç”¨
const app = getApp();
```

#### 2. ä¿®æ”¹è®¢å•å¤„ç†æµç¨‹

**ä¼˜åŒ–å‰ âŒ**
```javascript
async processOrder() {
  // åˆ›å»ºè®¢å•
  const result = await API.createOrder({...});
  
  this.setData({ submitLoading: false });
  console.log('è®¢å•åˆ›å»ºæˆåŠŸ:', result.data);
  message.success('è®¢è´­æˆåŠŸï¼');
  
  // âŒ ç›´æ¥æ˜¾ç¤ºè®¢è´­å®Œæˆï¼Œæ²¡æœ‰æ”¯ä»˜æµç¨‹
  setTimeout(() => {
    wx.showModal({
      title: 'è®¢è´­å®Œæˆ',
      content: `è®¢è´­æˆåŠŸï¼`,
      success: () => {
        navigation.switchTab('/pages/home/home');
      }
    });
  }, 600);
}
```

**ä¼˜åŒ–å âœ…**
```javascript
async processOrder() {
  // åˆ›å»ºè®¢å•
  const result = await API.createOrder({...});
  
  this.setData({ submitLoading: false });
  console.log('è®¢å•åˆ›å»ºæˆåŠŸ:', result.data);
  
  // âœ… è®¢å•åˆ›å»ºæˆåŠŸåï¼Œè¿›å…¥æ”¯ä»˜æµç¨‹
  const orderData = result.data;
  if (orderData && (orderData.order_no || orderData.orderNo || orderData.orderId)) {
    console.log('è®¢å•åˆ›å»ºæˆåŠŸï¼Œè¿›å…¥æ”¯ä»˜æµç¨‹');
    await this.handlePayment(orderData, selectedPackage, customer);
  } else {
    message.error('è®¢å•åˆ›å»ºå¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}
```

#### 3. æ·»åŠ æ”¯ä»˜å¤„ç†å‡½æ•°

```javascript
// æ”¯ä»˜å¤„ç†å‡½æ•°
async handlePayment(orderData, packageInfo, customerInfo) {
  console.log('è®¢å•ä¿¡æ¯:', orderData);
  console.log('å¥—é¤ä¿¡æ¯:', packageInfo);
  console.log('å®¢æˆ·ä¿¡æ¯:', customerInfo);
  
  try {
    // è°ƒç”¨å¾®ä¿¡æ”¯ä»˜
    await this.handleWechatPayment(orderData, packageInfo, customerInfo);
  } catch (error) {
    console.error('æ”¯ä»˜å¤„ç†å¤±è´¥:', error);
    message.error('æ”¯ä»˜å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•');
    this.setData({ submitLoading: false });
  }
}
```

#### 4. æ·»åŠ å¾®ä¿¡æ”¯ä»˜å‡½æ•°

```javascript
// å¾®ä¿¡æ”¯ä»˜
async handleWechatPayment(orderData, packageInfo, customerInfo) {
  try {
    console.log('========== å¼€å§‹å¾®ä¿¡æ”¯ä»˜ ==========');
    
    wx.showLoading({ title: 'æ­£åœ¨è°ƒèµ·æ”¯ä»˜...' });
    
    // âœ… è·å–å¾®ä¿¡ code
    const loginRes = await new Promise((resolve, reject) => {
      wx.login({
        success: resolve,
        fail: reject
      });
    });
    
    const code = loginRes.code;
    
    if (!code) {
      wx.hideLoading();
      message.error('è·å–å¾®ä¿¡æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•');
      this.setData({ submitLoading: false });
      return;
    }
    
    // è·å– openid
    const openid = wx.getStorageSync('openid') || app.globalData.openid;
    
    if (!openid) {
      wx.hideLoading();
      message.error('æœªè·å–åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
      this.setData({ submitLoading: false });
      return;
    }
    
    // âœ… è°ƒç”¨å°ç¨‹åºæ”¯ä»˜æ¥å£ï¼ˆå¥—é¤è®¢è´­å‚æ•°ï¼‰
    const paymentParams = {
      payment_type: 1,        // å¾®ä¿¡æ”¯ä»˜
      order_id: orderData.order_no || orderData.orderNo || orderData.orderId || '',
      customer_id: customerInfo.id || customerInfo.customer_id,
      device_no: this.data.deviceCode,
      package_id: packageInfo.id,  // âœ… å¥—é¤ID
      orderType: 1,           // âœ… 1=å¥—é¤è®¢è´­
      code: code,             // âœ… å¾®ä¿¡ code
      openid: openid
    };
    
    console.log('æ”¯ä»˜å‚æ•°:', paymentParams);
    
    // è°ƒç”¨æ”¯ä»˜æ¥å£
    const payResult = await API.createMiniprogramPayment(paymentParams);
    
    wx.hideLoading();
    
    if (payResult.success && payResult.data) {
      // æ£€æŸ¥å¿…éœ€çš„æ”¯ä»˜å‚æ•°
      const requiredParams = ['timeStamp', 'nonceStr', 'package', 'signType', 'paySign'];
      const missingParams = requiredParams.filter(param => !payResult.data[param]);
      
      if (missingParams.length > 0) {
        message.error('æ”¯ä»˜å‚æ•°ä¸å®Œæ•´: ' + missingParams.join(', '));
        this.setData({ submitLoading: false });
        return;
      }
      
      // âœ… è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
      wx.requestPayment({
        timeStamp: payResult.data.timeStamp,
        nonceStr: payResult.data.nonceStr,
        package: payResult.data.package,
        signType: payResult.data.signType,
        paySign: payResult.data.paySign,
        success: (payRes) => {
          console.log('æ”¯ä»˜æˆåŠŸ', payRes);
          this.setData({ submitLoading: false });
          
          wx.showToast({
            title: 'æ”¯ä»˜æˆåŠŸ',
            icon: 'success',
            duration: 2000
          });
          
          // âœ… æ”¯ä»˜æˆåŠŸåæ˜¾ç¤ºè®¢è´­å®Œæˆæç¤º
          setTimeout(() => {
            wx.showModal({
              title: 'è®¢è´­å®Œæˆ',
              content: `${packageInfo.name} è®¢è´­æˆåŠŸï¼\nå®¢æˆ·ï¼š${customerInfo.customer_name}\nè®¢å•å·ï¼š${paymentParams.order_id}\næœˆè´¹ï¼šÂ¥${packageInfo.price}\næˆ‘ä»¬å°†å°½å¿«ä¸ºæ‚¨å®‰æ’æœåŠ¡ã€‚`,
              showCancel: false,
              confirmText: 'çŸ¥é“äº†',
              success: () => {
                navigation.switchTab('/pages/home/home');
              }
            });
          }, 600);
        },
        fail: (payErr) => {
          console.error('æ”¯ä»˜å¤±è´¥', payErr);
          this.setData({ submitLoading: false });
          
          if (payErr.errMsg.indexOf('cancel') > -1) {
            message.info('æ”¯ä»˜å·²å–æ¶ˆ');
          } else {
            message.error('æ”¯ä»˜å¤±è´¥: ' + payErr.errMsg);
          }
        }
      });
    } else {
      message.error('è·å–æ”¯ä»˜å‚æ•°å¤±è´¥: ' + (payResult.message || 'æœªçŸ¥é”™è¯¯'));
      this.setData({ submitLoading: false });
    }
    
  } catch (error) {
    wx.hideLoading();
    console.error('å¾®ä¿¡æ”¯ä»˜å¼‚å¸¸', error);
    message.error('æ”¯ä»˜å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
    this.setData({ submitLoading: false });
  }
}
```

---

## æ”¯ä»˜å‚æ•°å¯¹æ¯”

### é¢„å……å€¼æ”¯ä»˜å‚æ•°
```javascript
{
  payment_type: 1,
  order_id: "",
  customer_id: "37",
  device_no: "DEV00845211",
  orderType: 2,              // âœ… 2=é¢„å……å€¼
  openid: "oABC123...",
  code: "0c1vj0100...",
  recharge_amount: 100       // âœ… å……å€¼é‡‘é¢
}
```

### å¥—é¤è®¢è´­æ”¯ä»˜å‚æ•°
```javascript
{
  payment_type: 1,
  order_id: "",
  customer_id: "37",
  device_no: "DEV00845211",
  package_id: 19,            // âœ… å¥—é¤ID
  orderType: 1,              // âœ… 1=å¥—é¤è®¢è´­
  code: "0c1vj0100...",
  openid: "oABC123..."
}
```

### å…³é”®å·®å¼‚

| å‚æ•° | é¢„å……å€¼ | å¥—é¤è®¢è´­ | è¯´æ˜ |
|------|--------|----------|------|
| **orderType** | `2` | `1` | è®¢å•ç±»å‹ |
| **package_id** | âŒ æ—  | âœ… å¿…éœ€ | å¥—é¤ID |
| **recharge_amount** | âœ… å¿…éœ€ | âŒ æ—  | å……å€¼é‡‘é¢ |
| **code** | âœ… å¿…éœ€ | âœ… å¿…éœ€ | å¾®ä¿¡ä¸´æ—¶å‡­è¯ |
| **openid** | âœ… å¿…éœ€ | âœ… å¿…éœ€ | ç”¨æˆ·openid |

---

## å®Œæ•´æµç¨‹

### å¥—é¤è®¢è´­æ”¯ä»˜æµç¨‹

```
ç”¨æˆ·é€‰æ‹©å¥—é¤
  â†“
ç‚¹å‡»"ç«‹å³è®¢è´­"
  â†“
åˆ›å»ºè®¢å• (API.createOrder)
  â†“
è®¢å•åˆ›å»ºæˆåŠŸ
  â†“
è·å–å¾®ä¿¡ code (wx.login)
  â†“
è·å– openid (ç¼“å­˜/globalData)
  â†“
ç»„è£…æ”¯ä»˜å‚æ•°
  â†“
è°ƒç”¨æ”¯ä»˜æ¥å£ (API.createMiniprogramPayment)
  â†“
è·å–æ”¯ä»˜å‚æ•°
  â†“
è°ƒèµ·å¾®ä¿¡æ”¯ä»˜ (wx.requestPayment)
  â†“
æ”¯ä»˜æˆåŠŸ
  â†“
æ˜¾ç¤ºè®¢è´­å®Œæˆæç¤º
  â†“
è¿”å›é¦–é¡µ
```

---

## é”™è¯¯å¤„ç†

### 1. Code è·å–å¤±è´¥
```javascript
if (!code) {
  wx.hideLoading();
  message.error('è·å–å¾®ä¿¡æˆæƒå¤±è´¥ï¼Œè¯·é‡è¯•');
  this.setData({ submitLoading: false });
  return;
}
```

### 2. OpenID è·å–å¤±è´¥
```javascript
if (!openid) {
  wx.hideLoading();
  message.error('æœªè·å–åˆ°ç”¨æˆ·ä¿¡æ¯ï¼Œè¯·é‡æ–°ç™»å½•');
  this.setData({ submitLoading: false });
  return;
}
```

### 3. æ”¯ä»˜å‚æ•°ä¸å®Œæ•´
```javascript
const requiredParams = ['timeStamp', 'nonceStr', 'package', 'signType', 'paySign'];
const missingParams = requiredParams.filter(param => !payResult.data[param]);

if (missingParams.length > 0) {
  message.error('æ”¯ä»˜å‚æ•°ä¸å®Œæ•´: ' + missingParams.join(', '));
  this.setData({ submitLoading: false });
  return;
}
```

### 4. æ”¯ä»˜å–æ¶ˆ
```javascript
if (payErr.errMsg.indexOf('cancel') > -1) {
  message.info('æ”¯ä»˜å·²å–æ¶ˆ');
} else {
  message.error('æ”¯ä»˜å¤±è´¥: ' + payErr.errMsg);
}
```

### 5. æ”¯ä»˜å¼‚å¸¸
```javascript
catch (error) {
  wx.hideLoading();
  console.error('å¾®ä¿¡æ”¯ä»˜å¼‚å¸¸', error);
  message.error('æ”¯ä»˜å¤±è´¥: ' + (error.message || 'æœªçŸ¥é”™è¯¯'));
  this.setData({ submitLoading: false });
}
```

---

## Loading çŠ¶æ€ç®¡ç†

### æŒ‰é’® Loading
```javascript
// å¼€å§‹è®¢è´­
this.setData({ submitLoading: true });

// æ”¯ä»˜æˆåŠŸ/å¤±è´¥å
this.setData({ submitLoading: false });
```

### å…¨å±€ Loading
```javascript
// è°ƒèµ·æ”¯ä»˜å‰
wx.showLoading({ title: 'æ­£åœ¨è°ƒèµ·æ”¯ä»˜...' });

// è·å–æ”¯ä»˜å‚æ•°å
wx.hideLoading();

// å¼‚å¸¸æ—¶
wx.hideLoading();
```

---

## æ—¥å¿—è¾“å‡º

### å…³é”®æ—¥å¿—
```javascript
console.log('========== å¼€å§‹å¾®ä¿¡æ”¯ä»˜ ==========');
console.log('è®¢å•æ•°æ®:', orderData);
console.log('è·å–å¾®ä¿¡code:', code);
console.log('è·å–openid:', openid);
console.log('æ”¯ä»˜å‚æ•°:', paymentParams);
console.log('========== æ”¯ä»˜æ¥å£è¿”å› ==========');
console.log('å®Œæ•´è¿”å›æ•°æ®:', JSON.stringify(payResult, null, 2));
console.log('========== å‡†å¤‡è°ƒèµ·å¾®ä¿¡æ”¯ä»˜ ==========');
console.log('æ”¯ä»˜å‚æ•°:', JSON.stringify(payResult.data, null, 2));
console.log('========== æ”¯ä»˜æˆåŠŸ ==========', payRes);
console.log('========== æ”¯ä»˜å¤±è´¥ ==========');
```

---

## æµ‹è¯•è¦ç‚¹

### 1. æ­£å¸¸æµç¨‹
- âœ… é€‰æ‹©å¥—é¤
- âœ… ç‚¹å‡»è®¢è´­
- âœ… åˆ›å»ºè®¢å•æˆåŠŸ
- âœ… è·å– code å’Œ openid
- âœ… è°ƒèµ·å¾®ä¿¡æ”¯ä»˜
- âœ… æ”¯ä»˜æˆåŠŸ
- âœ… æ˜¾ç¤ºè®¢è´­å®Œæˆæç¤º
- âœ… è¿”å›é¦–é¡µ

### 2. å¼‚å¸¸æµç¨‹
- âœ… Code è·å–å¤±è´¥
- âœ… OpenID è·å–å¤±è´¥
- âœ… æ”¯ä»˜å‚æ•°ä¸å®Œæ•´
- âœ… ç”¨æˆ·å–æ¶ˆæ”¯ä»˜
- âœ… æ”¯ä»˜å¤±è´¥
- âœ… ç½‘ç»œå¼‚å¸¸

### 3. UI çŠ¶æ€
- âœ… æŒ‰é’® loading çŠ¶æ€æ­£ç¡®
- âœ… å…¨å±€ loading æ­£ç¡®æ˜¾ç¤º/éšè—
- âœ… é”™è¯¯æç¤ºæ­£ç¡®æ˜¾ç¤º
- âœ… æˆåŠŸæç¤ºæ­£ç¡®æ˜¾ç¤º

---

## ä¸é¢„å……å€¼çš„å·®å¼‚

| é¡¹ç›® | é¢„å……å€¼ | å¥—é¤è®¢è´­ |
|------|--------|----------|
| **è®¢å•ç±»å‹** | `orderType: 2` | `orderType: 1` |
| **å¿…éœ€å‚æ•°** | `recharge_amount` | `package_id` |
| **è®¢å•åˆ›å»º** | `API.createPreRechargeOrder` | `API.createOrder` |
| **æ”¯ä»˜å‚æ•°** | åŒ…å«å……å€¼é‡‘é¢ | åŒ…å«å¥—é¤ID |
| **æˆåŠŸæç¤º** | "å……å€¼æˆåŠŸï¼" | "è®¢è´­æˆåŠŸï¼" |

---

## æ€»ç»“

### æ ¸å¿ƒä¿®æ”¹
1. âœ… **å¼•å…¥ app å®ä¾‹** - è·å– globalData.openid
2. âœ… **ä¿®æ”¹è®¢å•æµç¨‹** - åˆ›å»ºè®¢å•åè¿›å…¥æ”¯ä»˜æµç¨‹
3. âœ… **æ·»åŠ æ”¯ä»˜å‡½æ•°** - `handlePayment` å’Œ `handleWechatPayment`
4. âœ… **è·å–å¾®ä¿¡ code** - é€šè¿‡ `wx.login()` è·å–
5. âœ… **ç»„è£…æ”¯ä»˜å‚æ•°** - åŒ…å« `package_id` å’Œ `orderType: 1`
6. âœ… **è°ƒèµ·å¾®ä¿¡æ”¯ä»˜** - `wx.requestPayment()`
7. âœ… **å®Œå–„é”™è¯¯å¤„ç†** - å„ç§å¼‚å¸¸æƒ…å†µçš„å¤„ç†
8. âœ… **Loading çŠ¶æ€ç®¡ç†** - æŒ‰é’®å’Œå…¨å±€ loading

### ä¼˜åŒ–æ•ˆæœ
- âœ… **å®Œæ•´æ”¯ä»˜æµç¨‹** - è®¢å•åˆ›å»º â†’ æ”¯ä»˜ â†’ å®Œæˆ
- âœ… **å‚æ•°æ­£ç¡®** - ç¬¦åˆåç«¯æ¥å£è¦æ±‚
- âœ… **é”™è¯¯å¤„ç†å®Œå–„** - å„ç§å¼‚å¸¸æƒ…å†µéƒ½æœ‰å¤„ç†
- âœ… **ç”¨æˆ·ä½“éªŒå¥½** - Loading çŠ¶æ€æ¸…æ™°ï¼Œæç¤ºå‹å¥½

ç°åœ¨å¥—é¤è®¢è´­é¡µé¢å·²ç»å®Œæ•´æ¥å…¥å¾®ä¿¡æ”¯ä»˜åŠŸèƒ½äº†ï¼ğŸ‰
