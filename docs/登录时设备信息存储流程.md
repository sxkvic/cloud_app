# ç™»å½•æ—¶è®¾å¤‡ä¿¡æ¯å­˜å‚¨æµç¨‹è¯´æ˜

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š
> å‡å¦‚å·²ç»ç»‘å®šè¿‡çš„ï¼Œè¿›æ¥çš„æ—¶å€™æ˜¯ä¸æ˜¯éœ€è¦æ ¹æ®è¿™ä¸ªæ¥å£çš„æ•°æ®ï¼Œå†å°†å€¼å–å‡ºæ¥å­˜å¥½æ‰å¯¹ï¼Ÿ

**API è¿”å›ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "message": "è·å–è®¾å¤‡åˆ—è¡¨æˆåŠŸ",
  "data": {
    "devices": [
      {
        "device_no": "DEV00845211",
        "device_name": "5Gæµ‹è¯•è®¾å¤‡",
        "bind_time": "2025-11-27 16:32:22",
        "device_type": "..."
      }
    ]
  }
}
```

## é—®é¢˜åˆ†æ

### ä¹‹å‰çš„é—®é¢˜
1. âŒ åªè°ƒç”¨äº† `getUserDevices`ï¼Œä½†æ²¡æœ‰å­˜å‚¨è¿”å›çš„æ•°æ®
2. âŒ æ²¡æœ‰è·å–å®Œæ•´çš„å®¢æˆ·ä¿¡æ¯å’Œç»‘å®šä¿¡æ¯
3. âŒ ç¼“å­˜ä¸­åªæœ‰ `deviceCode`ï¼Œæ²¡æœ‰ `device_no` å’Œå…¶ä»–ä¿¡æ¯

### æ­£ç¡®çš„åšæ³•
1. âœ… è°ƒç”¨ `getUserDevices` è·å–è®¾å¤‡åˆ—è¡¨
2. âœ… è°ƒç”¨ `getCustomerByDeviceCode` è·å–å®Œæ•´ä¿¡æ¯
3. âœ… å­˜å‚¨å®Œæ•´çš„è®¾å¤‡ã€å®¢æˆ·ã€ç»‘å®šä¿¡æ¯åˆ°ç¼“å­˜

---

## å®Œæ•´çš„ç™»å½•æµç¨‹

### æµç¨‹å›¾

```
ç”¨æˆ·ç™»å½•
  â†“
è·å– token
  â†“
è°ƒç”¨ getUserDevices
  â†“
æ£€æŸ¥æ˜¯å¦æœ‰ç»‘å®šè®¾å¤‡
  â†“
æœ‰è®¾å¤‡ â†’ è°ƒç”¨ getCustomerByDeviceCode
  â†“
å­˜å‚¨å®Œæ•´ä¿¡æ¯ï¼š
  - device_no
  - device_info
  - customer_info
  - binding_info
  â†“
è·³è½¬é¦–é¡µ
```

---

## ä»£ç å®ç°

### 1. è°ƒç”¨ getUserDevices

```javascript
// è°ƒç”¨APIè·å–ç”¨æˆ·ç»‘å®šçš„è®¾å¤‡åˆ—è¡¨
const devicesResult = await API.getUserDevices();
const devices = devicesResult.data.devices || [];

console.log('ç”¨æˆ·ç»‘å®šçš„è®¾å¤‡:', devices);
```

**è¿”å›æ•°æ®ç¤ºä¾‹ï¼š**
```json
{
  "success": true,
  "data": {
    "devices": [
      {
        "device_no": "DEV00845211",
        "device_name": "5Gæµ‹è¯•è®¾å¤‡",
        "bind_time": "2025-11-27 16:32:22",
        "deviceCode": "DEV00845211"
      }
    ]
  }
}
```

---

### 2. è·å–å®Œæ•´è®¾å¤‡ä¿¡æ¯

```javascript
if (devices.length > 0) {
  const firstDevice = devices[0];
  const deviceCode = firstDevice.deviceCode || firstDevice.device_no;
  
  // è°ƒç”¨ getCustomerByDeviceCode è·å–å®Œæ•´ä¿¡æ¯
  const deviceInfoResult = await API.getCustomerByDeviceCode(deviceCode);
  
  if (deviceInfoResult.success && deviceInfoResult.data) {
    const { customer, binding_info, device_info } = deviceInfoResult.data;
    
    // å­˜å‚¨å®Œæ•´ä¿¡æ¯...
  }
}
```

**getCustomerByDeviceCode è¿”å›æ•°æ®ï¼š**
```json
{
  "success": true,
  "data": {
    "customer": {
      "id": 37,
      "customer_name": "é«˜è¶…",
      "contact_phone": "18120052088",
      "city": "æ±Ÿè‹çœ/è‹å·å¸‚"
    },
    "device_info": {
      "id": 16,
      "device_no": "DEV00845211",
      "device_name": "5Gæµ‹è¯•è®¾å¤‡",
      "device_type": "1",
      "amount": "99.00"
    },
    "binding_info": {
      "id": 11,
      "device_id": 16,
      "customer_id": 37,
      "carrier": "ç”µä¿¡",
      "recharge_account": "18120052088",
      "expire_time": "2026-02-17 19:41:48",
      "current_package_name": "æµ‹è¯•åŒ…æœˆå¡--1å¤©"
    }
  }
}
```

---

### 3. å­˜å‚¨å®Œæ•´ä¿¡æ¯

```javascript
// å­˜å‚¨åˆ°ç¼“å­˜
wx.setStorageSync('deviceBound', true);
wx.setStorageSync('device_no', device_info?.device_no);
wx.setStorageSync('device_info', device_info);
wx.setStorageSync('customer_info', customer);
wx.setStorageSync('binding_info', binding_info);

// åŒæ­¥åˆ°å…¨å±€æ•°æ®
app.globalData.deviceBound = true;
app.globalData.device_no = device_info?.device_no;
app.globalData.device_info = device_info;
app.globalData.customer_info = customer;
app.globalData.binding_info = binding_info;

console.log('âœ… å®Œæ•´è®¾å¤‡ä¿¡æ¯å·²å­˜å‚¨:', {
  device_no: device_info?.device_no,
  device_name: device_info?.device_name,
  customer_name: customer?.customer_name,
  customer_id: customer?.id,
  device_id: device_info?.id,
  expire_time: binding_info?.expire_time,
  current_package: binding_info?.current_package_name
});
```

---

## å­˜å‚¨çš„æ•°æ®ç»“æ„

### ç¼“å­˜æ•°æ®
```javascript
{
  // ç»‘å®šçŠ¶æ€
  deviceBound: true,
  
  // è®¾å¤‡ç¼–å·
  device_no: "DEV00845211",
  
  // è®¾å¤‡è¯¦ç»†ä¿¡æ¯
  device_info: {
    id: 16,                    // â† è®¾å¤‡IDï¼ˆè®¢å•åˆ›å»ºæ—¶ä½¿ç”¨ï¼‰
    device_no: "DEV00845211",
    device_name: "5Gæµ‹è¯•è®¾å¤‡",
    device_type: "1",
    specification: "wifi6",
    amount: "99.00"
  },
  
  // å®¢æˆ·ä¿¡æ¯
  customer_info: {
    id: 37,                    // â† å®¢æˆ·IDï¼ˆè®¢å•åˆ›å»ºæ—¶ä½¿ç”¨ï¼‰
    customer_name: "é«˜è¶…",
    user_type: 1,
    id_number: "321023199111015012",
    contact_person: "åˆ˜æŸ±",
    contact_phone: "18120052088",
    city: "æ±Ÿè‹çœ/è‹å·å¸‚",
    install_address: "å§‘è‹åŒºçŸ³è·¯è¥ä¸šå…"
  },
  
  // ç»‘å®šå…³ç³»ä¿¡æ¯
  binding_info: {
    id: 11,
    device_id: 16,
    customer_id: 37,
    device_no: "DEV00845211",
    customer_name: "é«˜è¶…",
    deposit: "100.00",
    carrier: "ç”µä¿¡",
    recharge_account: "18120052088",
    remark: "ç”µä¿¡ç‰©è”ç½‘å¡",
    status: "1",
    expire_time: "2026-02-17 19:41:48",
    current_package_id: 19,
    current_package_name: "æµ‹è¯•åŒ…æœˆå¡--1å¤©",
    current_package_type: "0"
  }
}
```

---

## æ•°æ®ä½¿ç”¨ç¤ºä¾‹

### 1. è·å–è®¾å¤‡ç¼–å·
```javascript
const device_no = wx.getStorageSync('device_no');
// æˆ–
const device_no = getApp().globalData.device_no;
```

### 2. è·å–å®¢æˆ·IDå’Œè®¾å¤‡IDï¼ˆè®¢å•åˆ›å»ºï¼‰
```javascript
const customer_info = wx.getStorageSync('customer_info');
const device_info = wx.getStorageSync('device_info');

const customer_id = customer_info?.id;  // 37
const device_id = device_info?.id;      // 16
```

### 3. è·å–ç»‘å®šä¿¡æ¯
```javascript
const binding_info = wx.getStorageSync('binding_info');

const carrier = binding_info?.carrier;              // "ç”µä¿¡"
const recharge_account = binding_info?.recharge_account;  // "18120052088"
const expire_time = binding_info?.expire_time;      // "2026-02-17 19:41:48"
const current_package = binding_info?.current_package_name;  // "æµ‹è¯•åŒ…æœˆå¡--1å¤©"
```

### 4. æ˜¾ç¤ºè®¾å¤‡ä¿¡æ¯
```javascript
const device_info = wx.getStorageSync('device_info');
const customer_info = wx.getStorageSync('customer_info');

console.log(`è®¾å¤‡ï¼š${device_info?.device_name}`);
console.log(`å®¢æˆ·ï¼š${customer_info?.customer_name}`);
console.log(`ç”µè¯ï¼š${customer_info?.contact_phone}`);
```

---

## é”™è¯¯å¤„ç†

### é™çº§ç­–ç•¥

å¦‚æœ `getCustomerByDeviceCode` è°ƒç”¨å¤±è´¥ï¼Œè‡³å°‘ä¿å­˜åŸºæœ¬ä¿¡æ¯ï¼š

```javascript
try {
  // å°è¯•è·å–å®Œæ•´ä¿¡æ¯
  const deviceInfoResult = await API.getCustomerByDeviceCode(deviceCode);
  // å­˜å‚¨å®Œæ•´ä¿¡æ¯...
} catch (error) {
  console.error('âŒ æŸ¥è¯¢å®Œæ•´è®¾å¤‡ä¿¡æ¯å¤±è´¥:', error);
  
  // é™çº§ï¼šè‡³å°‘ä¿å­˜åŸºæœ¬ä¿¡æ¯
  wx.setStorageSync('deviceBound', true);
  wx.setStorageSync('device_no', firstDevice.device_no || deviceCode);
  
  app.globalData.deviceBound = true;
  app.globalData.device_no = firstDevice.device_no || deviceCode;
}
```

---

## å¯¹æ¯”ï¼šä¼˜åŒ–å‰å

### ä¼˜åŒ–å‰ âŒ

```javascript
// åªè°ƒç”¨ getUserDevices
const devicesResult = await API.getUserDevices();
const devices = devicesResult.data.devices || [];

if (devices.length > 0) {
  const deviceCode = devices[0].deviceCode;
  
  // âŒ åªå­˜å‚¨äº† deviceCode
  wx.setStorageSync('deviceBound', true);
  wx.setStorageSync('deviceCode', deviceCode);
  
  // âŒ æ²¡æœ‰å®Œæ•´çš„è®¾å¤‡ä¿¡æ¯
  // âŒ æ²¡æœ‰å®¢æˆ·ä¿¡æ¯
  // âŒ æ²¡æœ‰ç»‘å®šä¿¡æ¯
}
```

**é—®é¢˜ï¼š**
- ç¼“å­˜ä¸­åªæœ‰ `deviceCode`
- æ²¡æœ‰ `device_no`ï¼ˆæ­£ç¡®çš„å‚æ•°åï¼‰
- æ²¡æœ‰å®Œæ•´çš„è®¾å¤‡ã€å®¢æˆ·ã€ç»‘å®šä¿¡æ¯
- å…¶ä»–é¡µé¢æ— æ³•è·å–å¿…è¦çš„æ•°æ®

---

### ä¼˜åŒ–å âœ…

```javascript
// 1. è°ƒç”¨ getUserDevices
const devicesResult = await API.getUserDevices();
const devices = devicesResult.data.devices || [];

if (devices.length > 0) {
  const firstDevice = devices[0];
  const deviceCode = firstDevice.deviceCode || firstDevice.device_no;
  
  // 2. è°ƒç”¨ getCustomerByDeviceCode è·å–å®Œæ•´ä¿¡æ¯
  const deviceInfoResult = await API.getCustomerByDeviceCode(deviceCode);
  const { customer, binding_info, device_info } = deviceInfoResult.data;
  
  // 3. å­˜å‚¨å®Œæ•´ä¿¡æ¯
  wx.setStorageSync('deviceBound', true);
  wx.setStorageSync('device_no', device_info?.device_no);
  wx.setStorageSync('device_info', device_info);
  wx.setStorageSync('customer_info', customer);
  wx.setStorageSync('binding_info', binding_info);
  
  // 4. åŒæ­¥åˆ°å…¨å±€æ•°æ®
  app.globalData.deviceBound = true;
  app.globalData.device_no = device_info?.device_no;
  app.globalData.device_info = device_info;
  app.globalData.customer_info = customer;
  app.globalData.binding_info = binding_info;
}
```

**ä¼˜åŠ¿ï¼š**
- âœ… ä½¿ç”¨æ­£ç¡®çš„å‚æ•°å `device_no`
- âœ… å­˜å‚¨å®Œæ•´çš„è®¾å¤‡ä¿¡æ¯
- âœ… å­˜å‚¨å®¢æˆ·ä¿¡æ¯ï¼ˆåŒ…å«å®¢æˆ·IDï¼‰
- âœ… å­˜å‚¨ç»‘å®šä¿¡æ¯ï¼ˆåŒ…å«åˆ°æœŸæ—¶é—´ã€å¥—é¤ç­‰ï¼‰
- âœ… å…¶ä»–é¡µé¢å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›æ•°æ®

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ­¥éª¤

1. **æ¸…é™¤ç¼“å­˜**
   ```javascript
   wx.clearStorageSync();
   ```

2. **é‡æ–°ç™»å½•**
   - è¾“å…¥è´¦å·å¯†ç 
   - ç‚¹å‡»ç™»å½•

3. **æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—**
   ```
   ğŸ“¦ ä» getUserDevices è·å–åˆ°çš„è®¾å¤‡æ•°æ®: {...}
   ğŸ” è°ƒç”¨ getCustomerByDeviceCode è·å–å®Œæ•´ä¿¡æ¯...
   âœ… å®Œæ•´è®¾å¤‡ä¿¡æ¯å·²å­˜å‚¨: {
     device_no: "DEV00845211",
     device_name: "5Gæµ‹è¯•è®¾å¤‡",
     customer_name: "é«˜è¶…",
     customer_id: 37,
     device_id: 16,
     expire_time: "2026-02-17 19:41:48",
     current_package: "æµ‹è¯•åŒ…æœˆå¡--1å¤©"
   }
   ```

4. **æ£€æŸ¥ç¼“å­˜æ•°æ®**
   ```javascript
   console.log('deviceBound:', wx.getStorageSync('deviceBound'));
   console.log('device_no:', wx.getStorageSync('device_no'));
   console.log('device_info:', wx.getStorageSync('device_info'));
   console.log('customer_info:', wx.getStorageSync('customer_info'));
   console.log('binding_info:', wx.getStorageSync('binding_info'));
   ```

5. **éªŒè¯æ•°æ®å®Œæ•´æ€§**
   - âœ… `device_no` æœ‰å€¼
   - âœ… `device_info.id` æœ‰å€¼ï¼ˆè®¾å¤‡IDï¼‰
   - âœ… `customer_info.id` æœ‰å€¼ï¼ˆå®¢æˆ·IDï¼‰
   - âœ… `binding_info.expire_time` æœ‰å€¼ï¼ˆåˆ°æœŸæ—¶é—´ï¼‰
   - âœ… `binding_info.current_package_name` æœ‰å€¼ï¼ˆå½“å‰å¥—é¤ï¼‰

---

## æ›´æ–°æ—¥å¿—

### v1.5.0 (2025-11-27 16:45)

**ä¼˜åŒ–ï¼š**
- âœ… ç™»å½•æ—¶è°ƒç”¨ `getCustomerByDeviceCode` è·å–å®Œæ•´ä¿¡æ¯
- âœ… å­˜å‚¨å®Œæ•´çš„è®¾å¤‡ã€å®¢æˆ·ã€ç»‘å®šä¿¡æ¯
- âœ… æ·»åŠ é™çº§ç­–ç•¥ï¼Œç¡®ä¿åŸºæœ¬ä¿¡æ¯æ€»æ˜¯è¢«å­˜å‚¨

**ä¿®å¤ï¼š**
- ğŸ› ä¿®å¤ç™»å½•æ—¶åªå­˜å‚¨ `deviceCode` çš„é—®é¢˜
- ğŸ› ä¿®å¤ç¼ºå°‘å®Œæ•´è®¾å¤‡ä¿¡æ¯çš„é—®é¢˜
- ğŸ› ä¿®å¤å…¶ä»–é¡µé¢æ— æ³•è·å–å®¢æˆ·IDå’Œè®¾å¤‡IDçš„é—®é¢˜

**ä¿®æ”¹æ–‡ä»¶ï¼š**
- `pages/login/login.js` - ä¼˜åŒ–è®¾å¤‡ä¿¡æ¯å­˜å‚¨é€»è¾‘

---

## æ€»ç»“

ç°åœ¨ç™»å½•æµç¨‹ä¼šï¼š

1. âœ… è°ƒç”¨ `getUserDevices` æ£€æŸ¥æ˜¯å¦æœ‰ç»‘å®šè®¾å¤‡
2. âœ… è°ƒç”¨ `getCustomerByDeviceCode` è·å–å®Œæ•´ä¿¡æ¯
3. âœ… å­˜å‚¨å®Œæ•´çš„è®¾å¤‡ã€å®¢æˆ·ã€ç»‘å®šä¿¡æ¯åˆ°ç¼“å­˜
4. âœ… åŒæ­¥åˆ°å…¨å±€æ•°æ®
5. âœ… å…¶ä»–é¡µé¢å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™äº›æ•°æ®

**å…³é”®æ•°æ®ï¼š**
- `device_no` - è®¾å¤‡ç¼–å·
- `device_info.id` - è®¾å¤‡IDï¼ˆè®¢å•åˆ›å»ºï¼‰
- `customer_info.id` - å®¢æˆ·IDï¼ˆè®¢å•åˆ›å»ºï¼‰
- `binding_info.expire_time` - åˆ°æœŸæ—¶é—´
- `binding_info.current_package_name` - å½“å‰å¥—é¤
