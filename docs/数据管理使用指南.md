# æ•°æ®ç®¡ç†ä½¿ç”¨æŒ‡å—

## æ¦‚è¿°

ä¸ºäº†ç¡®ä¿æ•°æ®çš„å¯é æ€§å’Œå®æ—¶æ€§ï¼Œæˆ‘ä»¬å¼•å…¥äº†æ–°çš„æ•°æ®ç®¡ç†ç³»ç»Ÿï¼ŒåŒ…æ‹¬ï¼š

1. **æ–°æ¥å£**ï¼š`/api/v1/wx/getCustomerAndPackageByDeviceNo` - æä¾›æ›´å®Œæ•´çš„å®¢æˆ·å’Œå¥—é¤ä¿¡æ¯
2. **æ•°æ®ç®¡ç†å™¨**ï¼š`utils/dataManager.js` - ç»Ÿä¸€ç®¡ç†æ•°æ®è·å–ã€ç¼“å­˜å’Œæ¸…é™¤
3. **ç»„åˆè°ƒç”¨**ï¼šå…ˆè°ƒç”¨æ—§æ¥å£è·å– `recharge_account`ï¼Œå†è°ƒç”¨æ–°æ¥å£è·å–å®Œæ•´æ•°æ®

## æ ¸å¿ƒåŸåˆ™

âš ï¸ **é‡è¦**ï¼šæ¯æ¬¡è¿›å…¥é¡µé¢éƒ½åº”è¯¥è·å–æœ€æ–°æ•°æ®ï¼Œä¸ä¾èµ–ç¼“å­˜ï¼

- âœ… åœ¨ `onLoad` ä¸­åŠ è½½æ•°æ®
- âœ… åœ¨ `onShow` ä¸­é‡æ–°åŠ è½½æ•°æ®ï¼ˆç¡®ä¿æ•°æ®æœ€æ–°ï¼‰
- âœ… ä½¿ç”¨ `DataManager.getCompleteCustomerInfo()` è·å–å®Œæ•´ä¿¡æ¯
- âŒ ä¸è¦ç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®ï¼ˆé™¤éç‰¹æ®Šæƒ…å†µï¼‰

## API è¯´æ˜

### 1. æ–°æ¥å£

```javascript
/**
 * è·å–å®¢æˆ·å’Œå¥—é¤å®Œæ•´ä¿¡æ¯
 * @param {String} deviceNo è®¾å¤‡ç¼–å·
 * @param {String} rechargeAccount å……å€¼è´¦å·ï¼ˆæ‰‹æœºå·ï¼‰
 */
API.getCustomerAndPackageByDeviceNo(deviceNo, rechargeAccount)
```

**è¯·æ±‚å‚æ•°ï¼š**
```javascript
{
  device_no: "DEV9874587563",
  recharge_account: "18795487757"
}
```

**è¿”å›æ•°æ®ï¼š**
```javascript
{
  success: true,
  data: {
    customer: { ... },           // å®¢æˆ·ä¿¡æ¯
    binding_info: { ... },       // ç»‘å®šä¿¡æ¯
    device_info: { ... },        // è®¾å¤‡ä¿¡æ¯
    package_info: { ... },       // å¥—é¤ä¿¡æ¯ï¼ˆæ–°å¢ï¼‰
    balance_info: { ... },       // ä½™é¢ä¿¡æ¯ï¼ˆæ–°å¢ï¼‰
    usage_info: { ... },         // ä½¿ç”¨æƒ…å†µï¼ˆæ–°å¢ï¼‰
    // ... æ›´å¤šå­—æ®µ
  }
}
```

### 2. ç»„åˆæ¥å£ï¼ˆæ¨èä½¿ç”¨ï¼‰

```javascript
/**
 * è·å–å®Œæ•´çš„å®¢æˆ·ä¿¡æ¯ï¼ˆè‡ªåŠ¨ç»„åˆè°ƒç”¨ï¼‰
 * @param {String} deviceCode è®¾å¤‡ç 
 */
API.getCompleteCustomerInfo(deviceCode)
```

**è°ƒç”¨æµç¨‹ï¼š**
1. è°ƒç”¨æ—§æ¥å£ `getCustomerByDeviceCode` è·å–åŸºæœ¬ä¿¡æ¯
2. ä»è¿”å›æ•°æ®ä¸­æå– `binding_info.recharge_account`
3. è°ƒç”¨æ–°æ¥å£ `getCustomerAndPackageByDeviceNo` è·å–å®Œæ•´ä¿¡æ¯
4. åˆå¹¶æ•°æ®å¹¶è¿”å›

## DataManager ä½¿ç”¨æ–¹æ³•

### æ–¹æ³•åˆ—è¡¨

#### 1. `clearCustomerCache()`
æ¸…é™¤æ‰€æœ‰å®¢æˆ·ç›¸å…³ç¼“å­˜

```javascript
const DataManager = require('../../utils/dataManager');

// æ¸…é™¤ç¼“å­˜
DataManager.clearCustomerCache();
```

#### 2. `getCompleteCustomerInfo(deviceCode, forceRefresh)`
è·å–å®Œæ•´çš„å®¢æˆ·ä¿¡æ¯

```javascript
// å¼ºåˆ¶åˆ·æ–°ï¼ˆæ¨èï¼‰
const result = await DataManager.getCompleteCustomerInfo(deviceCode, true);

// ä½¿ç”¨ç¼“å­˜ï¼ˆä¸æ¨èï¼‰
const result = await DataManager.getCompleteCustomerInfo(deviceCode, false);
```

#### 3. `loadPageData(page, deviceCode, callback)`
é¡µé¢åŠ è½½æ•°æ®çš„æ ‡å‡†æµç¨‹

```javascript
await DataManager.loadPageData(this, deviceCode, (data) => {
  // æ•°æ®åŠ è½½å®Œæˆåçš„å›è°ƒ
  this.setData({
    customerInfo: data
  });
});
```

## é¡µé¢é›†æˆç¤ºä¾‹

### ç¤ºä¾‹ 1ï¼šé¢„å……å€¼é¡µé¢ï¼ˆå®Œæ•´ç¤ºä¾‹ï¼‰

```javascript
// pages/pre-recharge/pre-recharge.js
const DataManager = require("../../utils/dataManager");

Page({
  data: {
    deviceCode: "",
    customerInfo: null,
    isLoadingCustomer: false
  },

  onLoad() {
    const device_no = wx.getStorageSync("device_no");
    this.setData({ deviceCode: device_no });
    
    // é¦–æ¬¡åŠ è½½æ•°æ®
    this.loadCustomerInfo();
  },

  onShow() {
    // æ¯æ¬¡æ˜¾ç¤ºé¡µé¢éƒ½é‡æ–°åŠ è½½æœ€æ–°æ•°æ®
    if (this.data.deviceCode) {
      this.loadCustomerInfo();
    }
  },

  async loadCustomerInfo() {
    try {
      this.setData({ isLoadingCustomer: true });
      
      // ä½¿ç”¨ DataManager è·å–å®Œæ•´ä¿¡æ¯ï¼ˆå¼ºåˆ¶åˆ·æ–°ï¼‰
      const result = await DataManager.getCompleteCustomerInfo(
        this.data.deviceCode, 
        true  // å¼ºåˆ¶åˆ·æ–°
      );
      
      if (result.success && result.data) {
        this.setData({
          customerInfo: result.data,
          isLoadingCustomer: false
        });
        
        console.log('âœ… å®¢æˆ·ä¿¡æ¯åŠ è½½æˆåŠŸ:', result.data);
      }
    } catch (error) {
      console.error('âŒ åŠ è½½å®¢æˆ·ä¿¡æ¯å¤±è´¥:', error);
      this.setData({ isLoadingCustomer: false });
      wx.showToast({
        title: 'åŠ è½½å¤±è´¥',
        icon: 'none'
      });
    }
  }
});
```

### ç¤ºä¾‹ 2ï¼šå¥—é¤è®¢è´­é¡µé¢

```javascript
// pages/package-order/package-order.js
const DataManager = require("../../utils/dataManager");

Page({
  data: {
    deviceCode: "",
    customerInfo: null,
    loading: true
  },

  onLoad() {
    const device_no = wx.getStorageSync("device_no");
    this.setData({ deviceCode: device_no });
    this.loadData();
  },

  onShow() {
    // æ¯æ¬¡æ˜¾ç¤ºéƒ½åˆ·æ–°æ•°æ®
    if (this.data.deviceCode) {
      this.loadData();
    }
  },

  async loadData() {
    try {
      this.setData({ loading: true });
      
      // ä½¿ç”¨ DataManager åŠ è½½æ•°æ®
      await DataManager.loadPageData(this, this.data.deviceCode, (data) => {
        this.setData({
          customerInfo: data,
          loading: false
        });
      });
      
      // åŠ è½½å…¶ä»–æ•°æ®ï¼ˆå¦‚å¥—é¤åˆ—è¡¨ï¼‰
      await this.loadPackages();
      
    } catch (error) {
      console.error('âŒ åŠ è½½æ•°æ®å¤±è´¥:', error);
      this.setData({ loading: false });
    }
  },

  async loadPackages() {
    // åŠ è½½å¥—é¤åˆ—è¡¨...
  }
});
```

### ç¤ºä¾‹ 3ï¼šè‡ªåŠ©ç»­è´¹é¡µé¢

```javascript
// pages/self-renewal/self-renewal.js
const DataManager = require("../../utils/dataManager");

Page({
  data: {
    deviceCode: "",
    deviceInfo: null,
    loading: true
  },

  onLoad() {
    const device_no = wx.getStorageSync("device_no");
    this.setData({ deviceCode: device_no });
    this.loadDeviceInfo();
  },

  onShow() {
    // æ¯æ¬¡æ˜¾ç¤ºéƒ½åˆ·æ–°
    if (this.data.deviceCode) {
      this.loadDeviceInfo();
    }
  },

  async loadDeviceInfo() {
    try {
      this.setData({ loading: true });
      
      const result = await DataManager.getCompleteCustomerInfo(
        this.data.deviceCode,
        true
      );
      
      if (result.success && result.data) {
        this.setData({
          deviceInfo: result.data,
          loading: false
        });
      }
    } catch (error) {
      console.error('âŒ åŠ è½½è®¾å¤‡ä¿¡æ¯å¤±è´¥:', error);
      this.setData({ loading: false });
    }
  }
});
```

## æ•°æ®ç»“æ„

### å®Œæ•´çš„å®¢æˆ·ä¿¡æ¯ç»“æ„

```javascript
{
  // å®¢æˆ·ä¿¡æ¯
  customer: {
    id: 123,
    customer_name: "å¼ ä¸‰",
    phone: "18795487757",
    id_card: "330***********1234"
  },
  
  // ç»‘å®šä¿¡æ¯
  binding_info: {
    id: 456,
    recharge_account: "18795487757",  // â­ï¸ ç”¨äºè°ƒç”¨æ–°æ¥å£
    current_package_name: "100MåŒ…æœˆå¥—é¤",
    expire_date: "2025-12-31",
    status: 1
  },
  
  // è®¾å¤‡ä¿¡æ¯
  device_info: {
    id: 789,
    device_no: "DEV9874587563",
    device_name: "5Gæµ‹è¯•è®¾å¤‡",
    device_type: "å…‰çŒ«"
  },
  
  // å¥—é¤ä¿¡æ¯ï¼ˆæ–°æ¥å£æ–°å¢ï¼‰
  package_info: {
    package_id: 101,
    package_name: "100MåŒ…æœˆå¥—é¤",
    package_price: 99.00,
    package_duration: 30,
    package_speed: "100M"
  },
  
  // ä½™é¢ä¿¡æ¯ï¼ˆæ–°æ¥å£æ–°å¢ï¼‰
  balance_info: {
    balance: 150.50,
    frozen_balance: 0,
    available_balance: 150.50
  },
  
  // ä½¿ç”¨æƒ…å†µï¼ˆæ–°æ¥å£æ–°å¢ï¼‰
  usage_info: {
    used_data: 50.5,  // GB
    total_data: 100,   // GB
    usage_percent: 50.5
  },
  
  // ä¿ç•™æ—§æ¥å£æ•°æ®ä½œä¸ºå¤‡ä»½
  _basic: {
    customer: { ... },
    binding_info: { ... },
    device_info: { ... }
  }
}
```

## ç¼“å­˜é”®åˆ—è¡¨

ä»¥ä¸‹ç¼“å­˜é”®ä¼šè¢« `clearCustomerCache()` æ¸…é™¤ï¼š

```javascript
[
  'customer_info',
  'binding_info',
  'device_info',
  'complete_customer_info',
  'device_no',
  'device_name',
  'customer_name',
  'recharge_account',
  'current_package'
]
```

## æœ€ä½³å®è·µ

### âœ… æ¨èåšæ³•

1. **æ¯æ¬¡è¿›å…¥é¡µé¢éƒ½åˆ·æ–°æ•°æ®**
   ```javascript
   onShow() {
     if (this.data.deviceCode) {
       this.loadCustomerInfo();
     }
   }
   ```

2. **ä½¿ç”¨ DataManager è·å–æ•°æ®**
   ```javascript
   const result = await DataManager.getCompleteCustomerInfo(deviceCode, true);
   ```

3. **ç»Ÿä¸€é”™è¯¯å¤„ç†**
   ```javascript
   try {
     const result = await DataManager.getCompleteCustomerInfo(deviceCode, true);
     // å¤„ç†æ•°æ®...
   } catch (error) {
     console.error('åŠ è½½å¤±è´¥:', error);
     wx.showToast({ title: 'åŠ è½½å¤±è´¥', icon: 'none' });
   }
   ```

### âŒ ä¸æ¨èåšæ³•

1. **ç›´æ¥ä½¿ç”¨ç¼“å­˜æ•°æ®**
   ```javascript
   // âŒ ä¸æ¨è
   const customerInfo = wx.getStorageSync('customer_info');
   ```

2. **åªåœ¨ onLoad ä¸­åŠ è½½æ•°æ®**
   ```javascript
   // âŒ ä¸æ¨è - æ•°æ®å¯èƒ½è¿‡æœŸ
   onLoad() {
     this.loadData();
   }
   // ç¼ºå°‘ onShow åˆ·æ–°
   ```

3. **ç›´æ¥è°ƒç”¨æ—§æ¥å£**
   ```javascript
   // âŒ ä¸æ¨è - æ•°æ®ä¸å®Œæ•´
   const result = await API.getCustomerByDeviceCode(deviceCode);
   ```

## è¿ç§»æŒ‡å—

### éœ€è¦æ›´æ–°çš„é¡µé¢åˆ—è¡¨

ä»¥ä¸‹é¡µé¢éœ€è¦æ›´æ–°ä¸ºä½¿ç”¨æ–°çš„æ•°æ®ç®¡ç†ç³»ç»Ÿï¼š

- [x] âœ… `pages/pre-recharge/pre-recharge.js` - å·²æ›´æ–°
- [ ] `pages/package-order/package-order.js`
- [ ] `pages/self-renewal/self-renewal.js`
- [ ] `pages/my-bill/my-bill.js`
- [ ] `pages/invoice/invoice.js`
- [ ] `pages/change-transfer/change-transfer.js`
- [ ] `pages/my/my.js`
- [ ] `pages/home/home.js`

### è¿ç§»æ­¥éª¤

1. **å¼•å…¥ DataManager**
   ```javascript
   const DataManager = require("../../utils/dataManager");
   ```

2. **æ›¿æ¢æ•°æ®åŠ è½½æ–¹æ³•**
   ```javascript
   // æ—§ä»£ç 
   const result = await API.getCustomerByDeviceCode(deviceCode);
   
   // æ–°ä»£ç 
   const result = await DataManager.getCompleteCustomerInfo(deviceCode, true);
   ```

3. **æ·»åŠ  onShow åˆ·æ–°**
   ```javascript
   onShow() {
     if (this.data.deviceCode) {
       this.loadCustomerInfo();
     }
   }
   ```

4. **æµ‹è¯•éªŒè¯**
   - æ£€æŸ¥æ§åˆ¶å°æ—¥å¿—ï¼Œç¡®è®¤è°ƒç”¨äº†æ–°æ¥å£
   - éªŒè¯æ•°æ®å®Œæ•´æ€§
   - æµ‹è¯•é¡µé¢åˆ‡æ¢æ—¶æ•°æ®åˆ·æ–°

## è°ƒè¯•æŠ€å·§

### æŸ¥çœ‹æ—¥å¿—

```javascript
// æŸ¥çœ‹å®Œæ•´çš„æ•°æ®è·å–æµç¨‹
ğŸ“ è°ƒç”¨æ—§æ¥å£è·å–åŸºæœ¬ä¿¡æ¯...
ğŸ“ è°ƒç”¨æ–°æ¥å£è·å–å®Œæ•´ä¿¡æ¯... { deviceCode: "DEV...", rechargeAccount: "187..." }
âœ… æ–°æ¥å£è¿”å›å®Œæ•´æ•°æ®
ğŸ’¾ ä¿å­˜å®¢æˆ·ä¿¡æ¯åˆ°ç¼“å­˜...
âœ… å®¢æˆ·ä¿¡æ¯å·²ä¿å­˜åˆ°ç¼“å­˜
```

### å¸¸è§é—®é¢˜

**Q: æ–°æ¥å£è°ƒç”¨å¤±è´¥æ€ä¹ˆåŠï¼Ÿ**
A: ç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§ä½¿ç”¨æ—§æ¥å£æ•°æ®ï¼Œä¸å½±å“åŸºæœ¬åŠŸèƒ½ã€‚

**Q: å¦‚ä½•ç¡®è®¤ä½¿ç”¨äº†æ–°æ¥å£ï¼Ÿ**
A: æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—ï¼Œåº”è¯¥çœ‹åˆ° "ğŸ“ è°ƒç”¨æ–°æ¥å£è·å–å®Œæ•´ä¿¡æ¯..." çš„æ—¥å¿—ã€‚

**Q: ç¼“å­˜ä½•æ—¶è¢«æ¸…é™¤ï¼Ÿ**
A: æ¯æ¬¡è°ƒç”¨ `getCompleteCustomerInfo(deviceCode, true)` æ—¶ä¼šè‡ªåŠ¨æ¸…é™¤ç¼“å­˜ã€‚

## æ€»ç»“

- âœ… ä½¿ç”¨ `DataManager.getCompleteCustomerInfo()` è·å–å®Œæ•´æ•°æ®
- âœ… æ¯æ¬¡ `onShow` éƒ½é‡æ–°åŠ è½½æ•°æ®
- âœ… å¼ºåˆ¶åˆ·æ–°å‚æ•°è®¾ä¸º `true`
- âœ… ç»Ÿä¸€é”™è¯¯å¤„ç†
- âŒ ä¸è¦ä¾èµ–ç¼“å­˜æ•°æ®
- âŒ ä¸è¦åªåœ¨ `onLoad` ä¸­åŠ è½½æ•°æ®

è¿™æ ·å¯ä»¥ç¡®ä¿ç”¨æˆ·å§‹ç»ˆçœ‹åˆ°æœ€æ–°ã€æœ€å®Œæ•´çš„æ•°æ®ï¼ğŸ‰
