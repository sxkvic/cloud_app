# æ–°æ—§æ¥å£å­—æ®µå¯¹ç…§è¡¨

## é—®é¢˜è¯´æ˜

æ–°æ¥å£ `/api/v1/wx/getCustomerAndPackageByDeviceNo` è¿”å›çš„å­—æ®µåä¸æ—§æ¥å£ä¸åŒï¼Œå¯¼è‡´é¡µé¢æ— æ³•æ­£ç¡®è¯»å–æ•°æ®ã€‚

## å­—æ®µå¯¹ç…§

### è®¾å¤‡ä¿¡æ¯

| æ—§æ¥å£å­—æ®µ | æ–°æ¥å£å­—æ®µ | è¯´æ˜ |
|-----------|-----------|------|
| `device_info` | `device` | è®¾å¤‡è¯¦ç»†ä¿¡æ¯ |
| `device_info.device_no` | `device.device_no` | è®¾å¤‡ç¼–å· |
| `device_info.device_name` | `device.device_name` | è®¾å¤‡åç§° |
| `device_info.id` | `device.id` | è®¾å¤‡ID |

### å¥—é¤ä¿¡æ¯

| æ—§æ¥å£å­—æ®µ | æ–°æ¥å£å­—æ®µ | è¯´æ˜ |
|-----------|-----------|------|
| âŒ æ—  | `package` | å¥—é¤è¯¦ç»†ä¿¡æ¯ï¼ˆæ–°å¢ï¼‰ |
| âŒ æ—  | `package.package_id` | å¥—é¤ID |
| âŒ æ—  | `package.package_name` | å¥—é¤åç§° |
| âŒ æ—  | `package.price` | å¥—é¤ä»·æ ¼ |
| âŒ æ—  | `package.flow` | å¥—é¤æµé‡ |

### è´¦æˆ·ä½™é¢ä¿¡æ¯

| æ—§æ¥å£å­—æ®µ | æ–°æ¥å£å­—æ®µ | è¯´æ˜ |
|-----------|-----------|------|
| âŒ æ—  | `account` | è´¦æˆ·ä¿¡æ¯ï¼ˆæ–°å¢ï¼‰ |
| âŒ æ—  | `account.id` | è´¦æˆ·ID |
| âŒ æ—  | `account.balance` | è´¦æˆ·ä½™é¢ |
| âŒ æ—  | `account.created_at` | åˆ›å»ºæ—¶é—´ |
| âŒ æ—  | `account.updated_at` | æ›´æ–°æ—¶é—´ |

### å®¢æˆ·ä¿¡æ¯ï¼ˆä¿æŒä¸€è‡´ï¼‰

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `customer` | å®¢æˆ·è¯¦ç»†ä¿¡æ¯ |
| `customer.id` | å®¢æˆ·ID |
| `customer.customer_name` | å®¢æˆ·åç§° |
| `customer.contact_person` | è”ç³»äºº |
| `customer.contact_phone` | è”ç³»ç”µè¯ |

### ç»‘å®šä¿¡æ¯ï¼ˆä¿æŒä¸€è‡´ï¼‰

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `binding_info` | ç»‘å®šä¿¡æ¯ |
| `binding_info.id` | ç»‘å®šID |
| `binding_info.customer_id` | å®¢æˆ·ID |
| `binding_info.device_id` | è®¾å¤‡ID |
| `binding_info.recharge_account` | å……å€¼è´¦å· |
| `binding_info.status` | çŠ¶æ€ |

## æ•°æ®åˆå¹¶ç­–ç•¥

### åˆå¹¶åçš„ç»Ÿä¸€æ•°æ®ç»“æ„

```javascript
{
  // åŸºæœ¬ä¿¡æ¯ï¼ˆæ—§æ¥å£ï¼‰
  customer: { ... },
  binding_info: { ... },
  device_info: { ... },
  
  // æ–°æ¥å£æ•°æ®ï¼ˆæ–°å­—æ®µåï¼‰
  device: { ... },
  package: { ... },
  account: { ... },
  
  // å…¼å®¹å­—æ®µï¼ˆå‘åå…¼å®¹ï¼‰
  package_info: { ... },  // æŒ‡å‘ package
  balance_info: {         // ä» account è½¬æ¢
    balance: "0.01",
    available_balance: "0.01"
  },
  
  // å¤‡ä»½æ•°æ®
  _basic: { ... },  // æ—§æ¥å£åŸå§‹æ•°æ®
  _new: { ... }     // æ–°æ¥å£åŸå§‹æ•°æ®
}
```

## æ–°æ¥å£è¿”å›ç¤ºä¾‹

```javascript
{
  success: true,
  message: "æˆåŠŸè·å–å®¢æˆ·ã€è®¾å¤‡ã€å¥—é¤å’Œè´¦æˆ·ä¿¡æ¯",
  data: {
    // è´¦æˆ·ä¿¡æ¯ï¼ˆæ–°å¢ï¼‰
    account: {
      id: 34,
      balance: "0.01",
      created_at: "2025-12-07 15:24:27",
      updated_at: "2025-12-07 16:26:54"
    },
    
    // ç»‘å®šä¿¡æ¯
    binding_info: {
      id: 45,
      customer_id: 44,
      device_id: 40,
      recharge_account: "18701684408",
      status: "1",
      created_at: "2025-12-07 15:24:27"
    },
    
    // å®¢æˆ·ä¿¡æ¯
    customer: {
      id: 44,
      customer_name: "è¾½å®ç™¾è‰ç›Šå¯¿ä¸­è¯æˆ¿è¿é”æœ‰é™å…¬å¸",
      contact_person: "æ–½å…´ç§‘",
      contact_phone: "18701684408",
      city: "æ²³åŒ—çœ/é‚¯éƒ¸å¸‚",
      id_number: "9875548754789EKG",
      install_address: "111",
      install_requirement: "å®‰è£…åœ¨é—¨åº—",
      status: "2",
      user_type: 2,
      created_at: "2025-12-04 10:00:15",
      updated_at: "2025-12-07 15:24:27"
    },
    
    // è®¾å¤‡ä¿¡æ¯ï¼ˆå­—æ®µåï¼šdeviceï¼‰
    device: {
      id: 40,
      device_no: "DVO090909",
      device_name: "æµ‹è¯•è®¾å¤‡",
      device_type: "",
      status: "2",
      created_at: "2025-12-07 15:24:14",
      updated_at: "2025-12-07 15:25:12"
    },
    
    // å¥—é¤ä¿¡æ¯ï¼ˆæ–°å¢ï¼‰
    package: {
      package_id: 19,
      package_name: "æµ‹è¯•åŒ…æœˆå¡--1å¤©",
      package_type: "0",
      order_amount: "0.01",
      flow: "1000M",
      order_time: "2025-12-07 16:26:08",
      payment_status: 2,
      price: "0.01",
      remark: "æµ‹è¯•ç”¨çš„æµé‡å¡"
    }
  }
}
```

## ä¿®å¤æ–¹æ¡ˆ

### 1. API å±‚é¢ï¼ˆutils/api.jsï¼‰

```javascript
async getCompleteCustomerInfo(deviceCode) {
  // è°ƒç”¨æ—§æ¥å£
  const basicResult = await this.getCustomerByDeviceCode(deviceCode);
  
  // è°ƒç”¨æ–°æ¥å£
  const completeResult = await this.getCustomerAndPackageByDeviceNo(
    deviceCode, 
    rechargeAccount
  );
  
  // åˆå¹¶æ•°æ®ï¼Œå¤„ç†å­—æ®µåå·®å¼‚
  const mergedData = {
    // åŸºæœ¬ä¿¡æ¯
    customer: basicResult.data.customer,
    binding_info: basicResult.data.binding_info,
    device_info: basicResult.data.device_info,
    
    // æ–°æ¥å£æ•°æ®
    device: newData.device,
    package: newData.package,
    account: newData.account,
    
    // å…¼å®¹å­—æ®µ
    package_info: newData.package,
    balance_info: {
      balance: newData.account.balance,
      available_balance: newData.account.balance
    },
    
    // å¤‡ä»½
    _basic: basicResult.data,
    _new: newData
  };
  
  return { success: true, data: mergedData };
}
```

### 2. ç¼“å­˜å±‚é¢ï¼ˆutils/dataManager.jsï¼‰

```javascript
function saveCustomerInfoToCache(data) {
  // ä¿å­˜å®Œæ•´æ•°æ®
  wx.setStorageSync('complete_customer_info', data);
  
  // å…¼å®¹æ—§å­—æ®µå
  const deviceData = data.device_info || data.device;
  if (deviceData) {
    wx.setStorageSync('device_info', deviceData);
  }
  
  // ä¿å­˜æ–°å­—æ®µ
  if (data.package) {
    wx.setStorageSync('package_info', data.package);
  }
  
  if (data.account) {
    wx.setStorageSync('account_info', data.account);
    wx.setStorageSync('balance', data.account.balance);
  }
}
```

### 3. é¡µé¢ä½¿ç”¨ï¼ˆæ¨èæ–¹å¼ï¼‰

```javascript
// è·å–å®Œæ•´æ•°æ®
const customerInfo = wx.getStorageSync('complete_customer_info');

// è®¿é—®è®¾å¤‡ä¿¡æ¯ï¼ˆå…¼å®¹æ–°æ—§å­—æ®µï¼‰
const deviceNo = customerInfo.device_info?.device_no || 
                 customerInfo.device?.device_no;

// è®¿é—®å¥—é¤ä¿¡æ¯ï¼ˆæ–°å­—æ®µï¼‰
const packageName = customerInfo.package?.package_name;
const packagePrice = customerInfo.package?.price;

// è®¿é—®ä½™é¢ä¿¡æ¯ï¼ˆæ–°å­—æ®µï¼‰
const balance = customerInfo.account?.balance;
```

## å‘åå…¼å®¹æ€§

### æ—§ä»£ç ä»ç„¶å¯ç”¨

```javascript
// âœ… æ—§ä»£ç ç»§ç»­å·¥ä½œ
const deviceInfo = customerInfo.device_info;
const deviceNo = deviceInfo.device_no;

// âœ… æ–°å­—æ®µä¹Ÿå¯ç”¨
const device = customerInfo.device;
const packageInfo = customerInfo.package;
const account = customerInfo.account;
```

### æ¨èä½¿ç”¨æ–¹å¼

```javascript
// æ¨èï¼šä¼˜å…ˆä½¿ç”¨æ–°å­—æ®µï¼Œé™çº§åˆ°æ—§å­—æ®µ
const deviceData = customerInfo.device || customerInfo.device_info;
const deviceNo = deviceData?.device_no;
```

## ç¼“å­˜é”®åˆ—è¡¨

### æ›´æ–°åçš„ç¼“å­˜é”®

```javascript
const CACHE_KEYS = [
  // åŸºæœ¬ä¿¡æ¯
  'customer_info',
  'binding_info',
  'device_info',
  'complete_customer_info',
  
  // å•ç‹¬å­—æ®µ
  'device_no',
  'device_name',
  'customer_name',
  'recharge_account',
  'current_package',
  
  // æ–°å¢å­—æ®µ
  'package_info',
  'account_info',
  'balance'
];
```

## æµ‹è¯•éªŒè¯

### éªŒè¯æ¸…å•

- [x] âœ… ç™»å½•æ—¶æ­£ç¡®è·å–æ–°æ¥å£æ•°æ®
- [x] âœ… æ•°æ®æ­£ç¡®åˆå¹¶ï¼ŒåŒ…å«æ–°æ—§å­—æ®µ
- [x] âœ… ç¼“å­˜æ­£ç¡®ä¿å­˜æ‰€æœ‰å­—æ®µ
- [x] âœ… é¡µé¢èƒ½æ­£å¸¸è¯»å– device_info
- [x] âœ… é¡µé¢èƒ½æ­£å¸¸è¯»å– package
- [x] âœ… é¡µé¢èƒ½æ­£å¸¸è¯»å– account
- [ ] å¥—é¤è®¢è´­é¡µé¢åŠŸèƒ½æ­£å¸¸
- [ ] è‡ªåŠ©ç»­è´¹é¡µé¢åŠŸèƒ½æ­£å¸¸
- [ ] é¢„å……å€¼é¡µé¢åŠŸèƒ½æ­£å¸¸

## æ€»ç»“

é€šè¿‡åœ¨ API å±‚é¢è¿›è¡Œæ•°æ®åˆå¹¶å’Œå­—æ®µåè½¬æ¢ï¼Œç¡®ä¿ï¼š

1. âœ… **å‘åå…¼å®¹** - æ—§ä»£ç ç»§ç»­å·¥ä½œ
2. âœ… **æ–°åŠŸèƒ½å¯ç”¨** - å¯ä»¥ä½¿ç”¨æ–°æ¥å£çš„é¢å¤–æ•°æ®
3. âœ… **ç»Ÿä¸€æ¥å£** - é¡µé¢æ— éœ€å…³å¿ƒæ•°æ®æ¥æº
4. âœ… **é™çº§å¤„ç†** - æ–°æ¥å£å¤±è´¥æ—¶è‡ªåŠ¨ä½¿ç”¨æ—§æ¥å£æ•°æ®

æ‰€æœ‰æ”¹åŠ¨éƒ½åœ¨åº•å±‚å®Œæˆï¼Œä¸šåŠ¡é¡µé¢æ— éœ€ä¿®æ”¹ï¼ğŸ‰
