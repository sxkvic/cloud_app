# 写死设备码清理记录

## 修改日期
2025-11-27

## 背景
项目中多个页面使用了写死的测试设备码 `DEV00845211`，需要改为从本地缓存读取用户真实绑定的设备信息。

## 修改的文件

### 1. 预充值页面
**文件**: `pages/pre-recharge/pre-recharge.js`

**修改前**:
```javascript
data: {
    deviceCode: 'DEV00845211', // 使用固定设备码
    ...
},

onLoad() {
    console.log('预充值页面加载');
    // 获取全局设备码
    if (app.globalData.deviceCode) {
        this.setData({
            deviceCode: app.globalData.deviceCode
        });
    }
    this.loadCustomerInfo();
}
```

**修改后**:
```javascript
data: {
    deviceCode: '', // 设备编号，从缓存读取
    ...
},

onLoad() {
    console.log('预充值页面加载');
    
    // 从本地缓存读取设备编号
    const device_no = wx.getStorageSync('device_no') || wx.getStorageSync('deviceCode');
    
    if (!device_no) {
        message.error('未找到设备信息，请先绑定设备');
        setTimeout(() => {
            navigation.navigateTo('/pages/bind-device-code/bind-device-code');
        }, 1500);
        return;
    }
    
    this.setData({ deviceCode: device_no });
    console.log('读取到设备编号:', device_no);
    
    this.loadCustomerInfo();
}
```

### 2. 套餐订购页面
**文件**: `pages/package-order/package-order.js`

**修改前**:
```javascript
data: {
    deviceCode: 'DEV00845211',  // 调试用固定设备码
    customerInfo: null,
    isLoadingCustomer: false
},

async onLoad() {
    console.log('套餐订购页面加载');
    await this.loadPackages();
    await this.loadCustomerInfo();
}
```

**修改后**:
```javascript
data: {
    deviceCode: '',              // 设备编号，从缓存读取
    customerInfo: null,
    isLoadingCustomer: false
},

async onLoad() {
    console.log('套餐订购页面加载');
    
    // 从本地缓存读取设备编号
    const device_no = wx.getStorageSync('device_no') || wx.getStorageSync('deviceCode');
    
    if (!device_no) {
        message.error('未找到设备信息，请先绑定设备');
        setTimeout(() => {
            navigation.navigateTo('/pages/bind-device-code/bind-device-code');
        }, 1500);
        return;
    }
    
    this.setData({ deviceCode: device_no });
    console.log('读取到设备编号:', device_no);
    
    await this.loadPackages();
    await this.loadCustomerInfo();
}
```

### 3. 我的账单页面
**文件**: `pages/my-bill/my-bill.js`

**修改前**:
```javascript
data: {
    bills: [],
    loading: true,
    deviceCode: 'DEV00845211',  // 调试用固定设备码
    customerInfo: null,
    billDetail: null,
    showDetail: false
},

async onLoad() {
    console.log('我的账单页面加载');
    await this.loadCustomerInfo();
    await this.loadBills();
}
```

**修改后**:
```javascript
data: {
    bills: [],
    loading: true,
    deviceCode: '',              // 设备编号，从缓存读取
    customerInfo: null,
    billDetail: null,
    showDetail: false
},

async onLoad() {
    console.log('我的账单页面加载');
    
    // 从本地缓存读取设备编号
    const device_no = wx.getStorageSync('device_no') || wx.getStorageSync('deviceCode');
    
    if (!device_no) {
        message.error('未找到设备信息，请先绑定设备');
        setTimeout(() => {
            navigation.navigateTo('/pages/bind-device-code/bind-device-code');
        }, 1500);
        return;
    }
    
    this.setData({ deviceCode: device_no });
    console.log('读取到设备编号:', device_no);
    
    await this.loadCustomerInfo();
    await this.loadBills();
}
```

## 修改要点

### 1. 数据初始化
- 将 `deviceCode` 初始值从写死的 `'DEV00845211'` 改为空字符串 `''`
- 添加注释说明"从缓存读取"

### 2. 读取逻辑
```javascript
// 优先读取 device_no，如果没有则读取 deviceCode（兼容旧版本）
const device_no = wx.getStorageSync('device_no') || wx.getStorageSync('deviceCode');
```

### 3. 容错处理
如果未找到设备信息：
- 显示错误提示："未找到设备信息，请先绑定设备"
- 1.5秒后自动跳转到设备绑定页面
- 终止当前页面的后续加载

### 4. 日志输出
添加日志便于调试：
```javascript
console.log('读取到设备编号:', device_no);
```

## 数据来源

设备信息来自设备绑定流程（`pages/bind-device-code/bind-device-code.js`）：

```javascript
// 绑定成功后存储
wx.setStorageSync('device_no', device_info?.device_no || deviceCode);
wx.setStorageSync('device_info', device_info);
wx.setStorageSync('customer_info', customer);
wx.setStorageSync('binding_info', binding_info);
```

## 影响范围

### 直接影响
- ✅ 预充值功能 - 使用真实设备信息创建订单
- ✅ 套餐订购功能 - 使用真实客户和设备信息
- ✅ 我的账单功能 - 查询真实设备的账单数据

### 间接影响
- ✅ 服务评价功能 - 已在之前修改中使用缓存数据
- ✅ 投诉管理功能 - 可以使用相同方式读取设备信息

## 测试建议

1. **绑定设备后测试**
   - 绑定设备后，进入预充值/套餐订购/我的账单页面
   - 验证是否正确读取到设备编号
   - 验证是否能正常加载客户信息

2. **未绑定设备测试**
   - 清除本地缓存
   - 直接进入预充值/套餐订购/我的账单页面
   - 验证是否显示错误提示
   - 验证是否自动跳转到绑定页面

3. **多设备切换测试**
   - 绑定设备A，使用各功能
   - 解绑后绑定设备B
   - 验证是否正确切换到设备B的数据

## 注意事项

1. **向后兼容**: 代码同时支持读取 `device_no` 和 `deviceCode`，兼容旧版本
2. **错误处理**: 所有页面都添加了设备信息缺失的容错处理
3. **用户体验**: 未绑定设备时会自动引导用户去绑定
4. **数据一致性**: 所有页面使用相同的数据源（本地缓存）

## 相关文档

- [设备信息存储方案.md](./设备信息存储方案.md)
- [API接口文档.md](./API接口文档.md)
