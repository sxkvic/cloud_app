# 开票系统API接口文档

## 目录
- [一、概述](#一概述)
- [二、发票管理接口](#二发票管理接口)
- [三、开票信息管理接口](#三开票信息管理接口)
- [四、数据模型](#四数据模型)
- [五、调用示例](#五调用示例)
- [六、错误处理](#六错误处理)

---

## 一、概述

### 基础信息
- **Base URL**: `/api/v1/invoices`
- **认证方式**: 所有接口需要 `combinedAuthMiddleware` 认证
- **Content-Type**: `application/json`
- **字符编码**: UTF-8

### 认证说明
所有请求需要在Header中携带认证Token：
```
Authorization: Bearer <your_token>
```

---

## 二、发票管理接口

### 2.1 初始化发票表

**接口说明**: 创建发票相关数据库表

**请求方式**: `POST`

**接口路径**: `/api/v1/invoices/initialize`

**请求参数**: 无

**请求示例**:
```javascript
POST /api/v1/invoices/initialize
Headers: {
  "Authorization": "Bearer <token>",
  "Content-Type": "application/json"
}
Body: {}
```

**响应示例**:
```json
{
  "success": true,
  "message": "发票表和开票信息表初始化成功"
}
```

---

### 2.2 为订单创建发票 ⭐核心接口

**接口说明**: 为订单创建发票记录，支持普通订单和预充值订单

**请求方式**: `POST`

**接口路径**: `/api/v1/invoices/createInvoiceForOrder`

**业务流程**:
1. 根据订单号查询订单信息（支持普通订单和预充值订单）
2. 根据设备号获取开票信息
3. 下载发票文件并上传到OSS
4. 创建或更新发票记录
5. 更新订单开票状态
6. 使用事务确保数据一致性

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| orderNo | String | 是 | 订单编号 |
| fileDownloadUrl | String | 是 | 发票PDF文件下载链接 |

**请求示例**:
```javascript
POST /api/v1/invoices/createInvoiceForOrder
Headers: {
  "Authorization": "Bearer <token>",
  "Content-Type": "application/json"
}
Body: {
  "orderNo": "ORD20231128001",
  "fileDownloadUrl": "https://example.com/invoice.pdf"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "发票记录创建成功",
  "data": {
    "id": 1,
    "order_no": "ORD20231128001",
    "order_id": 123,
    "device_no": "DEV001",
    "customer_name": "张三",
    "order_amount": 1000.00,
    "invoice_title": "某某公司",
    "invoice_type": 1,
    "social_credit_code": "91110000...",
    "receive_email": "user@example.com",
    "bank_name": "中国银行",
    "bank_account": "6222...",
    "invoice_status": 2,
    "fileid": 456,
    "fileurl": "https://oss.example.com/invoice.pdf",
    "email_sent": 1,
    "created_at": "2023-11-28 10:00:00",
    "updated_at": "2023-11-28 10:00:00"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "处理发票失败",
  "details": "订单编号不能为空"
}
```

---

### 2.3 发送发票到用户邮箱

**接口说明**: 将发票PDF文件发送到指定邮箱

**请求方式**: `POST`

**接口路径**: `/api/v1/invoices/sendInvoiceEmail`

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| orderNo | String | 是 | 订单编号 |
| email | String | 是 | 收件人邮箱地址 |

**请求示例**:
```javascript
POST /api/v1/invoices/sendInvoiceEmail
Headers: {
  "Authorization": "Bearer <token>",
  "Content-Type": "application/json"
}
Body: {
  "orderNo": "ORD20231128001",
  "email": "user@example.com"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "发票邮件重新发送成功",
  "data": {
    "email": "user@example.com",
    "orderNo": "ORD20231128001",
    "customerName": "张三"
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "message": "邮箱格式不正确"
}
```

---

### 2.4 获取订单的发票信息

**接口说明**: 根据订单号查询发票信息

**请求方式**: `GET`

**接口路径**: `/api/v1/invoices/getOrderByOrderNo/:orderNo`

**请求参数**:

| 参数名 | 类型 | 必填 | 位置 | 说明 |
|--------|------|------|------|------|
| orderNo | String | 是 | Path | 订单编号 |

**请求示例**:
```javascript
GET /api/v1/invoices/getOrderByOrderNo/ORD20231128001
Headers: {
  "Authorization": "Bearer <token>"
}
```

**响应示例（有发票）**:
```json
{
  "success": true,
  "message": "获取发票信息成功",
  "data": {
    "id": 1,
    "order_no": "ORD20231128001",
    "order_id": 123,
    "device_no": "DEV001",
    "customer_name": "张三",
    "order_amount": 1000.00,
    "invoice_title": "某某公司",
    "invoice_type": 1,
    "invoice_status": 2,
    "fileurl": "https://oss.example.com/invoice.pdf"
  }
}
```

**响应示例（无发票）**:
```json
{
  "success": true,
  "message": "该订单尚未创建发票",
  "data": null
}
```

---

### 2.5 获取发票列表

**接口说明**: 分页查询发票列表，支持多条件筛选

**请求方式**: `GET`

**接口路径**: `/api/v1/invoices/getInvoiceList`

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| page | Number | 否 | 1 | 页码 |
| limit | Number | 否 | 10 | 每页数量（最大100） |
| customer_name | String | 否 | - | 客户名称（模糊搜索） |
| device_no | String | 否 | - | 设备号（模糊搜索） |
| invoice_status | Number | 否 | - | 发票状态（1：未开，2：已开） |

**请求示例**:
```javascript
GET /api/v1/invoices/getInvoiceList?page=1&limit=10&customer_name=张三&invoice_status=2
Headers: {
  "Authorization": "Bearer <token>"
}
```

**响应示例**:
```json
{
  "success": true,
  "data": {
    "list": [
      {
        "id": 1,
        "order_id": 123,
        "order_no": "ORD20231128001",
        "customer_name": "张三",
        "device_no": "DEV001",
        "package_name": "套餐A",
        "order_amount": 1000.00,
        "invoice_title": "某某公司",
        "invoice_type": 1,
        "invoice_type_text": "普专",
        "social_credit_code": "91110000...",
        "receive_email": "user@example.com",
        "invoice_status": 2,
        "invoice_status_text": "已开",
        "email_sent": 1,
        "fileid": 456,
        "created_by": "admin",
        "created_at": "2023-11-28 10:00:00",
        "updated_at": "2023-11-28 10:00:00"
      }
    ],
    "pagination": {
      "current_page": 1,
      "page_size": 10,
      "total": 100,
      "total_pages": 10
    }
  }
}
```

---

## 三、开票信息管理接口

### 3.1 创建或更新开票信息

**接口说明**: 创建新的开票信息或更新已有的开票信息（根据设备号或客户ID判断）

**请求方式**: `POST`

**接口路径**: `/api/v1/invoices/invoice-info/createOrUpdateInvoiceInfo`

**请求参数**:

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| customer_name | String | 是 | 客户名称 |
| invoice_title | String | 是 | 发票抬头 |
| invoice_type | Number | 否 | 发票类型（1：增值税普票，2：增值税专票） |
| device_no | String | 否 | 设备号 |
| customer_id | Number | 否 | 客户ID |
| title_type | String | 否 | 抬头类型 |
| social_credit_code | String | 否 | 统一社会信用代码 |
| receive_email | String | 否 | 收件邮箱 |
| bank_name | String | 否 | 开户银行 |
| bank_account | String | 否 | 银行账号 |

**请求示例**:
```javascript
POST /api/v1/invoices/invoice-info/createOrUpdateInvoiceInfo
Headers: {
  "Authorization": "Bearer <token>",
  "Content-Type": "application/json"
}
Body: {
  "customer_name": "张三",
  "invoice_title": "某某公司",
  "invoice_type": 1,
  "device_no": "DEV001",
  "customer_id": 123,
  "social_credit_code": "91110000...",
  "receive_email": "user@example.com",
  "bank_name": "中国银行",
  "bank_account": "6222..."
}
```

**响应示例（创建）**:
```json
{
  "success": true,
  "message": "开票信息创建成功",
  "data": {
    "id": 1,
    "device_no": "DEV001",
    "customer_id": 123,
    "customer_name": "张三",
    "invoice_title": "某某公司",
    "invoice_type": 1,
    "social_credit_code": "91110000...",
    "bank_name": "中国银行",
    "bank_account": "6222...",
    "receive_email": "user@example.com",
    "created_at": "2023-11-28 10:00:00",
    "updated_at": "2023-11-28 10:00:00"
  }
}
```

**响应示例（更新）**:
```json
{
  "success": true,
  "message": "开票信息更新成功",
  "data": { /* 同上 */ }
}
```

---

### 3.2 根据设备号获取开票信息

**接口说明**: 根据设备号查询开票信息

**请求方式**: `GET`

**接口路径**: `/api/v1/invoices/invoice-info/device/:device_no`

**请求参数**:

| 参数名 | 类型 | 必填 | 位置 | 说明 |
|--------|------|------|------|------|
| device_no | String | 是 | Path | 设备号 |

**请求示例**:
```javascript
GET /api/v1/invoices/invoice-info/device/DEV001
Headers: {
  "Authorization": "Bearer <token>"
}
```

**响应示例（有数据）**:
```json
{
  "success": true,
  "message": "获取开票信息成功",
  "data": {
    "id": 1,
    "device_no": "DEV001",
    "customer_id": 123,
    "customer_name": "张三",
    "invoice_title": "某某公司",
    "invoice_type": 1,
    "social_credit_code": "91110000...",
    "bank_name": "中国银行",
    "bank_account": "6222...",
    "receive_email": "user@example.com",
    "created_at": "2023-11-28 10:00:00",
    "updated_at": "2023-11-28 10:00:00"
  }
}
```

**响应示例（无数据）**:
```json
{
  "success": true,
  "message": "获取开票信息成功",
  "data": null
}
```

---

### 3.3 根据客户ID获取开票信息

**接口说明**: 根据客户ID查询开票信息

**请求方式**: `GET`

**接口路径**: `/api/v1/invoices/invoice-info/customer/:customer_id`

**请求参数**:

| 参数名 | 类型 | 必填 | 位置 | 说明 |
|--------|------|------|------|------|
| customer_id | Number | 是 | Path | 客户ID |

**请求示例**:
```javascript
GET /api/v1/invoices/invoice-info/customer/123
Headers: {
  "Authorization": "Bearer <token>"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取开票信息成功",
  "data": {
    "id": 1,
    "device_no": "DEV001",
    "customer_id": 123,
    "customer_name": "张三",
    "invoice_title": "某某公司",
    "invoice_type": 1
  }
}
```

**错误响应**:
```json
{
  "success": false,
  "error": "开票信息不存在",
  "details": "找不到客户ID为123的开票信息"
}
```

---

### 3.4 获取开票信息列表

**接口说明**: 分页查询开票信息列表，支持关键词搜索

**请求方式**: `GET`

**接口路径**: `/api/v1/invoices/invoice-info/list`

**请求参数**:

| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| page | Number | 否 | 1 | 页码 |
| pageSize | Number | 否 | 10 | 每页数量（最大100） |
| keyword | String | 否 | - | 搜索关键词（匹配设备号、客户名称、发票抬头） |

**请求示例**:
```javascript
GET /api/v1/invoices/invoice-info/list?page=1&pageSize=10&keyword=张三
Headers: {
  "Authorization": "Bearer <token>"
}
```

**响应示例**:
```json
{
  "success": true,
  "message": "获取开票信息列表成功",
  "data": {
    "list": [
      {
        "id": 1,
        "device_no": "DEV001",
        "customer_id": 123,
        "customer_name": "张三",
        "invoice_title": "某某公司",
        "invoice_type": 1,
        "invoice_type_text": "增值税普票",
        "social_credit_code": "91110000...",
        "bank_name": "中国银行",
        "bank_account": "6222...",
        "receive_email": "user@example.com",
        "created_at": "2023-11-28 10:00:00",
        "updated_at": "2023-11-28 10:00:00"
      }
    ],
    "pagination": {
      "current_page": 1,
      "page_size": 10,
      "total": 50,
      "total_pages": 5
    }
  }
}
```

---

### 3.5 删除开票信息

**接口说明**: 根据ID删除开票信息

**请求方式**: `DELETE`

**接口路径**: `/api/v1/invoices/invoice-info/:id`

**请求参数**:

| 参数名 | 类型 | 必填 | 位置 | 说明 |
|--------|------|------|------|------|
| id | Number | 是 | Path | 开票信息ID |

**请求示例**:
```javascript
DELETE /api/v1/invoices/invoice-info/1
Headers: {
  "Authorization": "Bearer <token>"
}
```

**响应示例（成功）**:
```json
{
  "success": true,
  "message": "开票信息删除成功"
}
```

**错误响应**:
```json
{
  "success": false,
  "error": "删除失败",
  "details": "开票信息不存在或已被删除"
}
```

---

## 四、数据模型

### 4.1 发票表 (invoices)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| order_no | VARCHAR(20) | 订单编号 |
| order_id | INT | 订单ID |
| device_no | VARCHAR(50) | 设备编号 |
| customer_name | VARCHAR(255) | 客户名称 |
| order_amount | DECIMAL(10,2) | 订单金额 |
| package_name | VARCHAR(255) | 套餐名称 |
| invoice_title | VARCHAR(255) | 开票抬头 |
| invoice_type | TINYINT | 发票类型（1：普专，2：普增） |
| social_credit_code | VARCHAR(50) | 统一社会信用代码 |
| receive_email | VARCHAR(255) | 接收邮箱 |
| bank_name | VARCHAR(255) | 开户行名称 |
| bank_account | VARCHAR(50) | 开户账号 |
| invoice_status | TINYINT | 发票状态（1：未开，2：已开） |
| created_by | VARCHAR(50) | 创建人 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |
| email_sent | BOOLEAN | 是否发送邮箱 |
| fileId | VARCHAR(50) | OSS发票文件ID |
| fileurl | VARCHAR(255) | 发票文件URL |

### 4.2 开票信息表 (invoice_infos)

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | INT | 主键，自增 |
| device_no | VARCHAR(50) | 设备编号 |
| customer_id | INT | 客户ID |
| customer_name | VARCHAR(255) | 客户名称 |
| title_type | VARCHAR(50) | 抬头类型 |
| invoice_title | VARCHAR(255) | 发票抬头 |
| invoice_type | TINYINT | 发票类型（1：增值税普票，2：增值税专票） |
| social_credit_code | VARCHAR(50) | 统一社会信用代码 |
| bank_name | VARCHAR(255) | 开户行名称 |
| bank_account | VARCHAR(50) | 开户账号 |
| receive_email | VARCHAR(255) | 接收邮箱 |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

### 4.3 字段枚举值说明

#### 发票类型 (invoice_type)
- `1` - 增值税普票
- `2` - 增值税专票

#### 发票状态 (invoice_status)
- `1` - 未开
- `2` - 已开

#### 邮件发送状态 (email_sent)
- `0` / `false` - 未发送
- `1` / `true` - 已发送

---

## 五、调用示例

### 5.1 JavaScript/Axios 示例

```javascript
// 引入axios
import axios from 'axios';

// 配置基础URL和Token
const baseURL = 'https://your-domain.com/api/v1';
const token = 'your_auth_token';

// 创建axios实例
const api = axios.create({
  baseURL,
  headers: {
    'Authorization': `Bearer ${token}`,
    'Content-Type': 'application/json'
  }
});

// 1. 创建发票
const createInvoice = async (orderNo, fileUrl) => {
  try {
    const response = await api.post('/invoices/createInvoiceForOrder', {
      orderNo: orderNo,
      fileDownloadUrl: fileUrl
    });
    console.log('发票创建成功:', response.data);
    return response.data;
  } catch (error) {
    console.error('发票创建失败:', error.response?.data || error.message);
    throw error;
  }
};

// 2. 获取发票列表
const getInvoiceList = async (page = 1, limit = 10, filters = {}) => {
  try {
    const params = {
      page,
      limit,
      ...filters
    };
    
    const response = await api.get('/invoices/getInvoiceList', { params });
    console.log('发票列表:', response.data);
    return response.data;
  } catch (error) {
    console.error('获取发票列表失败:', error);
    throw error;
  }
};

// 3. 创建或更新开票信息
const saveInvoiceInfo = async (invoiceInfo) => {
  try {
    const response = await api.post(
      '/invoices/invoice-info/createOrUpdateInvoiceInfo',
      invoiceInfo
    );
    console.log('开票信息保存成功:', response.data);
    return response.data;
  } catch (error) {
    console.error('保存开票信息失败:', error);
    throw error;
  }
};

// 4. 发送发票邮件
const sendInvoiceEmail = async (orderNo, email) => {
  try {
    const response = await api.post('/invoices/sendInvoiceEmail', {
      orderNo,
      email
    });
    console.log('发票发送成功:', response.data);
    return response.data;
  } catch (error) {
    console.error('发送发票失败:', error);
    throw error;
  }
};

// 5. 根据订单号获取发票
const getInvoiceByOrderNo = async (orderNo) => {
  try {
    const response = await api.get(`/invoices/getOrderByOrderNo/${orderNo}`);
    return response.data;
  } catch (error) {
    console.error('获取发票失败:', error);
    throw error;
  }
};

// 6. 根据设备号获取开票信息
const getInvoiceInfoByDevice = async (deviceNo) => {
  try {
    const response = await api.get(`/invoices/invoice-info/device/${deviceNo}`);
    return response.data;
  } catch (error) {
    console.error('获取开票信息失败:', error);
    throw error;
  }
};

// 使用示例
(async () => {
  try {
    // 创建发票
    await createInvoice('ORD20231128001', 'https://example.com/invoice.pdf');
    
    // 获取发票列表
    const invoiceList = await getInvoiceList(1, 10, {
      customer_name: '张三',
      invoice_status: 2
    });
    
    // 保存开票信息
    await saveInvoiceInfo({
      customer_name: '张三',
      invoice_title: '某某公司',
      invoice_type: 1,
      device_no: 'DEV001',
      receive_email: 'user@example.com'
    });
    
    // 发送发票邮件
    await sendInvoiceEmail('ORD20231128001', 'user@example.com');
    
  } catch (error) {
    console.error('操作失败:', error);
  }
})();
```

### 5.2 微信小程序示例

```javascript
// 配置
const config = {
  baseURL: 'https://your-domain.com/api/v1',
  token: wx.getStorageSync('token') // 从本地存储获取token
};

// 封装请求方法
const request = (options) => {
  return new Promise((resolve, reject) => {
    wx.request({
      url: config.baseURL + options.url,
      method: options.method || 'GET',
      data: options.data || {},
      header: {
        'Authorization': 'Bearer ' + config.token,
        'Content-Type': 'application/json',
        ...options.header
      },
      success: (res) => {
        if (res.data.success) {
          resolve(res.data);
        } else {
          reject(res.data);
        }
      },
      fail: (err) => {
        reject(err);
      }
    });
  });
};

// 1. 创建发票
const createInvoice = (orderNo, fileUrl) => {
  return request({
    url: '/invoices/createInvoiceForOrder',
    method: 'POST',
    data: {
      orderNo: orderNo,
      fileDownloadUrl: fileUrl
    }
  });
};

// 2. 获取发票列表
const getInvoiceList = (page, limit, filters) => {
  const params = new URLSearchParams({
    page: page || 1,
    limit: limit || 10,
    ...filters
  }).toString();
  
  return request({
    url: `/invoices/getInvoiceList?${params}`,
    method: 'GET'
  });
};

// 3. 保存开票信息
const saveInvoiceInfo = (invoiceInfo) => {
  return request({
    url: '/invoices/invoice-info/createOrUpdateInvoiceInfo',
    method: 'POST',
    data: invoiceInfo
  });
};

// 4. 发送发票邮件
const sendInvoiceEmail = (orderNo, email) => {
  return request({
    url: '/invoices/sendInvoiceEmail',
    method: 'POST',
    data: {
      orderNo: orderNo,
      email: email
    }
  });
};

// 使用示例
Page({
  data: {
    invoiceList: []
  },
  
  onLoad() {
    this.loadInvoiceList();
  },
  
  // 加载发票列表
  async loadInvoiceList() {
    try {
      wx.showLoading({ title: '加载中...' });
      
      const result = await getInvoiceList(1, 10, {
        customer_name: '张三'
      });
      
      this.setData({
        invoiceList: result.data.list
      });
      
      wx.hideLoading();
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: '加载失败',
        icon: 'none'
      });
    }
  },
  
  // 创建发票
  async handleCreateInvoice(orderNo, fileUrl) {
    try {
      wx.showLoading({ title: '创建中...' });
      
      const result = await createInvoice(orderNo, fileUrl);
      
      wx.hideLoading();
      wx.showToast({
        title: '创建成功',
        icon: 'success'
      });
      
      this.loadInvoiceList(); // 刷新列表
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: error.message || '创建失败',
        icon: 'none'
      });
    }
  },
  
  // 发送发票邮件
  async handleSendEmail(orderNo, email) {
    try {
      wx.showLoading({ title: '发送中...' });
      
      await sendInvoiceEmail(orderNo, email);
      
      wx.hideLoading();
      wx.showToast({
        title: '发送成功',
        icon: 'success'
      });
    } catch (error) {
      wx.hideLoading();
      wx.showToast({
        title: error.message || '发送失败',
        icon: 'none'
      });
    }
  }
});
```

### 5.3 Vue.js 示例

```javascript
// api/invoice.js
import request from '@/utils/request'; // axios封装

export default {
  // 创建发票
  createInvoice(data) {
    return request({
      url: '/invoices/createInvoiceForOrder',
      method: 'post',
      data
    });
  },
  
  // 获取发票列表
  getInvoiceList(params) {
    return request({
      url: '/invoices/getInvoiceList',
      method: 'get',
      params
    });
  },
  
  // 发送发票邮件
  sendInvoiceEmail(data) {
    return request({
      url: '/invoices/sendInvoiceEmail',
      method: 'post',
      data
    });
  },
  
  // 保存开票信息
  saveInvoiceInfo(data) {
    return request({
      url: '/invoices/invoice-info/createOrUpdateInvoiceInfo',
      method: 'post',
      data
    });
  },
  
  // 获取开票信息列表
  getInvoiceInfoList(params) {
    return request({
      url: '/invoices/invoice-info/list',
      method: 'get',
      params
    });
  }
};

// 组件中使用
// InvoiceList.vue
<template>
  <div class="invoice-list">
    <el-table :data="invoiceList" border>
      <el-table-column prop="order_no" label="订单号"></el-table-column>
      <el-table-column prop="customer_name" label="客户名称"></el-table-column>
      <el-table-column prop="order_amount" label="金额"></el-table-column>
      <el-table-column prop="invoice_status_text" label="状态"></el-table-column>
      <el-table-column label="操作">
        <template slot-scope="scope">
          <el-button @click="handleSendEmail(scope.row)">发送邮件</el-button>
        </template>
      </el-table-column>
    </el-table>
    
    <el-pagination
      @current-change="handlePageChange"
      :current-page="currentPage"
      :page-size="pageSize"
      :total="total">
    </el-pagination>
  </div>
</template>

<script>
import invoiceApi from '@/api/invoice';

export default {
  data() {
    return {
      invoiceList: [],
      currentPage: 1,
      pageSize: 10,
      total: 0
    };
  },
  
  mounted() {
    this.loadInvoiceList();
  },
  
  methods: {
    async loadInvoiceList() {
      try {
        const { data } = await invoiceApi.getInvoiceList({
          page: this.currentPage,
          limit: this.pageSize
        });
        
        this.invoiceList = data.list;
        this.total = data.pagination.total;
      } catch (error) {
        this.$message.error('加载失败');
      }
    },
    
    async handleSendEmail(row) {
      try {
        await this.$prompt('请输入邮箱地址', '发送发票', {
          confirmButtonText: '发送',
          cancelButtonText: '取消',
          inputPattern: /^[^\s@]+@[^\s@]+\.[^\s@]+$/,
          inputErrorMessage: '邮箱格式不正确'
        }).then(async ({ value }) => {
          await invoiceApi.sendInvoiceEmail({
            orderNo: row.order_no,
            email: value
          });
          this.$message.success('发送成功');
        });
      } catch (error) {
        if (error !== 'cancel') {
          this.$message.error('发送失败');
        }
      }
    },
    
    handlePageChange(page) {
      this.currentPage = page;
      this.loadInvoiceList();
    }
  }
};
</script>
```

---

## 六、错误处理

### 6.1 常见错误码

| HTTP状态码 | 说明 |
|-----------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未授权，需要登录 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 6.2 错误响应格式

```json
{
  "success": false,
  "error": "错误类型",
  "message": "错误消息",
  "details": "详细错误信息"
}
```

### 6.3 常见错误示例

#### 参数错误
```json
{
  "success": false,
  "error": "参数错误",
  "details": "订单编号不能为空"
}
```

#### 认证失败
```json
{
  "success": false,
  "error": "认证失败",
  "message": "Token无效或已过期"
}
```

#### 资源不存在
```json
{
  "success": false,
  "error": "资源不存在",
  "details": "找不到订单编号为ORD20231128001的订单"
}
```

#### 业务逻辑错误
```json
{
  "success": false,
  "message": "处理发票失败",
  "details": "未找到设备号DEV001对应的开票信息"
}
```

### 6.4 错误处理最佳实践

```javascript
// 统一错误处理
const handleApiError = (error) => {
  if (error.response) {
    // 服务器返回错误
    const { status, data } = error.response;
    
    switch (status) {
      case 400:
        console.error('参数错误:', data.details);
        break;
      case 401:
        console.error('认证失败，请重新登录');
        // 跳转到登录页
        break;
      case 404:
        console.error('资源不存在:', data.details);
        break;
      case 500:
        console.error('服务器错误:', data.message);
        break;
      default:
        console.error('未知错误:', data);
    }
  } else if (error.request) {
    // 请求已发出但没有收到响应
    console.error('网络错误，请检查网络连接');
  } else {
    // 其他错误
    console.error('请求配置错误:', error.message);
  }
};

// 使用示例
try {
  await createInvoice(orderNo, fileUrl);
} catch (error) {
  handleApiError(error);
}
```

---

## 七、附录

### 7.1 相关文件路径

- **路由文件**: `routes/invoiceRoutes.js`
- **控制器**: `controllers/invoiceController.js`
- **数据模型**:
  - `models/invoiceModel.js` - 发票模型
  - `models/invoiceInfoModel.js` - 开票信息模型
  - `models/invoiceApplicationModel.js` - 开票申请模型（仅数据模型）
- **服务入口**: `server.js`

### 7.2 数据库初始化

在 `init-db.js` 中包含了发票表的初始化逻辑：

```javascript
// 创建发票表
await InvoiceModel.createTable();
```

### 7.3 依赖服务

开票系统依赖以下服务：
- **OSS存储服务**: 用于存储发票PDF文件
- **邮件服务**: 用于发送发票到用户邮箱
- **订单系统**: 关联订单信息
- **客户系统**: 关联客户信息

### 7.4 注意事项

1. **文件上传**: 发票文件需要先上传到可访问的URL，然后通过 `fileDownloadUrl` 参数传递
2. **事务处理**: 创建发票时使用了数据库事务，确保数据一致性
3. **订单类型**: 支持普通订单和预充值订单两种类型
4. **邮箱验证**: 发送邮件时会验证邮箱格式
5. **权限控制**: 所有接口都需要通过认证中间件验证

---

## 更新日志

- **2023-11-28**: 初始版本，包含10个开票相关接口
- 支持发票创建、查询、邮件发送
- 支持开票信息的完整CRUD操作
- 提供完整的调用示例和错误处理指南

---

**文档版本**: v1.0  
**最后更新**: 2023-11-28  
**维护者**: 开发团队
