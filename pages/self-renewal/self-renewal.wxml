<!--pages/self-renewal/self-renewal.wxml-->

<!-- 顶部蓝色装饰背景 -->
<view class="blue-header"></view>

<view class="container">
  
  <!-- 骨架屏 - 加载中显示 -->
  <view wx:if="{{loading}}" class="skeleton-wrapper">
    <view class="skeleton-card info-card-skeleton">
      <view class="skeleton-line skeleton-title"></view>
      <view class="skeleton-line skeleton-desc"></view>
    </view>
    <view class="skeleton-card">
      <view class="skeleton-line skeleton-title"></view>
      <view class="skeleton-line skeleton-desc"></view>
    </view>
  </view>

  <!-- 内容区域 - 数据加载完成后显示 -->
  <view wx:else class="fade-in">
    
    <!-- 当前套餐信息卡片 (玻璃态效果) -->
    <view class="card info-card">
      <view class="info-row">
        <view class="info-item">
          <view class="info-label">当前套餐</view>
          <view class="info-value">{{packageInfo.package_name || '未知'}}</view>
        </view>
        <view class="info-item right-align">
          <view class="info-label">到期时间</view>
          <view class="device-tag">
            {{packageInfo.expire_time || '未知'}}
          </view>
        </view>
      </view>
    </view>

    <!-- 续费确认 -->
    <view class="card form-card">
      <view class="form-title">续费确认</view>
      <view class="form-subtitle">续费相同套餐，延长使用期限</view>
    </view>

    <!-- 注意事项 -->
    <view class="notes-section">
      <view class="notes-header">
        <view class="icon-info">!</view>
        <text>续费说明</text>
      </view>
      <view class="notes-list">
        <view class="note-item">续费将在当前套餐到期时间基础上延长，不会浪费剩余时长。</view>
        <view class="note-item">续费成功后立即生效，新的到期时间将自动更新。</view>
        <view class="note-item">如有疑问，请联系客服：4009677726</view>
      </view>
    </view>

  </view>

</view>

<!-- 底部固定按钮 -->
<view class="footer-action safe-area-bottom">
  <button 
    class="btn-submit" 
    hover-class="btn-hover" 
    bindtap="submitRenew"
    disabled="{{!packageInfo || loading || submitLoading}}"
    loading="{{submitLoading}}"
  >
    <text wx:if="{{submitLoading}}">提交中...</text>
    <text wx:elif="{{loading}}">加载中...</text>
    <text wx:elif="{{!packageInfo}}">套餐信息加载失败</text>
    <text wx:else>确认续费</text>
  </button>
</view>

<!-- 支付方式选择弹窗 -->
<view class="payment-modal" wx:if="{{showPaymentModal}}" catchtap="closePaymentModal">
  <view class="payment-content" catchtap="stopQrcodePropagation">
    <view class="payment-title">选择支付方式</view>
    <view class="payment-methods">
      <view class="payment-item" bindtap="selectPaymentMethod" data-method="wechat">
        <view class="payment-icon">
          <text class="iconfont icon-weixinzhifu"></text>
        </view>
        <view class="payment-info">
          <text class="payment-name">微信支付</text>
          <text class="payment-desc">推荐使用</text>
        </view>
        <view class="payment-arrow">›</view>
      </view>
      <view class="payment-item" bindtap="selectPaymentMethod" data-method="qrcode">
        <view class="payment-icon">
          <text class="iconfont icon-erweimazhifu"></text>
        </view>
        <view class="payment-info">
          <text class="payment-name">扫码支付</text>
          <text class="payment-desc">微信扫码</text>
        </view>
        <view class="payment-arrow">›</view>
      </view>
      <view class="payment-item" bindtap="selectPaymentMethod" data-method="alipay">
        <view class="payment-icon">
          <text class="iconfont icon-zhifubaozhifu"></text>
        </view>
        <view class="payment-info">
          <text class="payment-name">支付宝支付</text>
          <text class="payment-desc">支付宝扫码</text>
        </view>
        <view class="payment-arrow">›</view>
      </view>
      <view class="payment-item" bindtap="selectPaymentMethod" data-method="offline">
        <view class="payment-icon">
          <text class="iconfont icon-xianxiazhifu"></text>
        </view>
        <view class="payment-info">
          <text class="payment-name">线下支付</text>
          <text class="payment-desc">联系工作人员</text>
        </view>
        <view class="payment-arrow">›</view>
      </view>
    </view>
  </view>
</view>

<!-- 二维码支付弹窗 -->
<view class="qrcode-modal" wx:if="{{showQrcodeModal}}" catchtap="closeQrcodeModal">
  <view class="qrcode-content" catchtap="stopQrcodePropagation">
    <view class="qrcode-header">
      <text class="qrcode-title">{{qrcodeTitle || '微信扫码支付'}}</text>
      <text class="close-btn" catchtap="closeQrcodeModal">✕</text>
    </view>
    
    <view class="qrcode-body">
      <!-- 加载状态 -->
      <view wx:if="{{qrcodeLoading}}" class="qrcode-loading">
        <view class="loading-spinner"></view>
        <text class="loading-text">生成二维码中...</text>
      </view>
      
      <!-- 错误状态 -->
      <view wx:elif="{{qrcodeError}}" class="qrcode-error">
        <text class="error-icon">⚠️</text>
        <text class="error-text">{{qrcodeError}}</text>
        <button class="retry-button" catchtap="retryGenerateQrcode">重试</button>
      </view>
      
      <!-- 二维码显示 -->
      <view wx:else class="qrcode-display">
        <view class="qrcode-wrapper">
          <canvas 
            type="2d" 
            id="qrcode-canvas" 
            class="qrcode-canvas"
          ></canvas>
        </view>
        
        <view class="qrcode-tips">
          <text class="tips-title">{{qrcodeTitle ? (qrcodeTitle.indexOf('支付宝') > -1 ? '请使用支付宝扫码支付' : '请使用微信扫码支付') : '请使用微信扫码支付'}}</text>
          <text class="tips-desc">订单号：{{qrcodeOrderNo}}</text>
        </view>
        
        <view class="qrcode-actions">
          <button class="action-button copy-button" catchtap="copyQrcodeLink">
            复制链接
          </button>
        </view>
      </view>
    </view>
  </view>
</view>