<!--pages/product-query/product-query.wxml-->
<view class="container">

  <!-- 1. 顶部搜索栏 (吸顶) -->
  <view class="header-section">
    <!-- 状态栏占位 -->
    <view style="height: {{statusBarHeight}}px;"></view>
    
    <!-- 标题行 -->
    <view class="nav-bar">
      <view class="back-btn" bindtap="handleBack">
        <image class="icon-back" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTE1IDE5bC03LTcgNy03Ii8+PC9zdmc+"></image>
      </view>
      <text class="nav-title">产品查询</text>
      <view class="nav-placeholder"></view>
    </view>

    <!-- 搜索表单卡片 -->
    <view class="search-card">
      <view class="form-row">
        <view class="form-item">
          <view class="form-label">
            <text>设备编码</text>
          </view>
          <input class="form-input" placeholder="请输入设备编码" placeholder-class="placeholder" value="{{deviceNo}}" bindinput="onDeviceNoChange" />
        </view>
        <view class="form-divider"></view>
        <view class="form-item">
          <view class="form-label">
            <text>缴费账号</text>
          </view>
          <input class="form-input" placeholder="请输入缴费账号" placeholder-class="placeholder" value="{{rechargeAccount}}" bindinput="onRechargeAccountChange" />
        </view>
      </view>
      <!-- 查询按钮 -->
      <view class="query-btn" bindtap="onSubmit">
        <text wx:if="{{isLoading}}" class="loading-icon">⟳</text>
        <text wx:else>立即查询</text>
      </view>
    </view>
  </view>

  <!-- 历史记录区域 - 只在未显示结果时展示 -->
  <view class="history-section" wx:if="{{!showResult && !isLoading && historyList.length > 0}}">
    <view class="history-header">
      <text class="history-title">历史记录</text>
      <text class="history-clear" catchtap="clearHistory">清空</text>
    </view>
    <view class="history-list">
      <view class="history-item" wx:for="{{historyList}}" wx:key="index" catchtap="selectHistory" data-index="{{index}}">
        <view class="history-left">
          <text class="history-name">{{item.customerName}}</text>
          <text class="history-info">{{item.deviceNo}} · {{item.rechargeAccount}}</text>
        </view>
        <view class="history-right">
          <text class="history-time">{{item.time}}</text>
          <text class="history-arrow">›</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 2. 统计条 -->
  <view class="stats-bar" wx:if="{{showResult}}">
    <text class="stats-text">查询结果</text>
    <view class="tag-update">实时数据</view>
  </view>

  <!-- 骨架屏 - 搜索加载中显示 -->
  <view class="skeleton-wrapper" wx:if="{{isLoading}}">
    <!-- 统计条骨架屏 -->
    <view class="stats-bar skeleton-stats-bar">
      <view class="skeleton-line skeleton-stats-text"></view>
    </view>

    <!-- 设备卡片骨架屏 -->
    <view class="list-container">
      <view class="card skeleton-card" wx:for="{{[1,2,3]}}" wx:key="*this">
        <view class="status-stripe bg-skeleton"></view>
        <view class="card-body">
          <!-- 头部骨架屏 -->
          <view class="card-header">
            <view class="header-left">
              <view class="skeleton-line skeleton-device-name"></view>
            </view>
            <view class="header-right">
              <view class="skeleton-line skeleton-price"></view>
            </view>
          </view>

          <!-- 核心数据区骨架屏 -->
          <view class="core-data-box">
            <view class="skeleton-line skeleton-sn"></view>
            <view class="skeleton-line skeleton-spec"></view>
            <view class="skeleton-line skeleton-time"></view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 3. 查询结果 -->
  <view class="list-container" wx:if="{{showResult && queryResult && !isLoading}}">
    
    <!-- 客户信息卡片 -->
    <view class="card">
      <view class="status-stripe {{queryResult.binding_info.status === '1' ? 'bg-green' : 'bg-orange'}}"></view>
      <view class="card-body">
        <!-- 头部信息 -->
        <view class="card-header">
          <view class="header-left">
            <view class="title-row">
              <text class="device-name">{{queryResult.customer.customer_name || '未知客户'}}</text>
              <view class="status-tag {{queryResult.binding_info.status === '1' ? 'tag-using' : 'tag-pending'}}">
                {{queryResult.binding_info.status === '1' ? '正常' : '停用'}}
              </view>
            </view>
          </view>
          <view class="header-right">
            <view class="price-box">
              <text class="currency">¥</text>
              <text class="amount">{{queryResult.totalBalance}}</text>
            </view>
            <text class="balance-label">账户余额</text>
          </view>
        </view>

        <!-- 核心信息区 -->
        <view class="core-data-box">
          <view class="section-title-small">基本信息</view>
          <view class="grid-layout">
            <!-- 设备编码 -->
            <view class="grid-item col-span-2">
              <text class="label">设备编码</text>
              <view class="sn-row">
                <text class="value-mono">{{queryResult.device.device_no}}</text>
                <view class="copy-btn" bindtap="handleCopy" data-text="{{queryResult.device.device_no}}">
                  <image class="icon-copy" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjNDc3MkZGIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTggMTZINmEyIDIgMCAwMS0yLTJWNmEyIDIgMCAwMTItMmg4YTIgMiAwIDAxMiAydjJtLTYgMTJoOGEyIDIgMCAwMDItMnYtOGEyIDIgMCAwMC0yLTJoLThhMiAyIDAgMDAtMiAydjhhMiAyIDAgMDAyIDJ6Ii8+PC9zdmc+"></image>
                  <text>复制</text>
                </view>
              </view>
            </view>
            
            <!-- 缴费账号 -->
            <view class="grid-item">
              <text class="label">缴费账号</text>
              <text class="value">{{queryResult.binding_info.recharge_account || '-'}}</text>
            </view>
            
            <!-- 联系电话 -->
            <view class="grid-item">
              <text class="label">联系电话</text>
              <text class="value">{{queryResult.customer.contact_phone || '-'}}</text>
            </view>

            <!-- 入网品牌 -->
            <view class="grid-item">
              <text class="label">入网品牌</text>
              <text class="value">{{queryResult.customer.brand || '-'}}</text>
            </view>

            <!-- 入网申请人 -->
            <view class="grid-item">
              <text class="label">入网申请经办人</text>
              <text class="value">{{queryResult.binding_info.created_by || '-'}}</text>
            </view>

            <!-- 安装地点 -->
            <view class="grid-item col-span-2">
              <text class="label">安装地点</text>
              <text class="value">{{queryResult.customer.city}} {{queryResult.customer.install_address || '-'}}</text>
            </view>

            <!-- 安装竣工时间 -->
            <view class="grid-item">
              <text class="label">安装竣工时间</text>
              <text class="value">{{queryResult.binding_info.completion_time || '-'}}</text>
            </view>

            <!-- 到期时间 -->
            <view class="grid-item">
              <text class="label">到期时间</text>
              <text class="value text-warning">{{queryResult.binding_info.expire_time || '-'}}</text>
            </view>
          </view>
        </view>

        <!-- 套餐信息 -->
        <view class="package-info-box" wx:if="{{queryResult.package}}">
          <view class="section-title-small">套餐信息</view>
          <view class="grid-layout">
            <view class="grid-item">
              <text class="label">套餐名称</text>
              <text class="value highlight-blue">{{queryResult.package.package_name || '-'}}</text>
            </view>
            <view class="grid-item">
              <text class="label">套餐价格</text>
              <text class="value">¥{{queryResult.package.price || '0.00'}}</text>
            </view>
            <view class="grid-item">
              <text class="label">流量/带宽</text>
              <text class="value">{{queryResult.package.flow || '-'}}</text>
            </view>
            <view class="grid-item">
              <text class="label">套餐类型</text>
              <text class="value">{{queryResult.package.package_type === '0' ? '包月' : '流量'}}</text>
            </view>
          </view>
        </view>

        <!-- 其他信息 -->
        <view class="extra-info" wx:if="{{queryResult.customer.install_requirement || queryResult.package.remark}}">
          <view class="section-title-small">其他信息</view>
          <view class="grid-layout">
            <view class="grid-item col-span-2" wx:if="{{queryResult.customer.install_requirement}}">
              <text class="label">安装要求</text>
              <view class="remark-box">{{queryResult.customer.install_requirement}}</view>
            </view>
            <view class="grid-item col-span-2" wx:if="{{queryResult.package.remark}}">
              <text class="label">套餐备注</text>
              <view class="remark-box">{{queryResult.package.remark}}</view>
            </view>
          </view>
        </view>

      </view>
    </view>

  </view>

  <!-- 空状态 -->
  <view class="empty-state" wx:if="{{!showResult && !isLoading}}">
    <text class="empty-text">请输入设备编号或缴费账号进行查询</text>
    <view class="help-link" bindtap="showHelp">
      <text class="help-icon">❓</text>
      如何找到我的设备码？
    </view>
  </view>
</view>