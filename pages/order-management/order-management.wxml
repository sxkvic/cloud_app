<view class="order-management-container">
  <!-- Tab 切换 -->
  <view class="tabs-container">
    <view class="tabs">
      <view 
        class="tab-item {{activeTab === 'package' ? 'active' : ''}}" 
        bindtap="switchTab" 
        data-tab="package"
      >
        <text class="tab-text">套餐订购</text>
        <view class="tab-indicator" wx:if="{{activeTab === 'package'}}"></view>
      </view>
      <view 
        class="tab-item {{activeTab === 'recharge' ? 'active' : ''}}" 
        bindtap="switchTab" 
        data-tab="recharge"
      >
        <text class="tab-text">预充值订单</text>
        <view class="tab-indicator" wx:if="{{activeTab === 'recharge'}}"></view>
      </view>
    </view>
  </view>

  <!-- 骨架屏 -->
  <view wx:if="{{loading}}" class="skeleton-container">
    <view class="skeleton-item" wx:for="{{[1,2,3,4,5]}}" wx:key="index">
      <view class="skeleton-header">
        <view class="skeleton-line skeleton-title"></view>
        <view class="skeleton-line skeleton-status"></view>
      </view>
      <view class="skeleton-content">
        <view class="skeleton-line skeleton-text"></view>
        <view class="skeleton-line skeleton-text"></view>
        <view class="skeleton-line skeleton-text"></view>
      </view>
      <view class="skeleton-footer">
        <view class="skeleton-line skeleton-amount"></view>
      </view>
    </view>
  </view>

  <!-- 套餐订购列表 -->
  <view wx:if="{{!loading && activeTab === 'package'}}" class="order-list">
    <!-- 空状态 -->
    <view wx:if="{{packageOrders.length === 0}}" class="empty-state">
      <image class="empty-icon" src="/images/empty-order.png" mode="aspectFit"></image>
      <text class="empty-text">暂无套餐订购记录</text>
    </view>

    <!-- 订单列表 -->
    <view wx:else>
      <view class="order-card" wx:for="{{packageOrders}}" wx:key="id">
        <view class="order-header">
          <view class="order-info">
            <text class="order-no">订单号：{{item.order_no}}</text>
            <view class="status-badge status-{{item.payment_status}}">
              {{item.payment_status === 1 ? '待支付' : item.payment_status === 2 ? '已支付' : '已取消'}}
            </view>
          </view>
          <text class="order-time">{{item.order_time}}</text>
        </view>

        <view class="order-content">
          <view class="content-row">
            <text class="label">套餐名称：</text>
            <text class="value">{{item.package_name}}</text>
          </view>
          <view class="content-row">
            <text class="label">套餐类型：</text>
            <text class="value">{{item.package_type === '0' ? '包月' : item.package_type === '1' ? '包年' : '其他'}}</text>
          </view>
          <view class="content-row">
            <text class="label">客户名称：</text>
            <text class="value">{{item.customer_name}}</text>
          </view>
          <view class="content-row">
            <text class="label">设备编号：</text>
            <text class="value">{{item.device_no}}</text>
          </view>
          <view class="content-row">
            <text class="label">充值账号：</text>
            <text class="value">{{item.recharge_account}}</text>
          </view>
          <view class="content-row">
            <text class="label">支付方式：</text>
            <text class="value">{{item.payment_type === 1 ? '微信支付' : item.payment_type === 2 ? '支付宝' : '线下支付'}}</text>
          </view>
          <view class="content-row" wx:if="{{item.payment_time}}">
            <text class="label">支付时间：</text>
            <text class="value">{{item.payment_time}}</text>
          </view>
        </view>

        <view class="order-footer">
          <view class="amount-info">
            <text class="amount-label">订单金额：</text>
            <text class="amount-value">¥{{item.order_amount}}</text>
          </view>
          <!-- 待支付订单显示重新支付按钮 -->
          <view wx:if="{{item.payment_status === 1}}" class="action-btn-group">
            <view class="repay-btn" catchtap="handleRepayPackageOrder" data-order="{{item}}">
              <text class="repay-btn-text">重新支付</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 预充值订单列表 -->
  <view wx:if="{{!loading && activeTab === 'recharge'}}" class="order-list">
    <!-- 空状态 -->
    <view wx:if="{{rechargeOrders.length === 0}}" class="empty-state">
      <image class="empty-icon" src="/images/empty-order.png" mode="aspectFit"></image>
      <text class="empty-text">暂无预充值订单记录</text>
    </view>

    <!-- 订单列表 -->
    <view wx:else>
      <view class="order-card" wx:for="{{rechargeOrders}}" wx:key="id">
        <view class="order-header">
          <view class="order-info">
            <text class="order-no">订单号：{{item.order_no}}</text>
            <view class="status-badge status-{{item.recharge_status}}">
              {{item.recharge_status === 1 ? '待充值' : item.recharge_status === 2 ? '已充值' : '已取消'}}
            </view>
          </view>
          <text class="order-time">{{item.created_at}}</text>
        </view>

        <view class="order-content">
          <view class="content-row">
            <text class="label">客户名称：</text>
            <text class="value">{{item.customer_name}}</text>
          </view>
          <view class="content-row">
            <text class="label">设备编号：</text>
            <text class="value">{{item.device_no}}</text>
          </view>
          <view class="content-row">
            <text class="label">充值账号：</text>
            <text class="value">{{item.recharge_account}}</text>
          </view>
          <view class="content-row">
            <text class="label">支付方式：</text>
            <text class="value">{{item.payment_type === 1 ? '微信支付' : item.payment_type === 2 ? '支付宝' : '线下支付'}}</text>
          </view>
          <view class="content-row" wx:if="{{item.payment_time}}">
            <text class="label">支付时间：</text>
            <text class="value">{{item.payment_time}}</text>
          </view>
          <view class="content-row" wx:if="{{item.remark}}">
            <text class="label">备注：</text>
            <text class="value">{{item.remark}}</text>
          </view>
        </view>

        <view class="order-footer">
          <view class="amount-info">
            <text class="amount-label">充值金额：</text>
            <text class="amount-value">¥{{item.recharge_amount}}</text>
          </view>
          <!-- 待充值订单显示重新支付按钮 -->
          <view wx:if="{{item.recharge_status === 1}}" class="action-btn-group">
            <view class="repay-btn" catchtap="handleRepayRechargeOrder" data-order="{{item}}">
              <text class="repay-btn-text">重新支付</text>
            </view>
          </view>
        </view>
      </view>
    </view>
  </view>

  <!-- 加载更多 -->
  <view wx:if="{{!loading && hasMore}}" class="load-more" bindtap="loadMore">
    <text class="load-more-text">加载更多</text>
  </view>

  <!-- 没有更多 -->
  <view wx:if="{{!loading && !hasMore && (packageOrders.length > 0 || rechargeOrders.length > 0)}}" class="no-more">
    <text class="no-more-text">没有更多了</text>
  </view>

  <!-- 支付方式选择弹窗 -->
  <view class="payment-modal" wx:if="{{showPaymentModal}}" catchtap="closePaymentModal">
    <view class="payment-content" catchtap="stopPropagation">
      <view class="payment-title">选择支付方式</view>
      <view class="payment-methods">
        <!-- 微信支付方式（payment_type === 1） -->
        <block wx:if="{{pendingOrderData.payment_type === 1}}">
          <view class="payment-item" bindtap="selectPaymentMethod" data-method="wechat">
            <view class="payment-icon wechat-icon">
              <text class="iconfont icon-weixinzhifu"></text>
            </view>
            <view class="payment-info">
              <text class="payment-name">微信支付</text>
              <text class="payment-desc">推荐使用</text>
            </view>
            <view class="payment-arrow">›</view>
          </view>
          <view class="payment-item" bindtap="selectPaymentMethod" data-method="qrcode">
            <view class="payment-icon qrcode-icon">
              <text class="iconfont icon-erweimazhifu"></text>
            </view>
            <view class="payment-info">
              <text class="payment-name">扫码支付</text>
              <text class="payment-desc">微信扫码</text>
            </view>
            <view class="payment-arrow">›</view>
          </view>
        </block>
        <!-- 支付宝支付方式（payment_type === 2） -->
        <block wx:elif="{{pendingOrderData.payment_type === 2}}">
          <view class="payment-item" bindtap="selectPaymentMethod" data-method="alipay">
            <view class="payment-icon alipay-icon">
              <text class="iconfont icon-zhifubaozhifu"></text>
            </view>
            <view class="payment-info">
              <text class="payment-name">支付宝支付</text>
              <text class="payment-desc">支付宝扫码</text>
            </view>
            <view class="payment-arrow">›</view>
          </view>
        </block>
      </view>
    </view>
  </view>

  <!-- 二维码支付弹窗 -->
  <view class="qrcode-modal" wx:if="{{showQrcodeModal}}" catchtap="closeQrcodeModal">
    <view class="qrcode-content" catchtap="stopPropagation">
      <view class="qrcode-header">
        <text class="qrcode-title">{{qrcodeTitle || '扫码支付'}}</text>
        <text class="close-btn" catchtap="closeQrcodeModal">✕</text>
      </view>
      
      <view class="qrcode-body">
        <!-- 加载状态 -->
        <view wx:if="{{qrcodeLoading}}" class="qrcode-loading">
          <view class="loading-spinner"></view>
          <text class="loading-text">生成二维码中...</text>
        </view>
        
        <!-- 错误状态 -->
        <view wx:elif="{{qrcodeError}}" class="qrcode-error">
          <text class="error-icon">⚠️</text>
          <text class="error-text">{{qrcodeError}}</text>
          <button class="retry-button" catchtap="retryGenerateQrcode">重试</button>
        </view>
        
        <!-- 二维码显示 -->
        <view wx:else class="qrcode-display">
          <view class="qrcode-wrapper">
            <canvas 
              type="2d" 
              id="qrcode-canvas" 
              class="qrcode-canvas"
            ></canvas>
          </view>
          
          <view class="qrcode-tips">
            <text class="tips-title">{{qrcodeTips}}</text>
            <text class="tips-desc">订单号：{{qrcodeOrderNo}}</text>
          </view>
          
          <view class="qrcode-actions">
            <button class="action-button copy-button" catchtap="copyQrcodeLink">
              复制链接
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>
</view>
