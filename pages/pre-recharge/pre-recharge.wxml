<!--pages/pre-recharge/pre-recharge.wxml-->
<view class="container">

  <!-- 1. 沉浸式头部 -->
  <view class="header-bg">
    <!-- 状态栏占位 (动态高度) -->
    <view style="height: {{statusBarHeight}}px;"></view>
    
    <!-- 导航栏 (动态高度，对齐胶囊) -->
    <view class="nav-bar" style="height: {{navBarHeight}}px; line-height: {{navBarHeight}}px;">
      <view class="back-btn" bindtap="handleBack">
        <image class="icon-back" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0ibm9uZSIgc3Ryb2tlPSIjZmZmZmZmIiBzdHJva2Utd2lkdGg9IjIiIHN0cm9rZS1saW5lY2FwPSJyb3VuZCIgc3Ryb2tlLWxpbmVqb2luPSJyb3VuZCI+PHBhdGggZD0iTTE1IDE5bC03LTcgNy03Ii8+PC9zdmc+" mode="aspectFit"></image>
      </view>
      <text class="nav-title">账户充值</text>
    </view>

    <!-- 账户信息 -->
    <view class="account-info" wx:if="{{customerInfo && !isLoadingCustomer}}">
      <view class="info-left">
        <text class="label">当前宽带账户</text>
        <text class="phone">{{customerInfo.customer.customer_name || '未知'}}</text>
      </view>
      <view class="info-right">
        <text class="label">设备信息</text>
        <text class="device">{{customerInfo.device_info.device_name || '未绑定'}}</text>
      </view>
    </view>

    <!-- 加载状态 -->
    <view class="account-info" wx:if="{{isLoadingCustomer}}">
      <view class="loading-wrapper">
        <text class="loading-icon">⏳</text>
        <text class="loading-text">正在加载客户信息...</text>
      </view>
    </view>
  </view>

  <!-- 2. 内容区域 (向上浮动) -->
  <view class="content-body">
    
    <!-- 充值面板 -->
    <view class="card">
      <view class="card-title">选择充值金额</view>

      <!-- 金额网格 -->
      <view class="grid-box">
        <block wx:for="{{amountList}}" wx:key="value">
          <view 
            class="grid-item {{selectedIndex === index ? 'active' : ''}}" 
            bindtap="selectAmount" 
            data-index="{{index}}"
          >
            <!-- 推荐角标 -->
            <view class="recommend-tag" wx:if="{{item.isRecommend}}">推荐</view>
            
            <text class="amount">¥{{item.value}}</text>
            <text class="desc">售价 ¥{{item.value}}</text>
            
            <!-- 选中态的勾勾 (纯CSS绘制的三角形和勾在WXSS里) -->
            <view class="check-mark" wx:if="{{selectedIndex === index}}">✓</view>
          </view>
        </block>
      </view>

      <!-- 自定义金额 -->
      <view class="custom-row">
        <text class="custom-label">自定义金额</text>
        <view class="custom-input-box {{selectedIndex === -1 && customAmount ? 'active-border' : ''}}">
          <text class="symbol">¥</text>
          <input 
            class="input" 
            type="digit" 
            placeholder="请输入金额" 
            placeholder-class="placeholder" 
            value="{{customAmount}}"
            bindinput="handleCustomInput"
          />
        </view>
      </view>
    </view>

    <!-- 说明文案 -->
    <view class="tips-box">
      <view class="tips-title">充值说明</view>
      <view class="tips-item">• 充值金额通常在 1-5 分钟内到账。</view>
      <view class="tips-item">• 赠送金额将直接存入余额，不可提现。</view>
      <view class="tips-item">• 如遇网络繁忙，到账可能延迟，请耐心等待。</view>
    </view>

  </view>

  <!-- 3. 底部悬浮支付栏 -->
  <view class="footer-bar">
    <view class="footer-content">
      <view class="price-box">
        <text class="label">实付金额：</text>
        <text class="price">¥{{payAmount}}</text>
      </view>
      <button 
        class="pay-btn" 
        bindtap="handlePay"
        disabled="{{!payAmount || !customerInfo || isLoading || isLoadingCustomer}}"
      >
        <text wx:if="{{isLoading}}">处理中...</text>
        <text wx:elif="{{isLoadingCustomer}}">加载中...</text>
        <text wx:elif="{{!customerInfo}}">客户信息加载失败</text>
        <text wx:else>立即充值</text>
      </button>
    </view>
  </view>

  <!-- 支付方式选择弹窗 -->
  <view class="payment-modal" wx:if="{{showPaymentModal}}" catchtap="closePaymentModal">
    <view class="payment-content" catchtap="stopQrcodePropagation">
      <view class="payment-title">选择支付方式</view>
      <view class="payment-methods">
        <view class="payment-item" bindtap="selectPaymentMethod" data-method="wechat">
          <view class="payment-icon">
            <text class="iconfont icon-weixinzhifu"></text>
          </view>
          <view class="payment-info">
            <text class="payment-name">微信支付</text>
            <text class="payment-desc">推荐使用</text>
          </view>
          <view class="payment-arrow">›</view>
        </view>
        <view class="payment-item" bindtap="selectPaymentMethod" data-method="qrcode">
          <view class="payment-icon">
            <text class="iconfont icon-erweimazhifu"></text>
          </view>
          <view class="payment-info">
            <text class="payment-name">扫码支付</text>
            <text class="payment-desc">微信扫码</text>
          </view>
          <view class="payment-arrow">›</view>
        </view>
        <view class="payment-item" bindtap="selectPaymentMethod" data-method="alipay">
          <view class="payment-icon">
            <text class="iconfont icon-zhifubaozhifu"></text>
          </view>
          <view class="payment-info">
            <text class="payment-name">支付宝支付</text>
            <text class="payment-desc">支付宝扫码</text>
          </view>
          <view class="payment-arrow">›</view>
        </view>
        <view class="payment-item" bindtap="selectPaymentMethod" data-method="offline">
          <view class="payment-icon">
            <text class="iconfont icon-xianxiazhifu"></text>
          </view>
          <view class="payment-info">
            <text class="payment-name">线下支付</text>
            <text class="payment-desc">联系工作人员</text>
          </view>
          <view class="payment-arrow">›</view>
        </view>
      </view>
    </view>
  </view>

  <!-- 二维码支付弹窗 -->
  <view class="qrcode-modal" wx:if="{{showQrcodeModal}}" catchtap="closeQrcodeModal">
    <view class="qrcode-content" catchtap="stopQrcodePropagation">
      <view class="qrcode-header">
        <text class="qrcode-title">{{qrcodeTitle || '微信扫码支付'}}</text>
        <text class="close-btn" catchtap="closeQrcodeModal">✕</text>
      </view>
      
      <view class="qrcode-body">
        <!-- 加载状态 -->
        <view wx:if="{{qrcodeLoading}}" class="qrcode-loading">
          <view class="loading-spinner"></view>
          <text class="loading-text">生成二维码中...</text>
        </view>
        
        <!-- 错误状态 -->
        <view wx:elif="{{qrcodeError}}" class="qrcode-error">
          <text class="error-icon">⚠️</text>
          <text class="error-text">{{qrcodeError}}</text>
          <button class="retry-button" catchtap="retryGenerateQrcode">重试</button>
        </view>
        
        <!-- 二维码显示 -->
        <view wx:else class="qrcode-display">
          <view class="qrcode-wrapper">
            <canvas 
              type="2d" 
              id="qrcode-canvas" 
              class="qrcode-canvas"
            ></canvas>
          </view>
          
          <view class="qrcode-tips">
            <text class="tips-title">{{qrcodeTips}}</text>
            <text class="tips-desc">订单号：{{qrcodeOrderNo}}</text>
          </view>
          
          <view class="qrcode-actions">
            <button class="action-button copy-button" catchtap="copyQrcodeLink">
              复制链接
            </button>
          </view>
        </view>
      </view>
    </view>
  </view>

</view>