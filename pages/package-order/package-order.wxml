<!--pages/package-order/package-order.wxml-->
<view class="package-order-page">
    <!-- 可滚动内容区域 -->
    <scroll-view class="content-wrapper" scroll-y enhanced show-scrollbar="{{false}}">
        
        <!-- 骨架屏 - 加载中显示 -->
        <view wx:if="{{ loading }}" class="skeleton-wrapper">
            <view class="skeleton-card" wx:for="{{[1,2,3,4,5]}}" wx:key="*this">
                <view class="skeleton-thumb"></view>
                <view class="skeleton-content">
                    <view class="skeleton-line skeleton-title"></view>
                    <view class="skeleton-line skeleton-desc"></view>
                    <view class="skeleton-tags">
                        <view class="skeleton-tag"></view>
                        <view class="skeleton-tag"></view>
                    </view>
                </view>
            </view>
        </view>
        
        <!-- 套餐列表 - 数据加载完成后显示 -->
        <view wx:else class="package-list fade-in">
            <view wx:for="{{ packages }}" wx:key="id" class="package-card {{ selectedPackage === item.id ? 'selected' : '' }}" bindtap="selectPackage" data-id="{{ item.id }}">
                <!-- 热门角标 -->
                <view class="popular-badge" wx:if="{{ item.isPopular }}">特惠</view>
                
                <!-- 左侧流量图标 -->
                <view class="data-thumb theme-{{ item.colorTheme }}">
                    <view class="signal-bg"></view>
                    <view class="data-content">
                        <view class="data-number">
                            <text class="data-num">{{ item.speed }}</text>
                            <text class="data-unit">{{ item.speedUnit }}</text>
                        </view>
                        <view class="data-type">宽带</view>
                    </view>
                </view>
                
                <!-- 右侧信息 -->
                <view class="package-info">
                    <view class="info-top">
                        <view class="package-header">
                            <view class="package-name">{{ item.name }}</view>
                            <view class="package-price">
                                <text class="price-symbol">¥</text>
                                <text class="price-value">{{ item.price }}</text>
                            </view>
                        </view>
                        <view class="package-desc" wx:if="{{ item.features.length > 0 }}">{{ item.features[0] }}</view>
                        
                        <!-- 特性标签 -->
                        <view class="feature-tags">
                            <view wx:for="{{ item.featureTags }}" wx:for-item="tag" wx:key="*this" class="feature-tag theme-{{ item.colorTheme }}">
                                {{ tag }}
                            </view>
                        </view>
                    </view>
                    
                    <!-- 购买按钮 -->
                    <view class="buy-button-wrapper">
                        <view class="buy-button theme-{{ item.colorTheme }}">购买</view>
                    </view>
                </view>
            </view>
        </view>
    </scroll-view>

    <!-- 订购按钮 -->
    <view class="order-section">
        <button 
            class="order-button {{ selectedPackage && customerInfo ? 'active' : 'disabled' }}" 
            disabled="{{ !selectedPackage || !customerInfo || submitLoading }}"
            loading="{{ submitLoading }}"
            bindtap="confirmOrder"
        >
            {{ submitLoading ? '订购中...' : (selectedPackage && customerInfo ? '立即订购' : '请先选择套餐') }}
        </button>
    </view>

    <!-- 支付方式选择弹窗 -->
    <view class="payment-modal" wx:if="{{ showPaymentModal }}" catchtap="closePaymentModal">
        <view class="payment-content" catchtap="stopPropagation">
            <view class="payment-header">
                <text class="payment-title">选择支付方式</text>
                <text class="payment-close" catchtap="closePaymentModal">✕</text>
            </view>
            <view class="payment-options">
                <view class="payment-option" catchtap="selectPaymentMethod" data-method="wechat">
                    <view class="option-icon wechat-icon">
                        <text class="iconfont icon-weixinzhifu"></text>
                    </view>
                    <view class="option-info">
                        <text class="option-name">微信支付</text>
                        <text class="option-desc">使用微信余额或绑定银行卡支付</text>
                    </view>
                    <view class="option-arrow">›</view>
                </view>
                <view class="payment-option" catchtap="selectPaymentMethod" data-method="qrcode">
                    <view class="option-icon qrcode-icon">
                        <text class="iconfont icon-erweimazhifu"></text>
                    </view>
                    <view class="option-info">
                        <text class="option-name">微信二维码支付</text>
                        <text class="option-desc">生成二维码，使用微信扫码支付</text>
                    </view>
                    <view class="option-arrow">›</view>
                </view>
                <view class="payment-option" catchtap="selectPaymentMethod" data-method="offline">
                    <view class="option-icon offline-icon">
                        <text class="iconfont icon-xianxiazhifu"></text>
                    </view>
                    <view class="option-info">
                        <text class="option-name">线下支付</text>
                        <text class="option-desc">到营业厅或指定地点支付</text>
                    </view>
                    <view class="option-arrow">›</view>
                </view>
            </view>
        </view>
    </view>

    <!-- 二维码支付弹窗 -->
    <view class="qrcode-modal" wx:if="{{ showQrcodeModal }}" catchtap="closeQrcodeModal">
        <view class="qrcode-content" catchtap="stopQrcodePropagation">
            <view class="qrcode-header">
                <text class="qrcode-title">微信扫码支付</text>
                <text class="qrcode-close" catchtap="closeQrcodeModal">✕</text>
            </view>
            
            <view class="qrcode-body">
                <!-- 加载状态 -->
                <view wx:if="{{ qrcodeLoading }}" class="qrcode-loading">
                    <view class="loading-spinner"></view>
                    <text class="loading-text">生成二维码中...</text>
                </view>
                
                <!-- 错误状态 -->
                <view wx:elif="{{ qrcodeError }}" class="qrcode-error">
                    <text class="error-icon">⚠️</text>
                    <text class="error-text">{{ qrcodeError }}</text>
                    <button class="retry-button" catchtap="retryGenerateQrcode">重试</button>
                </view>
                
                <!-- 二维码显示 -->
                <view wx:else class="qrcode-display">
                    <view class="qrcode-wrapper">
                        <canvas 
                            type="2d" 
                            id="qrcode-canvas" 
                            class="qrcode-canvas"
                        ></canvas>
                    </view>
                    
                    <view class="qrcode-tips">
                        <text class="tips-title">请使用微信扫码支付</text>
                        <text class="tips-desc">订单号：{{ qrcodeOrderNo }}</text>
                    </view>
                    
                    <view class="qrcode-actions">
                        <button class="action-button copy-button" catchtap="copyQrcodeLink">
                            复制链接
                        </button>
                    </view>
                </view>
            </view>
        </view>
    </view>
</view>