# æ¥å£å¯¹æ¥å®æ–½æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [å‡†å¤‡å·¥ä½œ](#å‡†å¤‡å·¥ä½œ)
2. [åˆ›å»ºAPIå°è£…å±‚](#åˆ›å»ºapiå°è£…å±‚)
3. [åˆ†é˜¶æ®µå®æ–½è®¡åˆ’](#åˆ†é˜¶æ®µå®æ–½è®¡åˆ’)
4. [æ¥å£å¯¹æ¥ç¤ºä¾‹](#æ¥å£å¯¹æ¥ç¤ºä¾‹)
5. [æµ‹è¯•éªŒè¯](#æµ‹è¯•éªŒè¯)

---

## å‡†å¤‡å·¥ä½œ

### 1. é…ç½®APIåŸºç¡€ä¿¡æ¯

åœ¨ `app.js` æˆ–é…ç½®æ–‡ä»¶ä¸­æ·»åŠ ï¼š

```javascript
// app.js
App({
  globalData: {
    apiBaseUrl: 'https://your-api-domain.com', // æ›¿æ¢ä¸ºå®é™…APIåœ°å€
    token: null,
    userInfo: null,
    openid: null
  }
})
```

### 2. éœ€è¦çš„ç¯å¢ƒå˜é‡

- APIæœåŠ¡å™¨åœ°å€
- å¾®ä¿¡å°ç¨‹åº AppID
- å¾®ä¿¡å°ç¨‹åº AppSecretï¼ˆåç«¯é…ç½®ï¼‰

---

## åˆ›å»ºAPIå°è£…å±‚

### æ­¥éª¤1: åˆ›å»º `utils/request.js` - ç»Ÿä¸€è¯·æ±‚å°è£…

```javascript
// utils/request.js
const app = getApp();

/**
 * ç»Ÿä¸€ç½‘ç»œè¯·æ±‚å°è£…
 * @param {Object} options è¯·æ±‚é…ç½®
 * @returns {Promise}
 */
function request(options) {
  return new Promise((resolve, reject) => {
    const { url, method = 'GET', data = {}, needAuth = true } = options;
    
    // æ„å»ºå®Œæ•´URL
    const fullUrl = `${app.globalData.apiBaseUrl}${url}`;
    
    // æ„å»ºè¯·æ±‚å¤´
    const header = {
      'Content-Type': 'application/json'
    };
    
    // å¦‚æœéœ€è¦è®¤è¯ï¼Œæ·»åŠ token
    if (needAuth && app.globalData.token) {
      header['Authorization'] = `Bearer ${app.globalData.token}`;
    }
    
    // æ˜¾ç¤ºåŠ è½½æç¤º
    wx.showLoading({
      title: 'åŠ è½½ä¸­...',
      mask: true
    });
    
    // å‘èµ·è¯·æ±‚
    wx.request({
      url: fullUrl,
      method: method,
      data: data,
      header: header,
      success: (res) => {
        wx.hideLoading();
        
        // ç»Ÿä¸€å¤„ç†å“åº”
        if (res.statusCode === 200) {
          if (res.data.success) {
            resolve(res.data);
          } else {
            // ä¸šåŠ¡é”™è¯¯
            wx.showToast({
              title: res.data.message || 'æ“ä½œå¤±è´¥',
              icon: 'none',
              duration: 2000
            });
            reject(res.data);
          }
        } else if (res.statusCode === 401) {
          // tokenè¿‡æœŸï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
          wx.showToast({
            title: 'ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•',
            icon: 'none',
            duration: 2000
          });
          
          // æ¸…é™¤token
          app.globalData.token = null;
          wx.removeStorageSync('token');
          
          // è·³è½¬åˆ°ç™»å½•é¡µ
          setTimeout(() => {
            wx.reLaunch({
              url: '/pages/login/login'
            });
          }, 2000);
          
          reject({ message: 'ç™»å½•å·²è¿‡æœŸ' });
        } else {
          // å…¶ä»–HTTPé”™è¯¯
          wx.showToast({
            title: `è¯·æ±‚å¤±è´¥ (${res.statusCode})`,
            icon: 'none',
            duration: 2000
          });
          reject(res);
        }
      },
      fail: (err) => {
        wx.hideLoading();
        
        // ç½‘ç»œé”™è¯¯
        wx.showToast({
          title: 'ç½‘ç»œè¿æ¥å¤±è´¥',
          icon: 'none',
          duration: 2000
        });
        
        reject(err);
      }
    });
  });
}

module.exports = {
  request
};
```

### æ­¥éª¤2: åˆ›å»º `utils/api.js` - APIæ¥å£å®šä¹‰

```javascript
// utils/api.js
const { request } = require('./request');

/**
 * APIæ¥å£å®šä¹‰
 */
const API = {
  
  // ==================== ç”¨æˆ·è®¤è¯ ====================
  
  /**
   * é€šè¿‡å¾®ä¿¡codeè·å–openid
   * @param {string} code å¾®ä¿¡ç™»å½•code
   */
  getOpenidByCode(code) {
    return request({
      url: '/api/getOpenidByCode',
      method: 'POST',
      data: { code },
      needAuth: false
    });
  },
  
  /**
   * é€šè¿‡openidç”Ÿæˆtoken
   * @param {string} openid ç”¨æˆ·openid
   */
  generateTokenByOpenid(openid) {
    return request({
      url: '/api/generateTokenByOpenid',
      method: 'POST',
      data: { openid },
      needAuth: false
    });
  },
  
  /**
   * åˆ›å»ºç”¨æˆ·å¹¶ç”Ÿæˆtoken
   * @param {Object} userData ç”¨æˆ·æ•°æ®
   */
  createUser(userData) {
    return request({
      url: '/api/createUser',
      method: 'POST',
      data: userData,
      needAuth: false
    });
  },
  
  /**
   * è·å–ç”¨æˆ·ä¿¡æ¯
   */
  getUserInfo() {
    return request({
      url: '/api/getUserInfo',
      method: 'GET',
      needAuth: true
    });
  },
  
  // ==================== è®¾å¤‡ç»‘å®š ====================
  
  /**
   * ç»‘å®šè®¾å¤‡
   * @param {string} deviceCode è®¾å¤‡ç 
   */
  bindDevice(deviceCode) {
    return request({
      url: '/api/bindDevice',
      method: 'POST',
      data: { deviceCode },
      needAuth: true
    });
  },
  
  /**
   * è·å–ç”¨æˆ·ç»‘å®šçš„è®¾å¤‡åˆ—è¡¨
   */
  getUserDevices() {
    return request({
      url: '/api/getUserDevices',
      method: 'GET',
      needAuth: true
    });
  },
  
  /**
   * è§£ç»‘è®¾å¤‡
   * @param {string} deviceCode è®¾å¤‡ç 
   */
  unbindDevice(deviceCode) {
    return request({
      url: '/api/unbindDevice',
      method: 'POST',
      data: { deviceCode },
      needAuth: true
    });
  },
  
  /**
   * æ ¹æ®è®¾å¤‡ç æŸ¥è¯¢å®¢æˆ·ä¿¡æ¯
   * @param {string} deviceCode è®¾å¤‡ç 
   */
  getCustomerByDeviceCode(deviceCode) {
    return request({
      url: `/api/getCustomerByDeviceCode/${deviceCode}`,
      method: 'GET',
      needAuth: true
    });
  },
  
  // ==================== å¥—é¤ç®¡ç† ====================
  
  /**
   * è·å–å¥—é¤åˆ—è¡¨
   * @param {Object} params æŸ¥è¯¢å‚æ•°
   */
  getPackagesList(params = {}) {
    return request({
      url: '/api/packages/getPackagesList',
      method: 'GET',
      data: params,
      needAuth: false
    });
  },
  
  /**
   * è·å–å¥—é¤è¯¦æƒ…
   * @param {string} id å¥—é¤ID
   */
  getPackageDetail(id) {
    return request({
      url: `/api/packages/getPackageDetail/${id}`,
      method: 'GET',
      needAuth: false
    });
  },
  
  /**
   * åˆ›å»ºè®¢å•
   * @param {Object} orderData è®¢å•æ•°æ®
   */
  createOrder(orderData) {
    return request({
      url: '/api/orders',
      method: 'POST',
      data: orderData,
      needAuth: true
    });
  },
  
  // ==================== è´¦å•ç®¡ç† ====================
  
  /**
   * è·å–è´¦å•åˆ—è¡¨
   * @param {Object} params æŸ¥è¯¢å‚æ•°
   */
  getCustomerBillList(params = {}) {
    return request({
      url: '/api/customerBill/getCustomerBillList',
      method: 'GET',
      data: params,
      needAuth: true
    });
  },
  
  /**
   * è·å–è´¦å•è¯¦æƒ…
   * @param {string} id è´¦å•ID
   */
  getCustomerBillDetail(id) {
    return request({
      url: `/api/customerBill/getCustomerBillDetail/${id}`,
      method: 'GET',
      needAuth: true
    });
  },
  
  // ==================== æ”¯ä»˜åŠŸèƒ½ ====================
  
  /**
   * åˆ›å»ºå°ç¨‹åºæ”¯ä»˜è®¢å•
   * @param {Object} paymentData æ”¯ä»˜æ•°æ®
   */
  createMiniprogramPayment(paymentData) {
    return request({
      url: '/api/miniprogram/pay',
      method: 'POST',
      data: paymentData,
      needAuth: true
    });
  },
  
  /**
   * æŸ¥è¯¢æ”¯ä»˜çŠ¶æ€ï¼ˆå¢å¼ºç‰ˆï¼‰
   * @param {Object} params æŸ¥è¯¢å‚æ•°
   */
  getPaymentStatus(params) {
    return request({
      url: '/api/payments/status/enhanced',
      method: 'GET',
      data: params,
      needAuth: true
    });
  },
  
  /**
   * å–æ¶ˆæ”¯ä»˜
   * @param {Object} data å–æ¶ˆæ•°æ®
   */
  cancelPayment(data) {
    return request({
      url: '/api/payments/cancel',
      method: 'POST',
      data: data,
      needAuth: true
    });
  },
  
  // ==================== å¼€ç¥¨ç®¡ç† ====================
  
  /**
   * è·å–å¯å¼€ç¥¨è®¢å•åˆ—è¡¨
   * @param {Object} params æŸ¥è¯¢å‚æ•°
   */
  getInvoiceList(params = {}) {
    return request({
      url: '/api/v1/invoices/getInvoiceList',
      method: 'GET',
      data: params,
      needAuth: true
    });
  },
  
  /**
   * åˆ›å»ºæˆ–æ›´æ–°å¼€ç¥¨ä¿¡æ¯
   * @param {Object} invoiceInfo å¼€ç¥¨ä¿¡æ¯
   */
  createOrUpdateInvoiceInfo(invoiceInfo) {
    return request({
      url: '/api/v1/invoices/invoice-info/createOrUpdateInvoiceInfo',
      method: 'POST',
      data: invoiceInfo,
      needAuth: true
    });
  },
  
  /**
   * ä¸ºè®¢å•åˆ›å»ºå‘ç¥¨
   * @param {string} orderId è®¢å•ID
   * @param {Object} invoiceData å‘ç¥¨æ•°æ®
   */
  createInvoiceForOrder(orderId, invoiceData) {
    return request({
      url: `/api/v1/invoices/create/${orderId}`,
      method: 'POST',
      data: invoiceData,
      needAuth: true
    });
  },
  
  /**
   * æ ¹æ®è®¾å¤‡å·è·å–å¼€ç¥¨ä¿¡æ¯
   * @param {string} deviceNo è®¾å¤‡å·
   */
  getInvoiceInfoByDevice(deviceNo) {
    return request({
      url: `/api/v1/invoices/invoice-info/device/${deviceNo}`,
      method: 'GET',
      needAuth: true
    });
  },
  
  // ==================== è®¢å•ç®¡ç† ====================
  
  /**
   * æŸ¥è¯¢è®¢å•åˆ—è¡¨
   * @param {Object} params æŸ¥è¯¢å‚æ•°
   */
  getOrdersList(params = {}) {
    return request({
      url: '/api/orders',
      method: 'GET',
      data: params,
      needAuth: true
    });
  },
  
  /**
   * è·å–è®¢å•è¯¦æƒ…
   * @param {string} id è®¢å•ID
   */
  getOrderDetail(id) {
    return request({
      url: `/api/orders/${id}`,
      method: 'GET',
      needAuth: true
    });
  },
  
  // ==================== å·¥å…·ç±»æ¥å£ ====================
  
  /**
   * è·å–çœä»½åˆ—è¡¨
   */
  getProvinces() {
    return request({
      url: '/api/v1/tools/provinces',
      method: 'GET',
      needAuth: false
    });
  },
  
  /**
   * è·å–åŸå¸‚åˆ—è¡¨
   * @param {string} provinceId çœä»½ID
   */
  getCities(provinceId) {
    return request({
      url: `/api/v1/tools/provinces/${provinceId}/cities`,
      method: 'GET',
      needAuth: false
    });
  },
  
  /**
   * è·å–Banneråˆ—è¡¨
   */
  getBannersList() {
    return request({
      url: '/api/v1/tools/getBannersList',
      method: 'GET',
      needAuth: false
    });
  },
  
  /**
   * è·å–æ¨æ–‡åˆ—è¡¨
   */
  getArticlesList() {
    return request({
      url: '/api/v1/tools/getArticlesList',
      method: 'GET',
      needAuth: false
    });
  },
  
  /**
   * è·å–æ¨æ–‡è¯¦æƒ…
   * @param {string} id æ¨æ–‡ID
   */
  getArticleDetail(id) {
    return request({
      url: `/api/v1/tools/getArticleDetail/${id}`,
      method: 'GET',
      needAuth: false
    });
  }
};

module.exports = API;
```

---

## åˆ†é˜¶æ®µå®æ–½è®¡åˆ’

### ç¬¬ä¸€é˜¶æ®µï¼šæ ¸å¿ƒåŠŸèƒ½ï¼ˆ1-2å‘¨ï¼‰

**ç›®æ ‡**: å®ç°ç”¨æˆ·ç™»å½•ã€è®¾å¤‡ç»‘å®šã€å¥—é¤è®¢è´­åŸºæœ¬æµç¨‹

#### ä»»åŠ¡æ¸…å•ï¼š
- [ ] 1. åˆ›å»º `utils/request.js` å’Œ `utils/api.js`
- [ ] 2. é…ç½®APIåŸºç¡€åœ°å€
- [ ] 3. å®ç°ç™»å½•é¡µé¢æ¥å£å¯¹æ¥
- [ ] 4. å®ç°è®¾å¤‡ç»‘å®šé¡µé¢æ¥å£å¯¹æ¥
- [ ] 5. å®ç°å¥—é¤è®¢è´­é¡µé¢æ¥å£å¯¹æ¥
- [ ] 6. æµ‹è¯•å®Œæ•´æµç¨‹

### ç¬¬äºŒé˜¶æ®µï¼šæ”¯ä»˜å’Œè´¦å•ï¼ˆ1å‘¨ï¼‰

**ç›®æ ‡**: å®ç°æ”¯ä»˜åŠŸèƒ½å’Œè´¦å•æŸ¥è¯¢

#### ä»»åŠ¡æ¸…å•ï¼š
- [ ] 1. å®ç°é¢„å……å€¼é¡µé¢æ¥å£å¯¹æ¥
- [ ] 2. å®ç°æ”¯ä»˜æµç¨‹ï¼ˆåˆ›å»ºè®¢å•ã€æŸ¥è¯¢çŠ¶æ€ï¼‰
- [ ] 3. å®ç°è´¦å•åˆ—è¡¨é¡µé¢æ¥å£å¯¹æ¥
- [ ] 4. æµ‹è¯•æ”¯ä»˜æµç¨‹

### ç¬¬ä¸‰é˜¶æ®µï¼šå¼€ç¥¨å’Œè®¢å•ï¼ˆ1å‘¨ï¼‰

**ç›®æ ‡**: å®ç°å¼€ç¥¨åŠŸèƒ½å’Œè®¢å•ç®¡ç†

#### ä»»åŠ¡æ¸…å•ï¼š
- [ ] 1. å®ç°å¼€ç¥¨é¡µé¢æ¥å£å¯¹æ¥
- [ ] 2. å®ç°è®¢å•åˆ—è¡¨å’Œè¯¦æƒ…æŸ¥è¯¢
- [ ] 3. æµ‹è¯•å¼€ç¥¨æµç¨‹

### ç¬¬å››é˜¶æ®µï¼šè¾…åŠ©åŠŸèƒ½ï¼ˆ1å‘¨ï¼‰

**ç›®æ ‡**: å®ç°å·¥å…·ç±»æ¥å£å’Œå†…å®¹å±•ç¤º

#### ä»»åŠ¡æ¸…å•ï¼š
- [ ] 1. å®ç°çœå¸‚æ•°æ®æ¥å£
- [ ] 2. å®ç°Bannerå’Œæ¨æ–‡å±•ç¤º
- [ ] 3. ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ
- [ ] 4. å…¨é¢æµ‹è¯•

---

## æ¥å£å¯¹æ¥ç¤ºä¾‹

### ç¤ºä¾‹1: ç™»å½•é¡µé¢æ”¹é€ 

#### åŸä»£ç  (pages/login/login.js)

```javascript
// å¾®ä¿¡ç™»å½•
onWeChatLogin() {
  if (!this.data.agreed) {
    message.error('è¯·å…ˆé˜…è¯»å¹¶åŒæ„ç”¨æˆ·æœåŠ¡åè®®');
    return;
  }

  console.log("Starting WeChat Login...");
  this.setData({ loading: true });

  // æ¨¡æ‹Ÿå¾®ä¿¡æˆæƒè¿‡ç¨‹
  setTimeout(() => {
    this.setData({ loading: false });
    message.success("æˆæƒæˆåŠŸï¼å³å°†è·³è½¬...");
    setTimeout(() => {
      navigation.switchTab('/pages/home/home');
    }, 800);
  }, 1500);
}
```

#### æ”¹é€ åä»£ç 

```javascript
const API = require('../../utils/api');
const app = getApp();

// å¾®ä¿¡ç™»å½•
onWeChatLogin() {
  if (!this.data.agreed) {
    message.error('è¯·å…ˆé˜…è¯»å¹¶åŒæ„ç”¨æˆ·æœåŠ¡åè®®');
    return;
  }

  console.log("Starting WeChat Login...");
  this.setData({ loading: true });

  // 1. è°ƒç”¨å¾®ä¿¡ç™»å½•è·å–code
  wx.login({
    success: async (res) => {
      if (res.code) {
        try {
          // 2. é€šè¿‡codeè·å–openid
          const openidResult = await API.getOpenidByCode(res.code);
          const openid = openidResult.data.openid;

          // ä¿å­˜openid
          app.globalData.openid = openid;
          wx.setStorageSync('openid', openid);

          // 3. å°è¯•ç”Ÿæˆtokenï¼ˆå¦‚æœç”¨æˆ·å·²å­˜åœ¨ï¼‰
          try {
            const tokenResult = await API.generateTokenByOpenid(openid);
            const token = tokenResult.data.token;

            // ä¿å­˜token
            app.globalData.token = token;
            wx.setStorageSync('token', token);

            // 4. è·å–ç”¨æˆ·ä¿¡æ¯
            const userInfoResult = await API.getUserInfo();
            app.globalData.userInfo = userInfoResult.data;

            this.setData({ loading: false });
            message.success("ç™»å½•æˆåŠŸï¼");

            // è·³è½¬åˆ°é¦–é¡µ
            setTimeout(() => {
              navigation.switchTab('/pages/home/home');
            }, 800);

          } catch (tokenError) {
            // ç”¨æˆ·ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°ç”¨æˆ·
            const createUserResult = await API.createUser({
              openid: openid,
              nickname: 'å¾®ä¿¡ç”¨æˆ·',
              avatar: ''
            });

            const token = createUserResult.data.token;
            app.globalData.token = token;
            wx.setStorageSync('token', token);

            this.setData({ loading: false });
            message.success("æ³¨å†ŒæˆåŠŸï¼");

            // è·³è½¬åˆ°è®¾å¤‡ç»‘å®šé¡µé¢
            setTimeout(() => {
              navigation.navigateTo('/pages/bind-device-code/bind-device-code');
            }, 800);
          }

        } catch (error) {
          console.error('ç™»å½•å¤±è´¥:', error);
          this.setData({ loading: false });
          message.error('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
        }
      } else {
        this.setData({ loading: false });
        message.error('è·å–å¾®ä¿¡æˆæƒå¤±è´¥');
      }
    },
    fail: () => {
      this.setData({ loading: false });
      message.error('å¾®ä¿¡ç™»å½•å¤±è´¥');
    }
  });
}
```

---

### ç¤ºä¾‹2: è®¾å¤‡ç»‘å®šé¡µé¢æ”¹é€ 

#### åŸä»£ç  (pages/bind-device-code/bind-device-code.js)

```javascript
// æ‰‹åŠ¨æäº¤ç»‘å®š
onManualSubmit() {
  const { deviceCode } = this.data;

  if (deviceCode.length < 16) {
    message.error('è¯·è¾“å…¥16ä½è®¾å¤‡ç»‘å®šç ');
    return;
  }

  this.setData({ isLoading: true });

  console.log('Binding with code:', deviceCode);

  // æ¨¡æ‹Ÿç½‘ç»œè¯·æ±‚
  setTimeout(() => {
    this.setData({ isLoading: false });
    message.success('è®¾å¤‡ç»‘å®šæˆåŠŸï¼');

    // ä¿å­˜ç»‘å®šçŠ¶æ€
    wx.setStorageSync('deviceBound', true);
    wx.setStorageSync('deviceCode', deviceCode);

    // æ¸…ç©ºè¾“å…¥æ¡†
    this.setData({ deviceCode: '' });

    setTimeout(() => {
      navigation.switchTab('/pages/home/home');
    }, 800);
  }, 1500);
}
```

#### æ”¹é€ åä»£ç 

```javascript
const API = require('../../utils/api');

// æ‰‹åŠ¨æäº¤ç»‘å®š
async onManualSubmit() {
  const { deviceCode } = this.data;

  if (deviceCode.length < 16) {
    message.error('è¯·è¾“å…¥16ä½è®¾å¤‡ç»‘å®šç ');
    return;
  }

  this.setData({ isLoading: true });

  try {
    // 1. å…ˆéªŒè¯è®¾å¤‡ç æ˜¯å¦æœ‰æ•ˆ
    const customerInfo = await API.getCustomerByDeviceCode(deviceCode);

    if (!customerInfo.data) {
      this.setData({ isLoading: false });
      message.error('è®¾å¤‡ç æ— æ•ˆæˆ–ä¸å­˜åœ¨');
      return;
    }

    // 2. ç»‘å®šè®¾å¤‡åˆ°ç”¨æˆ·
    await API.bindDevice(deviceCode);

    this.setData({ isLoading: false });
    message.success('è®¾å¤‡ç»‘å®šæˆåŠŸï¼');

    // ä¿å­˜ç»‘å®šçŠ¶æ€
    wx.setStorageSync('deviceBound', true);
    wx.setStorageSync('deviceCode', deviceCode);

    // æ¸…ç©ºè¾“å…¥æ¡†
    this.setData({ deviceCode: '' });

    setTimeout(() => {
      navigation.switchTab('/pages/home/home');
    }, 800);

  } catch (error) {
    console.error('ç»‘å®šå¤±è´¥:', error);
    this.setData({ isLoading: false });
    message.error(error.message || 'è®¾å¤‡ç»‘å®šå¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}
```

---

### ç¤ºä¾‹3: å¥—é¤è®¢è´­é¡µé¢æ”¹é€ 

#### åœ¨é¡µé¢åŠ è½½æ—¶è·å–å¥—é¤åˆ—è¡¨

```javascript
const API = require('../../utils/api');

Page({
  data: {
    packages: [],
    selectedPackage: null,
    loading: true
  },

  async onLoad() {
    console.log('å¥—é¤è®¢è´­é¡µé¢åŠ è½½');
    await this.loadPackages();
  },

  // åŠ è½½å¥—é¤åˆ—è¡¨
  async loadPackages() {
    try {
      this.setData({ loading: true });

      const result = await API.getPackagesList({
        status: 'active', // åªè·å–æ¿€æ´»çŠ¶æ€çš„å¥—é¤
        page: 1,
        pageSize: 20
      });

      // è½¬æ¢æ•°æ®æ ¼å¼ä»¥é€‚é…ç°æœ‰UI
      const packages = result.data.packages.map(pkg => ({
        id: pkg.id,
        name: pkg.name,
        speed: pkg.speed || '100', // æ ¹æ®å®é™…APIè¿”å›å­—æ®µè°ƒæ•´
        price: pkg.price,
        isPopular: pkg.isPopular || false,
        features: pkg.features || []
      }));

      this.setData({
        packages: packages,
        loading: false
      });

    } catch (error) {
      console.error('åŠ è½½å¥—é¤å¤±è´¥:', error);
      this.setData({ loading: false });
      message.error('åŠ è½½å¥—é¤å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  },

  // å¤„ç†è®¢è´­
  async processOrder() {
    const selectedPackage = this.data.packages.find(
      pkg => pkg.id === this.data.selectedPackage
    );

    if (!selectedPackage) {
      message.error('è¯·é€‰æ‹©å¥—é¤');
      return;
    }

    wx.showLoading({ title: 'æ­£åœ¨å¤„ç†è®¢å•...' });

    try {
      // åˆ›å»ºè®¢å•
      const result = await API.createOrder({
        packageId: selectedPackage.id,
        packageName: selectedPackage.name,
        amount: selectedPackage.price,
        remark: 'å°ç¨‹åºè®¢è´­'
      });

      wx.hideLoading();
      message.success('è®¢è´­æˆåŠŸï¼');

      setTimeout(() => {
        wx.showModal({
          title: 'è®¢è´­å®Œæˆ',
          content: `${selectedPackage.name} è®¢è´­æˆåŠŸï¼\nè®¢å•å·ï¼š${result.data.orderId}\næœˆè´¹ï¼šÂ¥${selectedPackage.price}\næˆ‘ä»¬å°†å°½å¿«ä¸ºæ‚¨å®‰æ’å®‰è£…ã€‚`,
          showCancel: false,
          confirmText: 'çŸ¥é“äº†',
          success: () => {
            navigation.switchTab('/pages/home/home');
          }
        });
      }, 1000);

    } catch (error) {
      wx.hideLoading();
      console.error('è®¢è´­å¤±è´¥:', error);
      message.error(error.message || 'è®¢è´­å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }
});
```

---

### ç¤ºä¾‹4: è´¦å•åˆ—è¡¨é¡µé¢æ”¹é€ 

```javascript
const API = require('../../utils/api');

Page({
  data: {
    bills: [],
    loading: true
  },

  async onLoad() {
    console.log('æˆ‘çš„è´¦å•é¡µé¢åŠ è½½');
    await this.loadBills();
  },

  async onShow() {
    console.log('æˆ‘çš„è´¦å•é¡µé¢æ˜¾ç¤º');
    await this.loadBills();
  },

  // åŠ è½½è´¦å•åˆ—è¡¨
  async loadBills() {
    try {
      this.setData({ loading: true });

      const result = await API.getCustomerBillList({
        page: 1,
        pageSize: 20,
        status: '' // è·å–æ‰€æœ‰çŠ¶æ€çš„è´¦å•
      });

      // è½¬æ¢æ•°æ®æ ¼å¼
      const bills = result.data.bills.map(bill => ({
        id: bill.id,
        title: bill.title || 'å®½å¸¦æœˆè´¹',
        date: bill.createTime,
        period: bill.period || 'æœˆåº¦è´¦å•',
        amount: `Â¥${bill.amount.toFixed(2)}`,
        status: bill.status === 'paid' ? 'paid' : 'pending',
        statusText: bill.status === 'paid' ? 'å·²ç¼´è´¹' : 'å¾…ç¼´è´¹'
      }));

      this.setData({
        bills: bills,
        loading: false
      });

    } catch (error) {
      console.error('åŠ è½½è´¦å•å¤±è´¥:', error);
      this.setData({ loading: false });
      message.error('åŠ è½½è´¦å•å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  },

  // æŸ¥çœ‹è´¦å•è¯¦æƒ…
  async viewBillDetail(e) {
    const billId = e.currentTarget.dataset.id;

    try {
      wx.showLoading({ title: 'åŠ è½½ä¸­...' });

      const result = await API.getCustomerBillDetail(billId);
      const bill = result.data;

      wx.hideLoading();

      wx.showModal({
        title: 'è´¦å•è¯¦æƒ…',
        content: `è´¦å•ç±»å‹ï¼š${bill.title}\nè´¦å•æ—¥æœŸï¼š${bill.date}\nè®¡è´¹å‘¨æœŸï¼š${bill.period}\nè´¦å•é‡‘é¢ï¼šÂ¥${bill.amount}\nç¼´è´¹çŠ¶æ€ï¼š${bill.statusText}`,
        showCancel: false,
        confirmText: 'çŸ¥é“äº†'
      });

    } catch (error) {
      wx.hideLoading();
      console.error('è·å–è´¦å•è¯¦æƒ…å¤±è´¥:', error);
      message.error('è·å–è´¦å•è¯¦æƒ…å¤±è´¥');
    }
  }
});
```

---

## æµ‹è¯•éªŒè¯

### æµ‹è¯•æ¸…å•

#### ç¬¬ä¸€é˜¶æ®µæµ‹è¯•
- [ ] ç”¨æˆ·ç™»å½•æµç¨‹
  - [ ] æ–°ç”¨æˆ·æ³¨å†Œ
  - [ ] è€ç”¨æˆ·ç™»å½•
  - [ ] Tokenä¿å­˜å’Œä½¿ç”¨
- [ ] è®¾å¤‡ç»‘å®š
  - [ ] æœ‰æ•ˆè®¾å¤‡ç ç»‘å®š
  - [ ] æ— æ•ˆè®¾å¤‡ç æç¤º
  - [ ] ç»‘å®šçŠ¶æ€ä¿å­˜
- [ ] å¥—é¤è®¢è´­
  - [ ] å¥—é¤åˆ—è¡¨åŠ è½½
  - [ ] å¥—é¤é€‰æ‹©
  - [ ] è®¢å•åˆ›å»º

#### ç¬¬äºŒé˜¶æ®µæµ‹è¯•
- [ ] æ”¯ä»˜åŠŸèƒ½
  - [ ] åˆ›å»ºæ”¯ä»˜è®¢å•
  - [ ] æ”¯ä»˜çŠ¶æ€æŸ¥è¯¢
  - [ ] æ”¯ä»˜æˆåŠŸå¤„ç†
  - [ ] æ”¯ä»˜å¤±è´¥å¤„ç†
- [ ] è´¦å•æŸ¥è¯¢
  - [ ] è´¦å•åˆ—è¡¨åŠ è½½
  - [ ] è´¦å•è¯¦æƒ…æŸ¥çœ‹

#### ç¬¬ä¸‰é˜¶æ®µæµ‹è¯•
- [ ] å¼€ç¥¨åŠŸèƒ½
  - [ ] å¯å¼€ç¥¨è®¢å•åˆ—è¡¨
  - [ ] å¼€ç¥¨ä¿¡æ¯å¡«å†™
  - [ ] å‘ç¥¨åˆ›å»º
- [ ] è®¢å•ç®¡ç†
  - [ ] è®¢å•åˆ—è¡¨æŸ¥è¯¢
  - [ ] è®¢å•è¯¦æƒ…æŸ¥çœ‹

#### ç¬¬å››é˜¶æ®µæµ‹è¯•
- [ ] å·¥å…·ç±»åŠŸèƒ½
  - [ ] çœå¸‚æ•°æ®åŠ è½½
  - [ ] Bannerå±•ç¤º
  - [ ] æ¨æ–‡åˆ—è¡¨å’Œè¯¦æƒ…
- [ ] å…¨æµç¨‹æµ‹è¯•
  - [ ] å®Œæ•´ä¸šåŠ¡æµç¨‹æµ‹è¯•
  - [ ] å¼‚å¸¸æƒ…å†µå¤„ç†
  - [ ] æ€§èƒ½ä¼˜åŒ–

---

## å¸¸è§é—®é¢˜å¤„ç†

### 1. Tokenè¿‡æœŸå¤„ç†

å·²åœ¨ `utils/request.js` ä¸­ç»Ÿä¸€å¤„ç†ï¼Œå½“è¿”å›401æ—¶è‡ªåŠ¨è·³è½¬ç™»å½•é¡µã€‚

### 2. ç½‘ç»œé”™è¯¯å¤„ç†

å·²åœ¨ `utils/request.js` ä¸­ç»Ÿä¸€å¤„ç†ï¼Œæ˜¾ç¤ºå‹å¥½æç¤ºã€‚

### 3. æ•°æ®ç¼“å­˜ç­–ç•¥

å»ºè®®ç¼“å­˜çš„æ•°æ®ï¼š
- å¥—é¤åˆ—è¡¨ï¼ˆ1å°æ—¶ï¼‰
- çœå¸‚æ•°æ®ï¼ˆæ°¸ä¹…ï¼‰
- Banneråˆ—è¡¨ï¼ˆ30åˆ†é’Ÿï¼‰
- ç”¨æˆ·ä¿¡æ¯ï¼ˆç™»å½•æœŸé—´ï¼‰

### 4. å¹¶å‘è¯·æ±‚å¤„ç†

å¯¹äºéœ€è¦å¤šä¸ªæ¥å£æ•°æ®çš„é¡µé¢ï¼Œä½¿ç”¨ `Promise.all()` å¹¶å‘è¯·æ±‚ï¼š

```javascript
async onLoad() {
  try {
    const [packages, banners, articles] = await Promise.all([
      API.getPackagesList(),
      API.getBannersList(),
      API.getArticlesList()
    ]);

    this.setData({
      packages: packages.data.packages,
      banners: banners.data.banners,
      articles: articles.data.articles
    });
  } catch (error) {
    console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
  }
}
```

---

## ä¸‹ä¸€æ­¥

1. âœ… æŒ‰ç…§æœ¬æŒ‡å—åˆ›å»º `utils/request.js` å’Œ `utils/api.js`
2. âœ… é…ç½®APIåŸºç¡€åœ°å€
3. âœ… æŒ‰ç…§ç¤ºä¾‹æ”¹é€ å„ä¸ªé¡µé¢
4. âœ… è¿›è¡Œæµ‹è¯•éªŒè¯
5. âœ… ä¼˜åŒ–ç”¨æˆ·ä½“éªŒ

**ç¥ä½ å¯¹æ¥é¡ºåˆ©ï¼** ğŸ‰


